<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIStoryCraft</title>
    <!-- Supabase Configuration -->
    <meta name="supabase-url" content="<%= process.env.SUPABASE_URL %>">
    <meta name="supabase-anon-key" content="<%= process.env.SUPABASE_ANON_KEY %>">
    <!-- Initialize environment variables from meta tags -->
    <script>
        window.ENV = window.ENV || {};
        document.addEventListener('DOMContentLoaded', function() {
            const supabaseUrl = document.querySelector('meta[name="supabase-url"]')?.content;
            const supabaseAnonKey = document.querySelector('meta[name="supabase-anon-key"]')?.content;
            if (supabaseUrl) window.ENV.SUPABASE_URL = supabaseUrl;
            if (supabaseAnonKey) window.ENV.SUPABASE_ANON_KEY = supabaseAnonKey; 
            console.log('Environment initialized from meta tags:', !!window.ENV.SUPABASE_URL, !!window.ENV.SUPABASE_ANON_KEY);
        });
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4B5EAA',
                        primaryLight: '#E6E9F0',
                        secondary: '#6B7280',
                        accent: '#F472B6',
                        background: '#F9FAFB',
                        textPrimary: '#1F2937',
                        textSecondary: '#9CA3AF',
                        success: '#34D399',
                        error: '#EF4444',
                        warning: '#FBBF24',
                    }
                }
            }
        }
    </script>
    <!-- Custom Styles -->
    <style>
        :root {
            --primary: #4B5EAA;
            --primary-light: #E6E9F0;
            --secondary: #6B7280;
            --accent: #F472B6;
            --background: #F9FAFB;
            --text-primary: #1F2937;
            --text-secondary: #9CA3AF;
            --success: #34D399;
            --error: #EF4444;
            --warning: #FBBF24;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }

        .editor-content {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
        }

        .sidebar {
            width: 250px;
            background-color: var(--primary-light);
            border-right: 1px solid rgba(107, 114, 128, 0.1);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.03);
        }

        .chapter-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .chapter-item:hover {
            background-color: white;
            border-left: 3px solid var(--primary);
            transform: translateX(2px);
        }

        .chapter-item.active {
            background-color: white;
            border-left: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(75, 94, 170, 0.2);
        }

        .btn-primary:hover {
            background-color: #3F50A0;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(75, 94, 170, 0.25);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
            box-shadow: 0 2px 4px rgba(52, 211, 153, 0.2);
        }

        .btn-success:hover {
            background-color: #2bbb89;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(52, 211, 153, 0.25);
        }

        .btn-error {
            background-color: var(--error);
            color: white;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .btn-error:hover {
            background-color: #dc3030;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .modal {
            transition: opacity 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        input[type=range] {
            -webkit-appearance: none;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            background-image: linear-gradient(to right, var(--primary), var(--accent));
            background-size: 50% 100%;
            background-repeat: no-repeat;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7' /%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Character Tree Visualization */
        .character-tree {
            position: relative;
            min-height: 300px;
            padding: 1rem;
            overflow: visible;
        }

        .character-node {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-light);
            border: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .character-node:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(75, 94, 170, 0.3);
            z-index: 20;
        }

        .character-node.protagonist {
            background-color: var(--primary);
            color: white;
        }

        .character-node.antagonist {
            background-color: var(--error);
            border-color: #dc3030;
            color: white;
        }

        .character-node.supporting {
            background-color: var(--accent);
            border-color: #d161a1;
            color: white;
        }

        .character-node.minor {
            background-color: var(--secondary);
            border-color: #5a6069;
            color: white;
        }

        .character-link {
            position: absolute;
            height: 2px;
            background-color: var(--secondary);
            transform-origin: 0 0;
            z-index: 5;
            opacity: 0.6;
            pointer-events: none;
        }

        .character-tooltip {
            position: absolute;
            width: 220px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            transform: translateX(-50%) translateY(-100%) translateY(-10px);
        }

        .character-node:hover .character-tooltip {
            opacity: 1;
        }

        /* AI Assistant Styles */
        .ai-mode-btn {
            transition: all 0.2s ease;
            flex: 1;
            min-width: 120px;
            padding: 0.5rem 2rem;
        }

        .ai-mode-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(75, 94, 170, 0.2);
        }

        .ai-mode-btn:not(.active):hover {
            background-color: var(--primaryLight);
            transform: translateY(-1px);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        /* Chat Message Styles */
        .chat-message {
            max-width: 85%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.95rem;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s ease forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            margin-left: auto;
            background-color: white;
            border: 1px solid var(--primary-light);
            border-radius: 1rem 1rem 0 1rem;
            color: var(--text-primary);
        }

        .chat-message.ai {
            margin-right: auto;
            background-color: var(--primary-light);
            border-radius: 1rem 1rem 1rem 0;
            color: var(--text-primary);
        }

        .chat-message p {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Chat container styles */
        #chatHistory {
            padding: 1rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            min-height: 300px;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) transparent;
        }

        #chatHistory::-webkit-scrollbar {
            width: 6px;
        }

        #chatHistory::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        #chatHistory::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        #chatHistory::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }

        /* Chat input styles */
        #chatInput {
            min-height: 2.5rem;
            max-height: 8rem;
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
            padding: 0.75rem;
            padding-right: 3rem;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #chatInput::-webkit-scrollbar {
            width: 6px;
        }

        #chatInput::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatInput::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #aiAssistPanel {
                width: 100%;
                max-width: 100%;
            }
        }

        /* AI Assistant Panel Styles */
        #aiAssistPanel {
            min-width: 400px;
            max-width: 600px;
            width: 35vw;
            height: 100vh;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #aiInput {
            font-size: 1rem;
            line-height: 1.6;
            overflow-y: auto;
        }

        #aiInput::-webkit-scrollbar {
            width: 6px;
        }

        #aiInput::-webkit-scrollbar-track {
            background: transparent;
        }

        #aiInput::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
        }

        #aiOutput {
            min-height: 200px;
            max-height: 400px;
            font-size: 1rem;
            line-height: 1.6;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: #F9FAFB;
            border-radius: 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) transparent;
        }

        #aiOutput::-webkit-scrollbar {
            width: 6px;
        }

        #aiOutput::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        #aiOutput::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        #aiOutput::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }

        @media (max-width: 768px) {
            #aiAssistPanel {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-gray-100">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-semibold text-primary">AIStoryCraft</h1>
                <div class="flex items-center space-x-4">
                    <img id="userAvatar" class="w-8 h-8 rounded-full" src="" alt="User avatar">
                    <span id="userDisplayName" class="text-sm text-gray-600">Loading...</span>
                    <button id="signOutBtn" class="text-sm text-gray-500 hover:text-primary">
                        <i class="fas fa-sign-out-alt mr-1"></i>Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex">
        <!-- Sidebar -->
        <aside class="sidebar bg-white border-r border-gray-100 p-4 flex flex-col">
            <!-- Project Info -->
            <div class="bg-white rounded-lg p-3 shadow-sm-custom mb-4">
                <h2 class="text-lg font-semibold mb-1">My Novel</h2>
                <div class="text-xs text-textSecondary">
                    <span>Last edited: Never</span>
                </div>
            </div>

            <!-- Progress -->
            <div class="bg-white rounded-lg p-3 shadow-sm-custom mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium">Word Count</h3>
                    <span class="text-xl font-semibold">0</span>
                </div>
                <div class="relative">
                    <svg class="w-full" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#E6E9F0" stroke-width="10"/>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#4B5EAA" stroke-width="10" stroke-dasharray="0 100"/>
                    </svg>
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                        <span class="text-xs text-textSecondary">0%</span>
                    </div>
                </div>
            </div>

            <!-- Chapters -->
            <div class="mb-3">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-medium">Chapters</h3>
                    <span class="text-xs text-textSecondary">0 chapters</span>
                </div>
            </div>
            <div class="space-y-1 mb-4">
                <!-- Chapters will be added here -->
            </div>
            <button class="btn btn-primary w-full">
                <i class="fas fa-plus text-sm mr-1"></i>
                Add Chapter
            </button>

            <!-- Context -->
            <div class="mt-6 mb-3">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-medium">Context</h3>
                    <span class="text-xs text-textSecondary">0 items</span>
                </div>
            </div>
            <div class="space-y-1 mb-4">
                <!-- Context items will be added here -->
            </div>
            <button id="manageContextBtn" class="btn btn-primary w-full">
                <i class="fas fa-cog text-sm mr-1"></i>
                Manage Context
            </button>
        </aside>

        <!-- Editor Area -->
        <main class="flex-1 flex flex-col">
            <!-- Toolbar -->
            <div class="bg-white border-b border-gray-100 p-4">
                <div class="flex items-center space-x-2">
                    <!-- Text formatting buttons -->
                    <button class="toolbar-btn" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="toolbar-btn" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="toolbar-btn" title="Underline">
                        <i class="fas fa-underline"></i>
                    </button>
                    <div class="w-px h-6 bg-gray-200 mx-2"></div>
                    <!-- Alignment buttons -->
                    <button class="toolbar-btn" title="Align Left">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button class="toolbar-btn" title="Align Center">
                        <i class="fas fa-align-center"></i>
                    </button>
                    <button class="toolbar-btn" title="Align Right">
                        <i class="fas fa-align-right"></i>
                    </button>
                    <div class="w-px h-6 bg-gray-200 mx-2"></div>
                    <!-- AI Assistant button -->
                    <button class="toolbar-btn text-primary" title="AI Assistant">
                        <i class="fas fa-robot"></i>
                    </button>
                </div>
            </div>

            <!-- Editor Content -->
            <div class="flex-1 overflow-auto p-8">
                <div class="editor-content max-w-3xl mx-auto" contenteditable="true">
                    <h1 class="text-3xl font-bold mb-6">Chapter 1: Introduction</h1>
                    <p class="mb-4">Start writing your story here...</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { auth, projects, chapters, characters, getClient } from './lib/supabase.js';
        
        // Global variables to store current project and user information
        let currentProject = null;
        let currentChapter = null;
        
        // Initialize with a default user avatar
        const userAvatar = document.querySelector('#userAvatar');
        if (userAvatar) {
            userAvatar.src = `https://ui-avatars.com/api/?name=Guest&background=4B5EAA&color=fff`;
        }

        // Handle sign out using Supabase auth
        const handleSignOut = async () => {
            try {
                await auth.signOut();
                window.location.href = '/auth/auth.html';
            } catch (error) {
                console.error('Error signing out:', error);
                window.location.reload();
            }
        };

        // Add sign out handler and initialize auth state
        document.addEventListener('DOMContentLoaded', async () => {
            const signOutBtn = document.querySelector('#signOutBtn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', handleSignOut);
            }
            
            // Subscribe to auth state changes
            const { data: { subscription } } = await auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT') {
                    window.location.href = '/auth/auth.html';
                } else if (event === 'SIGNED_IN') {
                    loadUserData(session.user);
                }
            });
            
            // Check authentication state
            try {
                // First check for session
                const { data: { session }, error: sessionError } = await auth.getSession();
                if (sessionError) {
                    console.warn('Session check failed:', sessionError);
                    window.location.href = '/auth/auth.html';
                    return;
                }

                if (!session) {
                    console.log('No active session found');
                    window.location.href = '/auth/auth.html';
                    return;
                }

                // Now get user details
                const { data: { user }, error } = await auth.getUser();
                if (error) {
                    console.error('Error getting user:', error);
                    window.location.href = '/auth/auth.html';
                    return;
                }
                
                if (user) {
                    // Update avatar with user email or name
                    const userAvatar = document.querySelector('#userAvatar');
                    if (userAvatar) {
                        const nameInitial = user.email ? user.email.charAt(0).toUpperCase() : 'G';
                        userAvatar.src = `https://ui-avatars.com/api/?name=${nameInitial}&background=4B5EAA&color=fff`;
                    }
                    
                    // Update user display name
                    const userDisplayName = document.querySelector('#userDisplayName');
                    if (userDisplayName) {
                        userDisplayName.textContent = user.email || 'Signed In User';
                    }
                    
                    // Load the user's project data
                    await loadUserData(user);
                } else {
                    // Not logged in, redirect to auth page
                    window.location.href = '/auth/auth.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/auth/auth.html';
            }
        });
        
        // Load user's project data
        async function loadUserData(user) {
            try {
                console.log("Loading user data for:", user.id);
                
                // First, try to get project ID from localStorage
                const storedProjectId = localStorage.getItem('currentProjectId');
                
                // Try to load user's projects
                const { data: projectsData, error: projectsError } = await projects.getAll();
                
                if (projectsError) {
                    console.error("Error loading projects:", projectsError);
                    return;
                }
                
                console.log("User projects:", projectsData);
                
                // If we have projects, use the first one or the stored one
                if (projectsData && projectsData.length > 0) {
                    // If we have a stored project ID, try to find that project
                    if (storedProjectId) {
                        const storedProject = projectsData.find(p => p.id === storedProjectId);
                        if (storedProject) {
                            currentProject = storedProject;
                        } else {
                            // Stored project not found, use the first one
                            currentProject = projectsData[0];
                        }
                    } else {
                        // No stored project, use the first one
                        currentProject = projectsData[0];
                    }
                    
                    // Store the current project ID
                    localStorage.setItem('currentProjectId', currentProject.id);
                    
                    // Update project info in UI
                    updateProjectUI(currentProject);
                    
                    // Load chapters for this project
                    await loadProjectChapters(currentProject.id);
                    
                    // Load context items
                    await loadContextItems(currentProject.id);
                } else {
                    // No projects found, create a default one
                    const { data: newProject, error: createError } = await projects.create(
                        "My Novel", 
                        "A new writing project"
                    );
                    
                    if (createError) {
                        console.error("Error creating default project:", createError);
                        return;
                    }
                    
                    if (newProject && newProject.length > 0) {
                        currentProject = newProject[0];
                        localStorage.setItem('currentProjectId', currentProject.id);
                        
                        // Update project info in UI
                        updateProjectUI(currentProject);
                        
                        // Create a default chapter
                        await createDefaultChapter(currentProject.id);
                    }
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }
        
        // Update the project information in the UI
        function updateProjectUI(project) {
            // Update project title
            const projectTitle = document.querySelector('.sidebar .bg-white.rounded-lg.p-3.shadow-sm-custom.mb-4 h2');
            if (projectTitle && project) {
                projectTitle.textContent = project.title || "My Novel";
            }
            
            // Update last edited date
            const lastEdited = document.querySelector('.sidebar .bg-white.rounded-lg.p-3.shadow-sm-custom.mb-4 .text-xs.text-textSecondary span');
            if (lastEdited && project && project.updated_at) {
                const date = new Date(project.updated_at);
                lastEdited.textContent = `Last edited: ${date.toLocaleString()}`;
            }
        }
        
        // Load chapters for a project
        async function loadProjectChapters(projectId) {
            try {
                const { data: chaptersData, error: chaptersError } = await chapters.getByProject(projectId);
                
                if (chaptersError) {
                    console.error("Error loading chapters:", chaptersError);
                    return;
                }
                
                console.log("Project chapters:", chaptersData);
                
                // Update the chapters list in the sidebar
                const chaptersContainer = document.querySelector('.sidebar .space-y-1');
                if (chaptersContainer) {
                    // Clear existing chapters
                    chaptersContainer.innerHTML = '';
                    
                    // Add chapters to the sidebar
                    if (chaptersData && chaptersData.length > 0) {
                        chaptersData.forEach((chapter, index) => {
                            const chapterItem = document.createElement('div');
                            chapterItem.className = `chapter-item p-2 pl-3 rounded cursor-pointer ${index === 0 ? 'active' : ''}`;
                            chapterItem.dataset.id = chapter.id;
                            
                            chapterItem.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <span>${chapter.title || `Chapter ${index + 1}`}</span>
                                    <i class="fas fa-grip-lines text-gray-300 cursor-move"></i>
                                </div>
                            `;
                            
                            // Add click handler to load chapter content
                            chapterItem.addEventListener('click', () => {
                                // Remove active class from all chapters
                                document.querySelectorAll('.chapter-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                
                                // Add active class to this chapter
                                chapterItem.classList.add('active');
                                
                                // Load the chapter content
                                loadChapterContent(chapter);
                            });
                            
                            chaptersContainer.appendChild(chapterItem);
                        });
                        
                        // Load the first chapter by default
                        if (chaptersData.length > 0) {
                            loadChapterContent(chaptersData[0]);
                        }
                    } else {
                        // No chapters, show a message
                        chaptersContainer.innerHTML = `
                            <div class="text-sm text-gray-500 italic p-2">
                                No chapters found. Add a chapter to get started.
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error("Error in loadProjectChapters:", error);
            }
        }
        
        // Load chapter content into the editor
        function loadChapterContent(chapter) {
            if (!chapter) return;
            
            // Store current chapter reference
            currentChapter = chapter;
            
            // Get the editor content element
            const editorContent = document.querySelector('.editor-content');
            if (editorContent) {
                // Set the chapter title
                editorContent.innerHTML = `
                    <h1 class="text-3xl font-bold mb-6">${chapter.title || 'Untitled Chapter'}</h1>
                    ${chapter.content || '<p class="mb-4">Start writing your story here...</p>'}
                `;
            }
            
            // Update word count
            updateWordCount();
        }
        
        // Create a default chapter for a new project
        async function createDefaultChapter(projectId) {
            try {
                const { data, error } = await chapters.create(
                    projectId,
                    "Chapter 1: Introduction",
                    "<p class=\"mb-4\">Start writing your story here. The cursor blinked rhythmically against the blank page, taunting with its emptiness. Every great story begins with a single word, then another, until a world emerges from nothing but imagination.</p><p class=\"mb-4\">Use the AI tools in the toolbar to continue your story, rewrite sections, or get suggestions when you're stuck. Your story context is always at hand in the sidebar to maintain consistency.</p>",
                    0
                );
                
                if (error) {
                    console.error("Error creating default chapter:", error);
                    return;
                }
                
                console.log("Default chapter created:", data);
                
                // Load the chapters to refresh the UI
                await loadProjectChapters(projectId);
            } catch (error) {
                console.error("Error in createDefaultChapter:", error);
            }
        }
        
        // Load context items
        async function loadContextItems(projectId) {
            try {
                // Load characters
                const { data: characterData, error: characterError } = await characters.getByProject(projectId);
                
                if (characterError) {
                    console.error("Error loading characters:", characterError);
                    return;
                }
                
                console.log("Project characters:", characterData);
                
                // Update the context items in the sidebar
                const contextContainer = document.querySelector('.sidebar .space-y-1:nth-of-type(2)');
                if (contextContainer) {
                    // Clear existing items
                    contextContainer.innerHTML = '';
                    
                    // Add characters to the sidebar
                    if (characterData && characterData.length > 0) {
                        characterData.forEach(character => {
                            const characterItem = document.createElement('div');
                            characterItem.className = 'p-2 text-sm hover:bg-gray-50 rounded cursor-pointer';
                            
                            characterItem.innerHTML = `
                                <div class="font-medium">${character.name}</div>
                                <div class="text-xs text-textSecondary">${character.role || 'Character'}</div>
                            `;
                            
                            contextContainer.appendChild(characterItem);
                        });
                        
                        // Update the context count
                        const contextCount = document.querySelector('.sidebar .mb-3 span.text-xs');
                        if (contextCount) {
                            contextCount.textContent = `${characterData.length} items`;
                        }
                    } else {
                        // No characters, show a message
                        contextContainer.innerHTML = `
                            <div class="text-sm text-gray-500 italic p-2">
                                No context items found. Add some to enhance your story.
                            </div>
                        `;
                        
                        // Update context count
                        const contextCount = document.querySelector('.sidebar .mb-3 span.text-xs');
                        if (contextCount) {
                            contextCount.textContent = `0 items`;
                        }
                    }
                }
            } catch (error) {
                console.error("Error in loadContextItems:", error);
            }
        }
        
        // Update word count
        function updateWordCount() {
            if (!currentChapter) return;
            
            // Get the content without HTML tags
            const content = currentChapter.content || '';
            const textContent = content.replace(/<[^>]*>/g, ' ');
            
            // Count words
            const words = textContent.split(/\s+/).filter(word => word.length > 0).length;
            
            // Update the word count display
            const wordCountElement = document.querySelector('.sidebar .text-xl.font-semibold');
            if (wordCountElement) {
                wordCountElement.textContent = words.toLocaleString();
            }
            
            // Update progress circle (assuming 50,000 words is the goal)
            const goalWords = 50000;
            const progress = Math.min(100, Math.round((words / goalWords) * 100));
            
            // Update the progress circle
            const progressCircle = document.querySelector('.sidebar svg circle:nth-child(2)');
            if (progressCircle) {
                progressCircle.setAttribute('stroke-dasharray', `${progress} 100`);
            }
            
            // Update the progress text
            const progressText = document.querySelector('.sidebar .absolute.top-1/2 .text-xs');
            if (progressText) {
                progressText.textContent = `${progress}%`;
            }
        }
        
        // Add a new chapter
        const addChapterBtn = document.querySelector('.sidebar .btn.btn-primary.w-full');
        if (addChapterBtn) {
            addChapterBtn.addEventListener('click', async () => {
                try {
                    if (!currentProject || !currentProject.id) {
                        console.error("No current project found");
                        return;
                    }
                    
                    // Get the current chapters to determine the next chapter number
                    const { data: chaptersData, error: chaptersError } = await chapters.getByProject(currentProject.id);
                    
                    if (chaptersError) {
                        console.error("Error getting chapters:", chaptersError);
                        return;
                    }
                    
                    // Determine the next chapter number
                    const nextChapterNumber = (chaptersData ? chaptersData.length : 0) + 1;
                    
                    // Create the new chapter
                    const { data, error } = await chapters.create(
                        currentProject.id,
                        `Chapter ${nextChapterNumber}`,
                        "<p class=\"mb-4\">Start writing your new chapter here...</p>",
                        nextChapterNumber - 1
                    );
                    
                    if (error) {
                        console.error("Error creating new chapter:", error);
                        return;
                    }
                    
                    console.log("New chapter created:", data);
                    
                    // Reload the chapters
                    await loadProjectChapters(currentProject.id);
                } catch (error) {
                    console.error("Error adding new chapter:", error);
                }
            });
        }
        
        // Context manager button
        const manageContextBtn = document.getElementById('manageContextBtn');
        if (manageContextBtn) {
            manageContextBtn.addEventListener('click', () => {
                // Navigate to context page with project ID
                if (currentProject && currentProject.id) {
                    window.location.href = `context.html?project_id=${currentProject.id}`;
                } else {
                    window.location.href = 'context.html';
                }
            });
        }
    </script>
</body>
</html> 