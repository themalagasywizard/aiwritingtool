<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIStoryCraft</title>
    <!-- Environment Variables Script -->
    <script>
        window.ENV = {
            SUPABASE_URL: '<%= process.env.SUPABASE_URL %>',
            SUPABASE_ANON_KEY: '<%= process.env.SUPABASE_ANON_KEY %>'
        };
    </script>
    <!-- Supabase Configuration -->
    <meta name="supabase-url" content="<%= process.env.SUPABASE_URL %>">
    <meta name="supabase-anon-key" content="<%= process.env.SUPABASE_ANON_KEY %>">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4B5EAA',
                        primaryLight: '#E6E9F0',
                        secondary: '#6B7280',
                        accent: '#F472B6',
                        background: '#F9FAFB',
                        textPrimary: '#1F2937',
                        textSecondary: '#9CA3AF',
                        success: '#34D399',
                        error: '#EF4444',
                        warning: '#FBBF24',
                    }
                }
            }
        }
    </script>
    <!-- Shadcn/UI Custom Styles -->
    <link rel="stylesheet" href="css/shadcn.css">
    <!-- Shadcn/UI Component Initialization -->
    <script type="module">
        import { initializeShadcnUI } from './lib/initialize.js';
        import { setupDarkModeToggle } from './lib/utils.js';
        import { Switch } from './components/ui/switch.js';
        import { Label } from './components/ui/label.js';
        
        // Initialize Shadcn/UI components after DOM content is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing Shadcn/UI components...');
            // Setup dark mode toggle first
            setupDarkModeToggle();
            // Then initialize UI components
            initializeShadcnUI();
            // Initialize the dark mode switch in profile dropdown
            initializeDarkModeSwitch();
        });
        
        // Initialize the dark mode switch in profile dropdown
        function initializeDarkModeSwitch() {
            // Create the container for the switch
            const switchContainer = document.createElement('div');
            switchContainer.className = 'p-2 hover:bg-gray-50 rounded cursor-pointer flex items-center justify-between';
            
            // Create the left content with icon and text
            const leftContent = document.createElement('div');
            leftContent.className = 'flex items-center';
            leftContent.innerHTML = '<i class="fas fa-moon text-primary mr-2"></i><span>Dark Mode</span>';
            
            // Create the switch with proper initial state
            const isDarkMode = document.documentElement.classList.contains('dark');
            const darkModeSwitch = Switch({
                id: 'darkModeSwitch',
                checked: isDarkMode,
                onChange: function(e) {
                    // Call the toggleDarkMode function directly
                    if (window.toggleDarkMode) {
                        window.toggleDarkMode();
                    }
                }
            });
            
            // Add click handler to the entire container for better UX
            switchContainer.addEventListener('click', function(e) {
                // Only process if we didn't click directly on the checkbox
                if (e.target.id !== 'darkModeSwitch') {
                    // Get the checkbox and toggle it programmatically
                    const checkbox = document.getElementById('darkModeSwitch');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        
                        // Manually trigger the change event
                        const changeEvent = new Event('change');
                        checkbox.dispatchEvent(changeEvent);
                    }
                    
                    // Call toggleDarkMode directly as fallback
                    if (window.toggleDarkMode) {
                        window.toggleDarkMode();
                    }
                }
            });
            
            // Assemble the switch container
            switchContainer.appendChild(leftContent);
            switchContainer.appendChild(darkModeSwitch);
            
            // Add to profile dropdown before sign out button
            const signOutBtn = document.getElementById('signOutBtn');
            if (signOutBtn) {
                signOutBtn.parentNode.insertBefore(switchContainer, signOutBtn);
            }
        }
    </script>
    <!-- Custom Styles -->
    <style>
        @layer base {
          :root {
            --radius: 0.5rem;
            --background: oklch(1 0 0);
            --foreground: oklch(0.141 0.005 285.823);
            --card: oklch(1 0 0);
            --card-foreground: oklch(0.141 0.005 285.823);
            --popover: oklch(1 0 0);
            --popover-foreground: oklch(0.141 0.005 285.823);
            --primary: oklch(0.21 0.006 285.885);
            --primary-foreground: oklch(0.985 0 0);
            --secondary: oklch(0.967 0.001 286.375);
            --secondary-foreground: oklch(0.21 0.006 285.885);
            --muted: oklch(0.967 0.001 286.375);
            --muted-foreground: oklch(0.552 0.016 285.938);
            --accent: oklch(0.967 0.001 286.375);
            --accent-foreground: oklch(0.21 0.006 285.885);
            --destructive: oklch(0.577 0.245 27.325);
            --destructive-foreground: oklch(0.985 0 0);
            --success: oklch(0.646 0.222 41.116);
            --success-foreground: oklch(0.985 0 0);
            --warning: oklch(0.828 0.189 84.429);
            --warning-foreground: oklch(0.141 0.005 285.823);
            --border: oklch(0.92 0.004 286.32);
            --input: oklch(0.92 0.004 286.32);
            --ring: oklch(0.705 0.015 286.067);
            --sidebar: oklch(0.985 0 0);
            --sidebar-foreground: oklch(0.141 0.005 285.823);
            --sidebar-primary: oklch(0.21 0.006 285.885);
            --sidebar-primary-foreground: oklch(0.985 0 0);
            --sidebar-accent: oklch(0.967 0.001 286.375);
            --sidebar-accent-foreground: oklch(0.21 0.006 285.885);
            --sidebar-border: oklch(0.92 0.004 286.32);
            --sidebar-ring: oklch(0.705 0.015 286.067);
            --header-bg: oklch(1 0 0);
          }

          .dark {
            --background: oklch(0.141 0.005 285.823);
            --foreground: oklch(0.985 0 0);
            --card: oklch(0.21 0.006 285.885);
            --card-foreground: oklch(0.985 0 0);
            --popover: oklch(0.21 0.006 285.885);
            --popover-foreground: oklch(0.985 0 0);
            --primary: oklch(0.92 0.004 286.32);
            --primary-foreground: oklch(0.21 0.006 285.885);
            --secondary: oklch(0.274 0.006 286.033);
            --secondary-foreground: oklch(0.985 0 0);
            --muted: oklch(0.274 0.006 286.033);
            --muted-foreground: oklch(0.705 0.015 286.067);
            --accent: oklch(0.274 0.006 286.033);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.704 0.191 22.216);
            --destructive-foreground: oklch(0.985 0 0);
            --success: oklch(0.488 0.243 264.376);
            --success-foreground: oklch(0.985 0 0);
            --warning: oklch(0.769 0.188 70.08);
            --warning-foreground: oklch(0.985 0 0);
            --border: oklch(1 0 0 / 10%);
            --input: oklch(1 0 0 / 15%);
            --ring: oklch(0.552 0.016 285.938);
            --sidebar: oklch(0.21 0.006 285.885);
            --sidebar-foreground: oklch(0.985 0 0);
            --sidebar-primary: oklch(0.488 0.243 264.376);
            --sidebar-primary-foreground: oklch(0.985 0 0);
            --sidebar-accent: oklch(0.274 0.006 286.033);
            --sidebar-accent-foreground: oklch(0.985 0 0);
            --sidebar-border: oklch(1 0 0 / 10%);
            --sidebar-ring: oklch(0.552 0.016 285.938);
            --header-bg: hsl(240 3.7% 15.9%);
          }
        }

        /* Header styling */
        header, .header {
            background-color: var(--header-bg);
            color: var(--card-foreground);
            border-color: var(--border);
        }

        /* Toolbar styling */
        .editor-toolbar, .toolbar {
            background-color: var(--card);
            color: var(--card-foreground);
            border-color: var(--border);
        }

        /* Make AI Assistant panel use the theme correctly */
        #aiAssistPanel {
            background-color: var(--sidebar);
            color: var(--sidebar-foreground);
            border-color: var(--sidebar-border);
        }

        /* Sidebar styling */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar);
            color: var(--sidebar-foreground);
            border-right: 1px solid var(--sidebar-border);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.03);
        }

        /* Additional dark mode overrides for specific elements */
        .dark body,
        .dark main,
        .dark .main-content,
        .dark #editorContent,
        .dark [contenteditable="true"],
        .dark .editor-content {
            background-color: var(--background) !important;
            color: var(--foreground) !important;
        }

        .dark header, 
        .dark .editor-toolbar,
        .dark .bg-white {
            background-color: var(--header-bg) !important;
            border-color: var(--border) !important;
            color: var(--card-foreground) !important;
        }

        .dark .sidebar {
            background-color: var(--sidebar) !important;
            color: var(--sidebar-foreground) !important;
            border-color: var(--sidebar-border) !important;
        }

        .dark .toolbar-btn {
            color: var(--card-foreground) !important;
        }

        .dark .toolbar-btn:hover {
            background-color: var(--primary-light) !important;
            color: var(--primary) !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }

        .editor-content {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
        }

        .chapter-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .chapter-item:hover {
            background-color: var(--card);
            border-left: 3px solid var(--primary);
            transform: translateX(2px);
        }

        .chapter-item.active {
            background-color: var(--card);
            border-left: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background-color: var(--primary);
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
        }

        .btn-success {
            background-color: var(--success);
            color: var(--success-foreground);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-success:hover {
            background-color: var(--success);
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
        }

        .btn-error {
            background-color: var(--error);
            color: var(--error-foreground);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-error:hover {
            background-color: var(--error);
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
        }

        .toolbar-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .toolbar-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .modal {
            transition: opacity 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        input[type=range] {
            -webkit-appearance: none;
            height: 6px;
            background: var(--secondary);
            border-radius: 3px;
            background-image: linear-gradient(to right, var(--primary), var(--accent));
            background-size: 50% 100%;
            background-repeat: no-repeat;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid var(--background);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7' /%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Character Tree Visualization */
        .character-tree {
            position: relative;
            min-height: 300px;
            padding: 1rem;
            overflow: visible;
        }

        .character-node {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-light);
            border: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .character-node:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(75, 94, 170, 0.3);
            z-index: 20;
        }

        .character-node.protagonist {
            background-color: var(--primary);
            color: white;
        }

        .character-node.antagonist {
            background-color: var(--error);
            border-color: #dc3030;
            color: white;
        }

        .character-node.supporting {
            background-color: var(--accent);
            border-color: #d161a1;
            color: white;
        }

        .character-node.minor {
            background-color: var(--secondary);
            border-color: #5a6069;
            color: white;
        }

        .character-link {
            position: absolute;
            height: 2px;
            background-color: var(--secondary);
            transform-origin: 0 0;
            z-index: 5;
            opacity: 0.6;
            pointer-events: none;
        }

        .character-tooltip {
            position: absolute;
            width: 220px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            transform: translateX(-50%) translateY(-100%) translateY(-10px);
        }

        .character-node:hover .character-tooltip {
            opacity: 1;
        }

        /* AI Assistant Styles */
        .ai-mode-btn {
            transition: all 0.2s ease;
            flex: 1;
            min-width: 120px;
            padding: 0.5rem 2rem;
        }

        .ai-mode-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(75, 94, 170, 0.2);
        }

        .ai-mode-btn:not(.active):hover {
            background-color: var(--primaryLight);
            transform: translateY(-1px);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        /* Chat Message Styles */
        .chat-message {
            max-width: 85%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.95rem;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s ease forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            margin-left: auto;
            background-color: white;
            border: 1px solid var(--primary-light);
            border-radius: 1rem 1rem 0 1rem;
            color: var(--text-primary);
        }

        .chat-message.ai {
            margin-right: auto;
            background-color: var(--primary-light);
            border-radius: 1rem 1rem 1rem 0;
            color: var(--text-primary);
        }

        .chat-message p {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Chat container styles */
        #chatHistory {
            padding: 1rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            min-height: 300px;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) transparent;
        }

        #chatHistory::-webkit-scrollbar {
            width: 6px;
        }

        #chatHistory::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        #chatHistory::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        #chatHistory::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }

        /* Chat input styles */
        #chatInput {
            min-height: 100px;
            max-height: 200px;
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
            padding: 0.75rem;
            padding-right: 3rem;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #chatInput::-webkit-scrollbar {
            width: 6px;
        }

        #chatInput::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatInput::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
        }

        /* AI Output styles */
        #aiOutput {
            overflow-y: auto;
            min-height: 200px;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) transparent;
            word-wrap: break-word;
            white-space: pre-wrap;
            padding: 1px 1rem 1rem 1rem; /* Ensure top padding is exactly 1px */
        }

        #aiOutput .prose {
            font-family: 'Inter', sans-serif;
            margin-top: 0;
            padding-top: 0;
        }

        #aiOutput p {
            margin-bottom: 0.75rem;
            margin-top: 0; /* Ensure no top margin on paragraphs */
        }

        #aiOutput p:first-child {
            margin-top: 0;
        }

        #aiOutput p:last-child {
            margin-bottom: 0;
        }

        #aiOutput:empty::before {
            content: 'AI output will appear here...';
            color: var(--text-secondary);
        }

        /* Target the div that wraps the content in the AI output */
        #aiOutput > div {
            margin-top: 0;
            padding-top: 0;
        }

        /* Specifically target the .space-y-2 inside aiOutput */
        #aiOutput .space-y-2 {
            margin-top: 0;
            padding-top: 0;
        }

        #aiOutput::-webkit-scrollbar {
            width: 6px;
        }

        #aiOutput::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        #aiOutput::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        #aiOutput::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            /* Header optimizations */
            header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 56px;
                background: white;
                z-index: 50;
                padding: 0;
                display: flex;
                justify-content: space-between;
            }

            /* Mobile icon buttons */
            .mobile-icon-btn {
                min-width: unset;
                width: 36px;
                height: 36px;
                border-radius: 6px;
                padding: 0;
                margin: 0 2px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            /* Ensure header buttons are properly sized on mobile */
            #saveBtn, #loadProjectBtn, #newProjectBtn {
                width: 36px;
                height: 36px;
                padding: 0;
                justify-content: center;
            }

            /* Hide button text on mobile */
            header .btn span,
            .editor-toolbar .btn span,
            #saveBtn span, 
            #loadProjectBtn span, 
            #newProjectBtn span {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                position: absolute !important;
                opacity: 0 !important;
            }

            /* Ensure all buttons maintain proper sizing in mobile */
            .btn {
                min-width: unset;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            header .btn i {
                margin: 0;
                font-size: 0.875rem;
            }

            /* Make logo smaller */
            header .w-10.h-10 {
                width: 32px;
                height: 32px;
                min-width: 32px;
            }

            /* Adjust header sections */
            header > div:first-child {
                display: flex;
                align-items: center;
                padding-left: 8px;
                position: relative; /* For save status positioning */
            }

            header > div:last-child {
                display: flex;
                align-items: center;
                padding-right: 8px;
                gap: 6px;
            }

            /* Editor toolbar styling */
            .editor-toolbar {
                position: fixed;
                top: 64px;
                left: 0;
                right: 0;
                width: 100%;
                background: white;
                z-index: 49;
                padding: 8px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                height: 48px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            /* Adjust main content area to account for new spacing */
            main {
                margin-top: 112px; /* Increased from 104px */
                height: calc(100vh - 112px);
                overflow-y: auto;
                width: 100%;
            }

            /* Update sidebar top position to match new toolbar position */
            .sidebar {
                top: 112px; /* Increased from 104px */
            }

            /* Mobile sidebar */
            .sidebar {
                position: fixed;
                left: -250px;
                top: 56px; /* Match only header height since it's now fixed */
                bottom: 0;
                width: 250px;
                background: white;
                z-index: 48;
                transition: transform 0.3s ease;
                display: block !important;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
            }

            .sidebar.active {
                transform: translateX(250px);
                visibility: visible;
                opacity: 1;
            }

            /* Mobile overlay for sidebar */
            #sidebarOverlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 47;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease;
                display: block;
            }

            #sidebarOverlay.active {
                opacity: 1;
                visibility: visible;
                display: block !important;
            }

            /* Adjust AI Assistant panel for mobile */
            #aiAssistPanel {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
            }
            
            /* Make sure AI output and chat history are scrollable on mobile */
            #aiOutput {
                max-height: calc(50vh - 100px);
                overflow-y: auto;
            }
            
            #chatHistory {
                max-height: calc(50vh - 100px);
                overflow-y: auto;
            }
            
            /* Profile dropdown styling for mobile */
            #profileDropdownContainer {
                position: fixed !important;
                top: 60px !important;
                right: 10px !important;
                z-index: 100 !important;
            }
            
            #profileDropdownContainer .profile-dropdown {
                visibility: visible !important;
                opacity: 1 !important;
                display: block !important;
                width: 200px !important;
                background-color: white !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 0.5rem !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            }
        }

        /* Additional mobile-specific styles */
        @media (max-width: 640px) {
            /* Make all buttons more compact on very small screens */
            .btn {
                padding: 0.5rem;
                margin: 0 2px;
            }
            
            /* Mobile header buttons styling */
            .mobile-icon-btn {
                width: 40px;
                height: 40px;
                border-radius: 8px;
            }
            
            /* Mobile icon sizing */
            .mobile-icon-btn i,
            #mobileMenuBtn i {
                font-size: 0.95rem;
                margin: 0;
            }
            
            /* AI Assist button mobile styling */
            #aiAssistBtn {
                height: 40px;
                min-width: 110px;
                padding: 0 10px;
                border-radius: 8px;
            }
            
            #aiAssistBtn i {
                font-size: 1.1rem;
            }
            
            #aiAssistBtn span {
                display: inline-block !important;
                width: auto !important;
                height: auto !important;
                overflow: visible !important;
                position: static !important;
                opacity: 1 !important;
            }
            
            /* Extra insurance for hiding text in regular mobile buttons */
            .mobile-hidden {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                visibility: hidden !important;
            }
        }
        
        /* Fix for iOS zoom issues */
        @supports (-webkit-touch-callout: none) {
            @media (max-width: 768px) {
                header, .editor-toolbar {
                    -webkit-transform: translateZ(0);
                    transform: translateZ(0);
                    will-change: transform;
                }
                
                #editorContent {
                    -webkit-overflow-scrolling: touch;
                }
                
                /* Enable smooth scrolling for iOS */
                #aiOutput, #chatHistory {
                    -webkit-overflow-scrolling: touch;
                }
            }
        }

        /* Context selection styles */
        .context-item-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .context-item-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .context-item-checkbox:checked::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
            line-height: 1;
        }
        
        .context-item-checkbox:focus {
            outline: none;
            ring: 2px var(--primary);
        }
        
        #contextSelectionPanel {
            transition: max-height 0.3s ease-in-out;
            overflow: hidden;
        }

        /* AI Output container in the Generate/Edit view */
        #generateEditView #aiOutput {
            padding-top: 1px; /* Ensure consistent 1px top padding */
        }

        /* More aggressive dark mode overrides for Tailwind classes */
        .dark .bg-white {
            background-color: #1f2937 !important;
        }
        
        .dark [class*="bg-white"] {
            background-color: #1f2937 !important;
        }
        
        /* Make sure the editor and its content are dark */
        .dark .editor-content, 
        .dark #editorContent,
        .dark .flex-1.overflow-y-auto.p-8.bg-white {
            background-color: var(--background) !important;
        }
        
        /* Ensure all main areas properly get dark styling */
        .dark .flex-1.overflow-hidden.flex.flex-col.bg-white {
            background-color: var(--background) !important;
        }

        /* Specific dark mode overrides for AI Assistant panel */
        .dark #aiAssistPanel {
            background-color: #1f2937 !important;
            color: #f3f4f6 !important;
            border-color: #374151 !important;
        }

        .dark #aiOutput,
        .dark #chatHistory {
            background-color: #111827 !important;
            color: #f3f4f6 !important;
            border-color: #374151 !important;
        }

        .dark .flex-shrink-0.p-4.border-b.border-gray-200,
        .dark .flex-shrink-0.bg-primaryLight\/20.p-3.border-b.border-gray-200,
        .dark .flex-shrink-0.space-y-3.px-4,
        .dark .flex-shrink-0.p-4.border-t.border-gray-200 {
            background-color: #1f2937 !important;
            border-color: #374151 !important;
        }

        .dark #chatInput,
        .dark #aiInput,
        .dark #aiTone,
        .dark input[type="range"] {
            background-color: #111827 !important;
            color: #f3f4f6 !important;
            border-color: #374151 !important;
        }

        /* Make buttons white in dark mode - consistent styling */
        .dark .btn,
        .dark button[data-shadcn="button"],
        .dark [data-variant="default"],
        .dark .btn-primary,
        .dark .btn-secondary,
        .dark .btn-success,
        .dark .btn-error {
            background-color: white !important;
            color: black !important;
            border: 1px solid white !important;
        }
        
        .dark .btn:hover,
        .dark button[data-shadcn="button"]:hover {
            background-color: rgba(255, 255, 255, 0.8) !important;
            color: black !important;
        }

        /* Override any buttons that might need specific handling */
        .dark #cancelNewProject,
        .dark #createNewProject,
        .dark #aiSubmit,
        .dark #chatSubmit,
        .dark #insertIntoChapterBtn {
            background-color: white !important;
            color: black !important;
            border: 1px solid white !important;
        }

        /* Style for submit buttons */
        .dark #chatSubmit,
        .dark #aiSubmit {
            color: black !important;
        }

        /* Mode toggle buttons in AI panel */
        .dark .ai-mode-btn {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
        }

        .dark .ai-mode-btn.active {
            background-color: #4B5EAA !important;
            color: white !important;
        }

        /* Make AI output text visible */
        .dark .prose,
        .dark .prose p {
            color: #f3f4f6 !important;
        }

        /* Fix placeholder text color */
        .dark textarea::placeholder,
        .dark input::placeholder {
            color: #9CA3AF !important;
        }

        /* AI Panel Tab Styling for Dark Mode */
        .dark .ai-mode-btn {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
        }

        .dark .ai-mode-btn.active {
            background-color: white !important;
            color: black !important;
            border: 1px solid white !important;
        }
        
        .dark .ai-mode-btn:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        /* Dark mode for model selector and dropdown */
        .dark select {
            background-color: #1f2937 !important;
            color: #f3f4f6 !important;
            border-color: #374151 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23F3F4F6' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Monochrome button styles */
        .btn-monochrome {
            background-color: black !important;
            color: white !important;
            border: 1px solid black !important;
        }

        .btn-monochrome:hover {
            background-color: rgba(0, 0, 0, 0.8) !important;
        }

        .dark .btn-monochrome {
            background-color: white !important;
            color: black !important;
            border: 1px solid white !important;
        }

        .dark .btn-monochrome:hover {
            background-color: rgba(255, 255, 255, 0.8) !important;
        }
        
        /* Handle monochrome error states */
        .btn-monochrome.btn-error {
            background-color: black !important;
            color: white !important;
            border-color: #EF4444 !important;
        }
        
        .dark .btn-monochrome.btn-error {
            background-color: white !important;
            color: black !important;
            border-color: #EF4444 !important;
        }

        /* Special handling for the dark mode toggle button */
        .dark #darkModeToggle,
        .dark .btn-ghost,
        .dark button[data-variant="ghost"] {
            background-color: transparent !important;
            border-color: transparent !important;
            color: white !important;
        }

        .dark #darkModeToggle:hover,
        .dark .btn-ghost:hover,
        .dark button[data-variant="ghost"]:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }

        /* More specific and stronger dark mode button styling - overriding anything else */
        .dark button#loadProjectBtn,
        .dark button#newProjectBtn,
        .dark button#addChapterBtn,
        .dark button#aiAssistBtn,
        .dark button#exportPdfBtn,
        .dark button#manageContextBtn,
        .dark button[class*="btn-"],
        .dark button[data-shadcn="button"]:not(#darkModeToggle):not([data-variant="ghost"]) {
            background-color: white !important;
            color: black !important;
            border-color: white !important;
        }

        /* ... rest of the existing styles ... */

        /* Fix AI tabs display */
        #generateEditView,
        #chatView {
            background-color: var(--background) !important;
            color: var(--foreground);
        }

        .dark #generateEditView,
        .dark #chatView {
            background-color: var(--background) !important;
            color: var(--foreground) !important;
        }

        /* AI Output and Chat Styles */
        #aiOutput, 
        #chatHistory {
            background-color: var(--card);
            color: var(--card-foreground);
            border-color: var(--border);
        }

        /* Mode buttons in AI panel */
        .ai-mode-btn {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
        }

        .ai-mode-btn.active {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .ai-mode-btn:not(.active):hover {
            background-color: var(--accent);
            opacity: 0.8;
        }

        /* Chat messages */
        .chat-message.user {
            background-color: var(--card);
            border-color: var(--border);
            color: var(--card-foreground);
        }

        .chat-message.ai {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .dark .chat-message.user {
            background-color: var(--secondary);
            border-color: var(--secondary);
            color: var(--secondary-foreground);
        }

        .dark .chat-message.ai {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }
        
        /* Character node styling for context panel */
        .character-node {
            background-color: var(--card);
            border-color: var(--primary);
            color: var(--card-foreground);
        }
        
        .character-tooltip {
            background-color: var(--popover);
            color: var(--popover-foreground);
            border-color: var(--border);
        }
        
        /* Make buttons consistent */
        button[data-shadcn="button"] {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }
        
        /* Input fields */
        input, textarea, select {
            background-color: var(--input);
            color: var(--foreground);
            border-color: var(--border);
        }
        
        .dark input, 
        .dark textarea, 
        .dark select {
            background-color: var(--input);
            color: var(--foreground);
            border-color: var(--border);
        }

        /* ... existing styles continue ... */

        /* Apply specific dark mode styling to editor content */
        .dark .editor-content, 
        .dark #editorContent {
            background-color: hsl(240, 3.7%, 15.9%) !important;
            color: var(--foreground) !important;
            border-color: var(--border) !important;
        }

        /* Apply specific dark mode styling to the project info box in sidebar */
        .dark .sidebar .bg-white.rounded-lg {
            background-color: hsl(240, 3.7%, 15.9%) !important;
            color: var(--foreground) !important;
            border-color: var(--border) !important;
        }

        /* Apply specific dark mode styling to the context box in sidebar */
        .dark #contextList,
        .dark .sidebar .bg-white {
            background-color: hsl(240, 3.7%, 15.9%) !important;
            color: var(--foreground) !important;
            border-color: var(--border) !important;
        }

        /* Apply dark mode styling to word count container */
        .dark .flex.items-center.justify-between.bg-white.p-3.rounded-lg.shadow-sm-custom.text-sm {
            background-color: hsl(240, 3.7%, 15.9%) !important;
            color: var(--foreground) !important;
            border-color: var(--border) !important;
        }

        /* Apply dark mode styling to main content area */
        .dark main, 
        .dark .main,
        .dark .flex-1.overflow-hidden.flex.flex-col.bg-white,
        .dark .flex-1.overflow-y-auto.p-8.bg-white {
            background-color: hsl(240, 3.7%, 15.9%) !important;
            color: var(--foreground) !important;
        }

        /* Full-width sidebar buttons */
        .sidebar .btn,
        .sidebar button[data-shadcn="button"] {
            width: 100%;
        }

        /* Ensure sidebar buttons have full width */
        .sidebar button,
        .sidebar .btn,
        aside.sidebar button,
        aside.sidebar .btn {
            width: 100% !important;
        }

        /* Make sure the "Add Chapter" button has proper spacing */
        #addChapterBtn {
            margin-top: 1.5rem !important;
            width: 100% !important;
        }

        /* Ensure Manage Context and Export PDF buttons have full width */
        #manageContextBtn,
        #exportPdfBtn {
            width: 100% !important;
        }

        /* Add CSS to ensure logo has consistent styling */
        .logo-container {
            background-color: white !important;
        }

        .logo-container i {
            color: black !important;
        }

        /* Logo with fixed styling */
        .w-10.h-10.rounded-full.flex.items-center.justify-center.text-xl.border.border-gray-200.dark\:border-gray-700.logo-container {
            background-color: white !important;
        }

        /* Logo styling with the strongest possible overrides */
        .logo-container {
            background-color: white !important;
            background: white !important;
            color: black !important;
        }

        .logo-container i,
        .logo-container i.fas,
        .logo-container i.fa-feather-alt {
            color: black !important;
        }

        /* Override any other potential theme changes to logo */
        .dark .logo-container {
            background-color: white !important;
            background: white !important;
        }

        .dark .logo-container i,
        .dark .logo-container i.fas,
        .dark .logo-container i.fa-feather-alt {
            color: black !important;
        }

        /* Dark mode switch styling */
        .dark .peer:checked ~ div {
            background-color: white !important;
        }

        .dark .peer-checked\:bg-primary {
            background-color: white !important;
        }

        .dark .hover\:bg-gray-50:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        .dark .profile-dropdown {
            background-color: hsl(240, 3.7%, 15.9%) !important;
            border-color: var(--border) !important;
            color: white !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .peer:checked ~ div::after {
            transform: translateX(100%);
        }

        .peer {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Fixed dropdown styling in dark mode */
        .dark .absolute.right-0.mt-2.w-48.bg-white {
            background-color: hsl(240, 3.7%, 15.9%) !important;
            color: white !important;
        }

        .dark .p-2.hover\:bg-gray-50 {
            color: white !important;
        }

        .dark .p-2.hover\:bg-gray-50:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- Import Supabase client and make it available globally -->
    <script type="module">
        import { projects, chapters, characters, auth, locations, timelineEvents } from './lib/supabase.js';
        // Make services available to non-module scripts
        window.supabaseServices = { auth, projects, chapters, characters, locations, timelineEvents };
    </script>
    
    <script type="module">
        import { projects, chapters, characters, auth } from './lib/supabase.js';
        
        // App state
        const appState = {
            currentProject: null,
            currentChapter: null,
            currentUser: null,
            isDirty: false,
            chapterCache: new Map(),
            contextItems: [],
            wordTarget: 2000
        };

        // Expose appState to window for access from other scripts
        window.appState = appState;

        // Initialize DOM elements after the document is loaded
        let elements;

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            elements = {
                projectTitle: document.getElementById('projectTitle'),
                lastEdited: document.getElementById('lastEdited'),
                chaptersList: document.getElementById('chaptersList'),
                addChapterBtn: document.getElementById('addChapterBtn'),
                saveBtn: document.getElementById('saveBtn'),
                newProjectBtn: document.getElementById('newProjectBtn'),
                editorContent: document.getElementById('editorContent'),
                chapterTitle: document.getElementById('chapterTitle'),
                wordCount: document.getElementById('wordCount'),
                wordCountProgress: document.getElementById('wordCountProgress'),
                wordCountPercent: document.getElementById('wordCountPercent'),
                contextCount: document.getElementById('contextCount'),
                contextList: document.getElementById('contextList'),
                saveStatus: document.getElementById('saveStatus'),
                
                // New Project Modal
                newProjectModal: document.getElementById('newProjectModal'),
                newProjectTitle: document.getElementById('newProjectTitle'),
                newProjectDescription: document.getElementById('newProjectDescription'),
                closeNewProjectModal: document.getElementById('closeNewProjectModal'),
                cancelNewProject: document.getElementById('cancelNewProject'),
                createNewProject: document.getElementById('createNewProject'),
                
                // Loading overlay
                loadingOverlay: document.getElementById('loadingOverlay'),
                loadingMessage: document.getElementById('loadingMessage'),
                loadProjectBtn: document.getElementById('loadProjectBtn'),
            };
            
            // Setup event listeners only after elements are initialized and DOM is fully ready
            // Use a small timeout to ensure all elements are properly rendered and available
            setTimeout(() => {
                if (elements) {
                    setupEventListeners();
                }
            }, 0);
        });

        // Helper Functions
        function showLoading(message = 'Loading...') {
            elements.loadingMessage.textContent = message;
            elements.loadingOverlay.classList.remove('hidden');
            elements.loadingOverlay.classList.add('flex');
        }

        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
            elements.loadingOverlay.classList.remove('flex');
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function countWords(text) {
            // Remove HTML tags and count words
            const cleanText = text.replace(/<[^>]*>/g, '');
            const words = cleanText.trim().split(/\s+/);
            return words.length;
        }

        function updateWordCount() {
            if (!appState.currentChapter) return;
            
            const content = elements.editorContent.innerHTML;
            const count = countWords(content);
            
            // Update the display
            elements.wordCount.textContent = count.toLocaleString();
            
            // Calculate percentage of target
            const percentage = Math.min(Math.round((count / appState.wordTarget) * 100), 100);
            elements.wordCountProgress.setAttribute('stroke-dasharray', `${percentage} 100`);
            elements.wordCountPercent.textContent = `${percentage}%`;
        }

        // Project Functions
        async function loadProjects() {
            try {
                showLoading('Loading projects...');
                
                const { data: userProjects, error } = await projects.getAll();
                
                if (error) throw error;
                
                if (!userProjects || userProjects.length === 0) {
                    // No projects yet, show empty state
                    elements.projectTitle.textContent = 'No projects yet';
                    elements.lastEdited.textContent = 'Create a new project to get started';
                    hideLoading();
                    return;
                }
                
                // Get the last loaded project ID from localStorage
                const lastProjectId = localStorage.getItem('lastProjectId');
                
                // Find the last loaded project or default to the first project
                let currentProject = userProjects[0];
                if (lastProjectId) {
                    const foundProject = userProjects.find(p => p.id === lastProjectId);
                    if (foundProject) {
                        currentProject = foundProject;
                    }
                }
                
                // Set the current project
                appState.currentProject = currentProject;
                
                // Update UI with project info
                updateProjectUI(appState.currentProject);
                
                // Load chapters for this project
                await loadChapters(appState.currentProject.id);
                
                hideLoading();
            } catch (error) {
                console.error('Error loading projects:', error);
                elements.projectTitle.textContent = 'Error loading projects';
                elements.lastEdited.textContent = 'Please try again';
                hideLoading();
            }
        }

        function updateProjectUI(project) {
            if (!project) return;
            
            elements.projectTitle.textContent = project.title;
            elements.lastEdited.textContent = 'Last edited: ' + formatDate(project.updated_at);
        }

        async function createProject(title, description) {
            try {
                showLoading('Creating project...');
                
                const { data: newProject, error } = await projects.create(title, description);
                
                if (error) throw error;
                
                if (!newProject || newProject.length === 0) {
                    throw new Error('Failed to create project');
                }
                
                // Set as current project
                appState.currentProject = newProject[0];
                
                // Save the new project ID to localStorage
                localStorage.setItem('lastProjectId', newProject[0].id);
                
                // Update UI
                updateProjectUI(appState.currentProject);
                
                // Create first chapter
                await createChapter('Chapter 1: Introduction', '', 0);
                
                hideLoading();
                
                return newProject[0];
            } catch (error) {
                console.error('Error creating project:', error);
                hideLoading();
                return null;
            }
        }

        // Chapter Functions
        async function loadChapters(projectId) {
            try {
                if (!projectId) return;
                
                elements.chaptersList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Loading chapters...</div>';
                
                const { data: projectChapters, error } = await chapters.getByProject(projectId);
                
                if (error) throw error;
                
                // Clear chapters list
                elements.chaptersList.innerHTML = '';
                
                if (!projectChapters || projectChapters.length === 0) {
                    elements.chaptersList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-info-circle mr-2"></i>No chapters yet</div>';
                    return;
                }
                
                // Sort chapters by order_index
                projectChapters.sort((a, b) => a.order_index - b.order_index);

                // Initialize or update chapter cache
                projectChapters.forEach(chapter => {
                    if (!appState.chapterCache.has(chapter.id)) {
                        appState.chapterCache.set(chapter.id, chapter);
                    }
                });
                
                // Add chapters to the list
                projectChapters.forEach((chapter, index) => {
                    const chapterElement = document.createElement('div');
                    chapterElement.className = 'chapter-item p-2 pl-3 rounded cursor-pointer';
                    chapterElement.setAttribute('data-chapter-id', chapter.id);
                    chapterElement.setAttribute('draggable', 'true');
                    
                    chapterElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="chapter-title">${chapter.title}</span>
                            <i class="fas fa-grip-lines text-gray-300 cursor-move handle"></i>
                        </div>
                    `;
                    
                    // Add click handler
                    chapterElement.addEventListener('click', () => selectChapter(chapter.id));
                    
                    // Add double-click handler for renaming
                    chapterElement.addEventListener('dblclick', (e) => {
                        if (e.target.closest('.handle')) return; // Don't trigger rename when clicking the handle
                        
                        const titleSpan = chapterElement.querySelector('.chapter-title');
                        const currentTitle = titleSpan.textContent;
                        
                        // Create input for editing
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'w-full p-0 border-none focus:ring-0 bg-primaryLight rounded';
                        input.value = currentTitle;
                        
                        // Replace span with input
                        titleSpan.replaceWith(input);
                        input.focus();
                        input.select();
                        
                        // Save on blur or Enter key
                        const saveChapterTitle = async () => {
                            const newTitle = input.value.trim();
                            if (newTitle && newTitle !== currentTitle) {
                                try {
                                    // Update chapter title in database
                                    const { data: updatedChapter, error } = await chapters.update(
                                        chapter.id,
                                        { title: newTitle }
                                    );
                                    
                                    if (error) throw error;
                                    
                                    // Update local state if this is the current chapter
                                    if (appState.currentChapter && appState.currentChapter.id === chapter.id) {
                                        appState.currentChapter = updatedChapter[0];
                                        elements.chapterTitle.textContent = newTitle;
                                    }
                                    
                                    showToast('Chapter renamed', 'success');
                                } catch (error) {
                                    console.error('Error renaming chapter:', error);
                                    showToast('Failed to rename chapter', 'error');
                                }
                            }
                            
                            // Restore span with updated or original title
                            const newSpan = document.createElement('span');
                            newSpan.className = 'chapter-title';
                            newSpan.textContent = newTitle || currentTitle;
                            input.replaceWith(newSpan);
                        };
                        
                        input.addEventListener('blur', saveChapterTitle);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChapterTitle();
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                const newSpan = document.createElement('span');
                                newSpan.className = 'chapter-title';
                                newSpan.textContent = currentTitle;
                                input.replaceWith(newSpan);
                            }
                        });
                    });
                    
                    // Add drag and drop functionality
                    chapterElement.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', chapter.id);
                        e.dataTransfer.effectAllowed = 'move';
                        chapterElement.classList.add('bg-primaryLight');
                    });
                    
                    chapterElement.addEventListener('dragend', () => {
                        chapterElement.classList.remove('bg-primaryLight');
                    });
                    
                    chapterElement.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                    });
                    
                    chapterElement.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        chapterElement.classList.add('border', 'border-primary');
                    });
                    
                    chapterElement.addEventListener('dragleave', () => {
                        chapterElement.classList.remove('border', 'border-primary');
                    });
                    
                    chapterElement.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        chapterElement.classList.remove('border', 'border-primary');
                        
                        const draggedChapterId = e.dataTransfer.getData('text/plain');
                        if (!draggedChapterId || draggedChapterId === chapter.id) return;
                        
                        try {
                            // Get all chapters in current order
                            const chapterElements = Array.from(elements.chaptersList.querySelectorAll('.chapter-item'));
                            const draggedElement = elements.chaptersList.querySelector(`[data-chapter-id="${draggedChapterId}"]`);
                            const dropElement = chapterElement;
                            
                            // Get current indices
                            const draggedIndex = chapterElements.indexOf(draggedElement);
                            const dropIndex = chapterElements.indexOf(dropElement);
                            
                            // Move element in DOM
                            if (draggedIndex < dropIndex) {
                                // Moving down
                                dropElement.parentNode.insertBefore(draggedElement, dropElement.nextElementSibling);
                            } else {
                                // Moving up
                                dropElement.parentNode.insertBefore(draggedElement, dropElement);
                            }
                            
                            // Update order_index values
                            const updatedChapters = Array.from(elements.chaptersList.querySelectorAll('.chapter-item'))
                                .map((el, idx) => ({
                                    id: el.getAttribute('data-chapter-id'),
                                    order_index: idx
                                }));
                            
                            // Show saving indicator
                            showToast('Updating chapter order...', 'success');
                            
                            // Update database
                            const { error } = await chapters.updateOrder(updatedChapters);
                            
                            if (error) {
                                console.error('Error updating chapter order:', error);
                                showToast('Failed to update chapter order: ' + (error.message || 'Unknown error'), 'error');
                                // Reload chapters to restore original order
                                await loadChapters(projectId);
                                return;
                            }
                            
                            showToast('Chapter order updated', 'success');
                        } catch (error) {
                            console.error('Error updating chapter order:', error);
                            showToast('Failed to update chapter order', 'error');
                            // Reload chapters to restore original order
                            await loadChapters(projectId);
                        }
                    });
                    
                    elements.chaptersList.appendChild(chapterElement);
                });
                
                // Select the first chapter by default if no chapter is selected
                if (projectChapters.length > 0 && !appState.currentChapter) {
                    selectChapter(projectChapters[0].id);
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
                elements.chaptersList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-exclamation-circle mr-2 text-error"></i>Error loading chapters</div>';
            }
        }

        function selectChapter(chapterId) {
            // Save current chapter if it exists and has changes
            if (appState.currentChapter && appState.isDirty) {
                saveCurrentChapter();
            }
            
            // Get chapter from cache
            const chapter = appState.chapterCache.get(chapterId);
            if (!chapter) {
                console.error('Chapter not found in cache:', chapterId);
                return;
            }
            
            // Set as current chapter
            appState.currentChapter = chapter;
            
            // Highlight the selected chapter
            const chapterItems = document.querySelectorAll('.chapter-item');
            chapterItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-chapter-id') === chapterId) {
                    item.classList.add('active');
                }
            });
            
            // Update editor content
            elements.chapterTitle.textContent = chapter.title;
            elements.editorContent.innerHTML = chapter.content || '<p class="mb-4">Start writing your story here...</p>';
            
            // Reset dirty state
            appState.isDirty = false;
            updateSaveStatus(false);
            
            // Update word count
            updateWordCount();
        }

        async function createChapter(title, content, orderIndex) {
            try {
                if (!appState.currentProject) {
                    throw new Error('No current project');
                }
                
                showLoading('Creating chapter...');
                
                const { data: newChapter, error } = await chapters.create(
                    appState.currentProject.id,
                    title, 
                    content || '', 
                    orderIndex
                );
                
                if (error) throw error;
                
                if (!newChapter || newChapter.length === 0) {
                    throw new Error('Failed to create chapter');
                }
                
                // Reload chapters
                await loadChapters(appState.currentProject.id);
                
                // Select the new chapter
                selectChapter(newChapter[0]);
                
                hideLoading();
                
                return newChapter[0];
            } catch (error) {
                console.error('Error creating chapter:', error);
                hideLoading();
                return null;
            }
        }

        async function saveCurrentChapter() {
            try {
                if (!appState.currentChapter) return;
                
                // Get content from editor
                const content = elements.editorContent.innerHTML;
                
                // Update save button to indicate saving in progress
                elements.saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="ml-1 hidden md:inline">Saving...</span>';
                
                const { data: updatedChapter, error } = await chapters.update(
                    appState.currentChapter.id,
                    {
                        content: content,
                        updated_at: new Date().toISOString()
                    }
                );
                
                if (error) throw error;
                
                // Update both current chapter and cache
                appState.currentChapter = updatedChapter[0];
                appState.chapterCache.set(updatedChapter[0].id, updatedChapter[0]);
                
                // Reset dirty state
                appState.isDirty = false;
                
                // Update save button to indicate saved
                elements.saveBtn.classList.remove('btn-error');
                elements.saveBtn.classList.add('btn-monochrome');
                elements.saveBtn.innerHTML = '<i class="fas fa-save"></i><span class="ml-1 hidden md:inline">Save</span>';
                
                // Update project last edited time (backend will handle this)
                elements.lastEdited.textContent = 'Last edited: ' + formatDate(new Date());
                
                // Update word count
                updateWordCount();
                
                return updatedChapter[0];
            } catch (error) {
                console.error('Error saving chapter:', error);
                
                // Update save button to indicate error
                elements.saveBtn.classList.remove('btn-monochrome');
                elements.saveBtn.classList.add('btn-error');
                elements.saveBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i><span class="ml-1 hidden md:inline">Error</span>';
                
                // Show toast with error message
                showToast('Error saving chapter', 'error');
                
                return null;
            }
        }

        function updateSaveStatus(isDirty, message) {
            appState.isDirty = isDirty;
            
            // Update save button appearance based on dirty state
            if (isDirty) {
                elements.saveBtn.classList.remove('btn-monochrome');
                elements.saveBtn.classList.add('btn-error');
            } else {
                elements.saveBtn.classList.remove('btn-error');
                elements.saveBtn.classList.add('btn-monochrome');
            }
            
            // If message is provided, show it in a toast notification
            if (message) {
                showToast(message);
            }
        }

        // Context Management
        async function loadContextItems() {
            try {
                if (!appState.currentProject) return;
                
                // Load characters
                const { data: projectCharacters, error: charError } = await characters.getByProject(appState.currentProject.id);
                
                if (charError) throw charError;
                
                // TODO: Load settings and timeline events when those functions are implemented
                
                // Clear context list
                elements.contextList.innerHTML = '';
                
                // Count total context items
                const totalItems = (projectCharacters?.length || 0);
                elements.contextCount.textContent = totalItems + ' items';
                
                if (totalItems === 0) {
                    elements.contextList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-info-circle mr-2"></i>No context items yet</div>';
                    return;
                }
                
                // Add characters to the list
                if (projectCharacters && projectCharacters.length > 0) {
                    projectCharacters.forEach(character => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'p-2 text-sm hover:bg-gray-50 rounded cursor-pointer';
                        
                        itemElement.innerHTML = `
                            <div class="font-medium">${character.name}</div>
                            <div class="text-xs text-textSecondary">${character.role}</div>
                        `;
                        
                        elements.contextList.appendChild(itemElement);
                    });
                }
                
                // TODO: Add settings and timeline events to the list
            } catch (error) {
                console.error('Error loading context items:', error);
                elements.contextList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-exclamation-circle mr-2 text-error"></i>Error loading context</div>';
            }
        }

        // Show toast message
        function showToast(message, type = 'success') {
            const toast = document.getElementById('aiToast');
            if (!toast) return; // Exit if toast element isn't available
            
            const toastText = toast.querySelector('p');
            if (toastText) toastText.textContent = message;
            
            toast.classList.remove('hidden');
            toast.classList.add('transform', 'translate-y-0');
            
            if (type === 'success') {
                toast.classList.add('bg-success');
                toast.classList.remove('bg-error');
            } else {
                toast.classList.add('bg-error');
                toast.classList.remove('bg-success');
            }
            
            setTimeout(() => {
                toast.classList.add('translate-y-full');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('translate-y-full', 'bg-success', 'bg-error');
                }, 300);
            }, 3000);
        }

        // Toggle Load Project Panel
        function toggleLoadProjectPanel() {
            const panel = document.getElementById('loadProjectPanel');
            const overlay = document.getElementById('loadProjectOverlay');
            const isOpen = !panel.classList.contains('translate-x-full');

            if (isOpen) {
                panel.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            } else {
                panel.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            }
        }

        // Load User Projects
        async function loadUserProjects() {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading projects...</div>';

            try {
                const { data: userProjects, error } = await projects.getAll();
                
                if (error) throw error;

                if (!userProjects || userProjects.length === 0) {
                    projectsList.innerHTML = `
                        <div class="text-center text-gray-500">
                            <i class="fas fa-folder-open text-2xl mb-2"></i>
                            <p>No projects found</p>
                        </div>
                    `;
                    return;
                }

                // Sort projects by last updated
                userProjects.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

                // Create project list HTML
                projectsList.innerHTML = userProjects.map(project => `
                    <div class="project-item bg-white rounded-lg p-4 border border-gray-200 hover:border-primary cursor-pointer transition-colors"
                         data-project-id="${project.id}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-medium text-primary">${project.title}</h3>
                            ${project.id === appState.currentProject?.id ? 
                                '<span class="text-xs bg-primary text-white px-2 py-1 rounded">Current</span>' : 
                                ''}
                        </div>
                        <p class="text-sm text-gray-500 mb-2 line-clamp-2">${project.description || 'No description'}</p>
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <span>
                                <i class="fas fa-clock mr-1"></i>
                                ${formatDate(project.updated_at)}
                            </span>
                            <span>
                                <i class="fas fa-book mr-1"></i>
                                ${project.chapter_count || 0} chapters
                            </span>
                        </div>
                    </div>
                `).join('');

                // Add click handlers to project items
                document.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const projectId = item.dataset.projectId;
                        await switchProject(projectId);
                        toggleLoadProjectPanel();
                    });
                });

            } catch (error) {
                console.error('Error loading projects:', error);
                projectsList.innerHTML = `
                    <div class="text-center text-error">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Error loading projects</p>
                    </div>
                `;
            }
        }

        // Filter Projects
        function filterProjects(searchTerm) {
            const projectItems = document.querySelectorAll('.project-item');
            projectItems.forEach(item => {
                const title = item.querySelector('h3').textContent.toLowerCase();
                const description = item.querySelector('p').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Switch Project
        async function switchProject(projectId) {
            try {
                showLoading('Loading project...');

                // Save current project if there are unsaved changes
                if (appState.isDirty && appState.currentChapter) {
                    await saveCurrentChapter();
                }

                // Get the new project
                const { data: project, error } = await projects.getById(projectId);
                
                if (error) throw error;
                if (!project) throw new Error('Project not found');

                // Update app state
                appState.currentProject = project;
                appState.currentChapter = null;
                appState.isDirty = false;

                // Save the current project ID to localStorage
                localStorage.setItem('lastProjectId', project.id);

                // Update UI
                updateProjectUI(project);
                await loadChapters(project.id);
                await loadContextItems();

                hideLoading();
                showToast('Project loaded successfully', 'success');
            } catch (error) {
                console.error('Error switching project:', error);
                hideLoading();
                showToast('Error loading project', 'error');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // New Project Button
            if (elements.newProjectBtn) {
                elements.newProjectBtn.addEventListener('click', () => {
                    elements.newProjectModal.classList.remove('hidden');
                    elements.newProjectModal.classList.add('flex');
                    elements.newProjectTitle.focus();
                });
            }
            
            // Close New Project Modal
            if (elements.closeNewProjectModal) {
                elements.closeNewProjectModal.addEventListener('click', () => {
                    elements.newProjectModal.classList.add('hidden');
                    elements.newProjectModal.classList.remove('flex');
                });
            }
            
            // Cancel New Project
            if (elements.cancelNewProject) {
                elements.cancelNewProject.addEventListener('click', () => {
                    elements.newProjectModal.classList.add('hidden');
                    elements.newProjectModal.classList.remove('flex');
                });
            }
            
            // Create New Project
            if (elements.createNewProject) {
                elements.createNewProject.addEventListener('click', async () => {
                    const title = elements.newProjectTitle.value.trim();
                    const description = elements.newProjectDescription.value.trim();
                    
                    if (!title) {
                        alert('Please enter a project title');
                        return;
                    }
                    
                    elements.newProjectModal.classList.add('hidden');
                    elements.newProjectModal.classList.remove('flex');
                    
                    const newProject = await createProject(title, description);
                    
                    if (newProject) {
                        // Successfully created project
                        elements.newProjectTitle.value = '';
                        elements.newProjectDescription.value = '';
                    }
                });
            }
            
            // Add Chapter Button
            if (elements.addChapterBtn) {
                elements.addChapterBtn.addEventListener('click', async () => {
                    if (!appState.currentProject) {
                        alert('Please create a project first');
                        return;
                    }
                    
                    // Get the number of existing chapters
                    const chapterCount = elements.chaptersList.querySelectorAll('.chapter-item').length;
                    const newChapterTitle = `Chapter ${chapterCount + 1}`;
                    
                    await createChapter(newChapterTitle, '', chapterCount);
                });
            }
            
            // Save Button
            if (elements.saveBtn) {
                elements.saveBtn.addEventListener('click', () => {
                    if (appState.currentChapter) {
                        saveCurrentChapter();
                    }
                });
            }
            
            // Editor Content Change
            if (elements.editorContent) {
                elements.editorContent.addEventListener('input', () => {
                    updateSaveStatus(true);
                    updateWordCount();
                });
            }
            
            // Auto-save timer
            setInterval(() => {
                if (appState.isDirty && appState.currentChapter) {
                    saveCurrentChapter();
                }
            }, 60000); // Auto-save every minute if there are changes
            
            // Load Project Button
            if (elements.loadProjectBtn) {
                elements.loadProjectBtn.addEventListener('click', () => {
                    toggleLoadProjectPanel();
                    loadUserProjects();
                });
            }

            // Close Load Project Panel
            const closeLoadProjectPanel = document.getElementById('closeLoadProjectPanel');
            const loadProjectOverlay = document.getElementById('loadProjectOverlay');
            
            if (closeLoadProjectPanel) {
                closeLoadProjectPanel.addEventListener('click', toggleLoadProjectPanel);
            }
            
            if (loadProjectOverlay) {
                loadProjectOverlay.addEventListener('click', toggleLoadProjectPanel);
            }

            // Project Search
            const projectSearch = document.getElementById('projectSearch');
            if (projectSearch) {
                projectSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterProjects(searchTerm);
                });
            }

            // Formatting buttons
            const boldButton = document.querySelector('button[title="Bold"]');
            const italicButton = document.querySelector('button[title="Italic"]');
            const headingButton = document.querySelector('button[title="Heading"]');

            if (boldButton) {
                boldButton.addEventListener('click', () => {
                    document.execCommand('bold', false, null);
                    updateSaveStatus(true);
                });
            }

            if (italicButton) {
                italicButton.addEventListener('click', () => {
                    document.execCommand('italic', false, null);
                    updateSaveStatus(true);
                });
            }

            if (headingButton) {
                headingButton.addEventListener('click', () => {
                    const selection = window.getSelection();
                    if (!selection || selection.rangeCount === 0) return;
                    
                    const range = selection.getRangeAt(0);
                    const container = range.commonAncestorContainer.parentElement;
                    
                    // Create a new div for the heading
                    const headingDiv = document.createElement('div');
                    headingDiv.className = 'text-center text-2xl font-bold my-4';
                    
                    // If we're already in a centered heading, revert to normal
                    if (container.classList && container.classList.contains('text-center')) {
                        // Remove the heading formatting
                        const normalText = document.createElement('div');
                        normalText.innerHTML = container.innerHTML;
                        container.parentNode.replaceChild(normalText, container);
                    } else {
                        // Apply heading formatting
                        headingDiv.innerHTML = range.toString();
                        range.deleteContents();
                        range.insertNode(headingDiv);
                    }
                    
                    updateSaveStatus(true);
                });
            }

            // Font size button and dropdown
            const fontSizeBtn = document.querySelector('button[title="Font Size"]');
            const fontSizeDropdown = document.querySelector('.font-size-dropdown');
            
            // Toggle dropdown
            if (fontSizeBtn && fontSizeDropdown) {
                fontSizeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    fontSizeDropdown.classList.toggle('hidden');
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!fontSizeBtn.contains(e.target)) {
                        fontSizeDropdown.classList.add('hidden');
                    }
                });
                
                // Handle font size selection
                document.querySelectorAll('.font-size-dropdown button').forEach(button => {
                    button.addEventListener('click', () => {
                        const size = button.getAttribute('data-size');
                        document.execCommand('fontSize', false, size);
                        fontSizeDropdown.classList.add('hidden');
                        updateSaveStatus(true);
                    });
                });
            }

            // Full Screen button
            const fullScreenBtn = document.querySelector('button[title="Full Screen"]');
            if (fullScreenBtn) {
                fullScreenBtn.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            showToast(`Error attempting to enable full-screen mode: ${err.message}`, 'error');
                        });
                    } else {
                        document.exitFullscreen().catch(err => {
                            showToast(`Error attempting to exit full-screen mode: ${err.message}`, 'error');
                        });
                    }
                });
            }

            // Keyboard shortcuts for formatting
            if (elements && elements.editorContent) {
                elements.editorContent.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 'b':
                                e.preventDefault();
                                document.execCommand('bold', false, null);
                                updateSaveStatus(true);
                                break;
                            case 'i':
                                e.preventDefault();
                                document.execCommand('italic', false, null);
                                updateSaveStatus(true);
                                break;
                        }
                    }
                });
            }

            // Update formatting buttons state based on current selection
            function updateFormatButtons() {
                try {
                    const selection = window.getSelection();
                    if (!selection || selection.rangeCount === 0) return;
                    
                    const isBold = document.queryCommandState('bold');
                    const isItalic = document.queryCommandState('italic');
                    const container = selection.getRangeAt(0).commonAncestorContainer;
                    
                    if (!container) return;
                    
                    const isHeading = container.nodeType === 1 ? 
                        container.classList && container.classList.contains('text-center') : 
                        container.parentElement && container.parentElement.classList && 
                        container.parentElement.classList.contains('text-center');

                    const boldButton = document.querySelector('button[title="Bold"]');
                    const italicButton = document.querySelector('button[title="Italic"]');
                    const headingButton = document.querySelector('button[title="Heading"]');

                    if (boldButton) {
                        boldButton.classList.toggle('bg-primaryLight', isBold);
                    }
                    if (italicButton) {
                        italicButton.classList.toggle('bg-primaryLight', isItalic);
                    }
                    if (headingButton) {
                        headingButton.classList.toggle('bg-primaryLight', isHeading);
                    }
                } catch (error) {
                    console.warn('Error updating format buttons:', error);
                    // Silently fail without crashing the application
                }
            }

            // Add selectionchange event listener to update formatting buttons
            document.addEventListener('selectionchange', () => {
                if (elements && elements.editorContent && document.activeElement === elements.editorContent) {
                    updateFormatButtons();
                }
            });

            // Update format buttons when clicking in the editor
            if (elements && elements.editorContent) {
                elements.editorContent.addEventListener('click', updateFormatButtons);
                elements.editorContent.addEventListener('keyup', updateFormatButtons);
            }

            // Project title rename functionality
            function setupProjectTitleRename() {
                function handleProjectRename() {
                    const currentTitle = elements.projectTitle.textContent;
                    
                    // Create input for editing
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-full p-0 border-none focus:ring-0 bg-primaryLight rounded text-primary font-medium';
                    input.value = currentTitle;
                    
                    // Replace h2 with input
                    elements.projectTitle.replaceWith(input);
                    input.focus();
                    input.select();
                    
                    // Save on blur or Enter key
                    const saveProjectTitle = async () => {
                        const newTitle = input.value.trim();
                        if (newTitle && newTitle !== currentTitle && appState.currentProject) {
                            try {
                                // Update project title in database
                                const { data: updatedProject, error } = await projects.update(
                                    appState.currentProject.id,
                                    { title: newTitle }
                                );
                                
                                if (error) throw error;
                                
                                // Update local state
                                appState.currentProject = updatedProject[0];
                                showToast('Project renamed', 'success');
                            } catch (error) {
                                console.error('Error renaming project:', error);
                                showToast('Failed to rename project', 'error');
                            }
                        }
                        
                        // Restore h2 with updated or original title
                        const newH2 = document.createElement('h2');
                        newH2.id = 'projectTitle';
                        newH2.className = 'text-primary font-medium mb-1 cursor-pointer';
                        newH2.title = 'Double-click to rename';
                        newH2.textContent = newTitle || currentTitle;
                        input.replaceWith(newH2);
                        
                        // Update elements reference and reattach event listener
                        elements.projectTitle = newH2;
                        elements.projectTitle.addEventListener('dblclick', handleProjectRename);
                    };
                    
                    input.addEventListener('blur', saveProjectTitle);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveProjectTitle();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            const newH2 = document.createElement('h2');
                            newH2.id = 'projectTitle';
                            newH2.className = 'text-primary font-medium mb-1 cursor-pointer';
                            newH2.title = 'Double-click to rename';
                            newH2.textContent = currentTitle;
                            input.replaceWith(newH2);
                            
                            // Update elements reference and reattach event listener
                            elements.projectTitle = newH2;
                            elements.projectTitle.addEventListener('dblclick', handleProjectRename);
                        }
                    });
                }

                // Initial event listener attachment
                elements.projectTitle.addEventListener('dblclick', handleProjectRename);
            }

            // Call the setup function
            setupProjectTitleRename();
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check if user is authenticated
                const { data: { user } } = await auth.getUser();
                if (!user) {
                    window.location.href = '/auth/auth.html';
                    return;
                }
                
                appState.currentUser = user;
                
                // Elements and event listeners are already setup in the first DOMContentLoaded handler
                // No need to call setupEventListeners() here
                
                // Load projects
                await loadProjects();
                
                // Load context items
                await loadContextItems();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                hideLoading();
            }
        });
    </script>

    <script type="module">
        import { auth, profiles } from './lib/supabase.js';
        
        // Initialize with a default user avatar and handle sign out
        document.addEventListener('DOMContentLoaded', () => {
            const userAvatar = document.querySelector('#userAvatar');
            const userDisplayName = document.querySelector('#userDisplayName');
            const signOutBtn = document.querySelector('#signOutBtn');
            
            // Update user info if authenticated
            auth.getUser().then(async ({ data: { user } }) => {
                if (user && userAvatar) {
                    try {
                        // Get user profile data
                        const { data: profile, error } = await profiles.get();
                        
                        // Update display name with first name if available
                        if (userDisplayName) {
                            if (profile && profile.first_name) {
                                userDisplayName.textContent = profile.first_name;
                            } else {
                                // Fallback to email
                                userDisplayName.textContent = user.email.split('@')[0];
                            }
                        }
                        
                        // Update avatar with first letter of name or email
                        const nameInitial = profile?.first_name ? profile.first_name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                        userAvatar.src = `https://ui-avatars.com/api/?name=${nameInitial}&background=4B5EAA&color=fff`;
                        
                        // If we have a profile picture URL, use it
                        if (profile?.profile_picture_url) {
                            userAvatar.src = profile.profile_picture_url;
                        }
                    } catch (error) {
                        console.error('Error loading user profile:', error);
                        // Fallback to email-based display
                        if (userDisplayName) {
                            userDisplayName.textContent = user.email.split('@')[0];
                        }
                        userAvatar.src = `https://ui-avatars.com/api/?name=${user.email.charAt(0)}&background=4B5EAA&color=fff`;
                    }
                }
            }).catch(error => {
                console.error('Auth check error:', error);
            });
            
            // Add sign out handler
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                        window.location.href = '/auth/auth.html';
                    } catch (error) {
                        console.error('Error signing out:', error);
                        alert('Failed to sign out. Please try again.');
                    }
                });
            }
        });
    </script>

    <!-- Top Bar -->
    <header class="h-16 bg-white border-b border-gray-100 flex items-center justify-between px-4 shadow-sm-custom">
        <div class="flex items-center space-x-2">
            <!-- Mobile Menu Button -->
            <button id="mobileMenuBtn" class="mobile-icon-btn text-gray-500 hover:text-primary cursor-pointer" data-shadcn="button" data-variant="ghost" data-size="icon">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-icon-btn bg-primary text-white rounded-md flex items-center justify-center">
                <i class="fas fa-feather-alt"></i>
            </div>
            <h1 class="text-xl font-semibold text-black dark:text-white hidden md:block">Kalligram</h1>
        </div>
        <div class="flex items-center space-x-2">
            <button id="saveBtn" class="mobile-icon-btn bg-primary-light" data-shadcn="button" data-variant="monochrome" title="Save">
                <i class="fas fa-save"></i>
                <span class="ml-1 hidden md:inline">Save</span>
            </button>
            <button id="loadProjectBtn" class="mobile-icon-btn bg-primary-light" data-shadcn="button" data-variant="monochrome" title="Load Project">
                <i class="fas fa-folder-open"></i>
                <span class="ml-1 hidden md:inline">Load Project</span>
            </button>
            <button id="newProjectBtn" class="mobile-icon-btn bg-success" data-shadcn="button" data-variant="monochrome" title="New Project">
                <i class="fas fa-plus"></i>
                <span class="ml-1 hidden md:inline">New Project</span>
            </button>
            <button id="userProfileBtn" class="mobile-icon-btn bg-primary">
                <span class="text-lg font-bold text-white">R</span>
                <span class="ml-1 hidden md:inline mobile-hidden">Profile</span>
            </button>
            <div class="relative group hidden" id="profileDropdownContainer">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=Guest&background=4B5EAA&color=fff" 
                     alt="User Avatar" 
                     class="w-9 h-9 rounded-full cursor-pointer border-2 border-white hover:border-primary transition-colors">
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-md-custom p-2 profile-dropdown">
                    <a href="/profile.html" class="block">
                        <div class="p-2 hover:bg-gray-50 rounded cursor-pointer flex items-center">
                            <i class="fas fa-user-circle text-primary mr-2"></i>
                            <span id="userDisplayName">Guest User</span>
                        </div>
                    </a>
                    <a href="/profile.html#preferences" class="block">
                        <div class="p-2 hover:bg-gray-50 rounded cursor-pointer flex items-center">
                            <i class="fas fa-cog text-secondary mr-2"></i>
                            <span>Settings</span>
                        </div>
                    </a>
                    <!-- Dark mode toggle switch will be inserted here by initializeDarkModeSwitch() -->
                    <div id="signOutBtn" class="p-2 hover:bg-gray-50 rounded cursor-pointer flex items-center text-error">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span>Sign Out</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay (for mobile) -->
    <div id="sidebarOverlay" class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40 hidden" style="display: none;"></div>

    <!-- Load Project Panel -->
    <div id="loadProjectPanel" class="fixed right-0 top-0 h-screen w-96 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="h-full flex flex-col">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-primary">Load Project</h2>
                    <button id="closeLoadProjectPanel" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="relative">
                    <input type="text" id="projectSearch" class="w-full border border-gray-200 rounded-lg pl-10 pr-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Search projects...">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <div id="projectsList" class="space-y-3">
                    <!-- Projects will be loaded here -->
                    <div class="text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading projects...
                </div>
            </div>
        </div>
        </div>
            </div>

    <!-- Project Panel Overlay -->
    <div id="loadProjectOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar h-full overflow-y-auto p-4">
            <!-- Project Info -->
            <div class="mb-6">
                <div class="bg-white rounded-lg p-3 shadow-sm-custom mb-4">
                    <h2 id="projectTitle" class="text-black dark:text-white font-medium mb-1 cursor-pointer" title="Double-click to rename">Loading project...</h2>
                    <div class="flex items-center text-xs text-textSecondary">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="lastEdited">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Chapters -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-secondary">Chapters</h2>
                    <button class="text-primary hover:text-opacity-80" title="Collapse All">
                        <i class="fas fa-compress-alt"></i>
                    </button>
                </div>
                <div id="chaptersList" class="space-y-1">
                    <!-- Chapters will be loaded here dynamically -->
                    <div class="text-center p-2 text-textSecondary text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading chapters...
                </div>
                </div>
                <button id="addChapterBtn" class="btn btn-monochrome w-full mt-6" data-shadcn="button" data-variant="monochrome">
                    <i class="fas fa-plus"></i>
                    <span class="ml-2 hidden md:inline mobile-hidden">Add Chapter</span>
                </button>
            </div>

            <!-- Context Manager -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-secondary">Story Context</h2>
                    <span id="contextCount" class="text-xs text-textSecondary">0 items</span>
                </div>
                <div class="bg-white rounded-lg p-2 shadow-sm-custom mb-3">
                    <div id="contextList" class="space-y-1">
                        <!-- Context items will be loaded here -->
                        <div class="text-center p-2 text-textSecondary text-sm">
                            <i class="fas fa-info-circle mr-2"></i>No context items yet
                        </div>
                    </div>
                </div>
                <!-- Context Manager Button -->
                <button id="manageContextBtn" class="btn btn-monochrome w-full" data-shadcn="button" data-variant="monochrome">
                    <i class="fas fa-brain"></i>
                    <span class="ml-2 hidden md:inline mobile-hidden">Manage Context</span>
                </button>
            </div>

            <!-- Export Button -->
            <div class="mb-6">
                <button id="exportPdfBtn" class="btn btn-monochrome w-full" data-shadcn="button" data-variant="monochrome">
                    <i class="fas fa-file-pdf"></i>
                    <span class="ml-2 hidden md:inline mobile-hidden">Export PDF</span>
                </button>
            </div>

            <!-- Word Count -->
            <div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm-custom text-sm">
                <div>
                    <div class="text-textSecondary">Total Words</div>
                    <div id="wordCount" class="text-xl font-semibold text-black dark:text-white">0</div>
                </div>
                <div class="h-12 w-12 relative">
                    <svg class="w-full h-full" viewBox="0 0 36 36">
                        <circle cx="18" cy="18" r="16" fill="none" stroke="#E6E9F0" stroke-width="2"></circle>
                        <circle id="wordCountProgress" cx="18" cy="18" r="16" fill="none" stroke="#4B5EAA" stroke-width="2" stroke-dasharray="0 100" stroke-dashoffset="0" transform="rotate(-90 18 18)"></circle>
                    </svg>
                    <div id="wordCountPercent" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-medium text-primary">0%</div>
                </div>
            </div>
        </aside>

        <!-- Editor Area -->
        <main class="flex-1 overflow-hidden flex flex-col bg-white">
            <!-- Editor Toolbar -->
            <div class="bg-white border-b border-gray-100 p-2 flex items-center space-x-2 shadow-sm-custom editor-toolbar">
                <!-- Formatting buttons grouped together -->
                <div class="flex items-center space-x-2">
                    <button class="mobile-icon-btn bg-gray-50" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="mobile-icon-btn bg-gray-50" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="mobile-icon-btn bg-gray-50" title="Heading">
                        <i class="fas fa-heading"></i>
                    </button>
                    <div class="relative">
                        <button class="mobile-icon-btn bg-gray-50" title="Font Size">
                            <i class="fas fa-text-height"></i>
                        </button>
                        <div class="font-size-dropdown hidden absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-10">
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="1">Small</button>
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="3">Normal</button>
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="5">Large</button>
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="7">Huge</button>
                        </div>
                    </div>
                </div>
                
                <!-- AI Assistant Button (right-aligned) -->
                <button id="aiAssistBtn" class="bg-primary text-white rounded-md py-2 px-4 flex items-center justify-center text-sm transform transition-transform hover:scale-105 active:scale-95 ml-auto" data-shadcn="button" data-variant="primary">
                    <i class="fas fa-robot mr-2"></i>
                    <span class="md:inline mobile-hidden">AI Assist</span>
                </button>
                
                <!-- Full Screen button -->
                <button class="mobile-icon-btn bg-gray-50" title="Full Screen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>

            <!-- AI Assistant Panel -->
            <div id="aiAssistPanel" class="fixed right-0 top-0 h-screen w-[400px] bg-white shadow-md-custom transform translate-x-full transition-transform duration-300 z-50 flex flex-col" role="complementary" aria-label="AI Assistant">
                <!-- Panel Header -->
                <div class="flex-shrink-0 p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-primary">AI Assistant</h2>
                        <button id="closeAiPanel" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
            </div>

                    <!-- Mode Toggle -->
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-3">
                        <button class="ai-mode-btn flex-1 py-1 px-2 text-sm font-medium rounded active" data-mode="generate">Generate</button>
                        <button class="ai-mode-btn flex-1 py-1 px-2 text-sm font-medium rounded" data-mode="chat">Chat</button>
                    </div>
                    
                    <!-- Model Selector -->
                    <select id="aiModel" class="w-full bg-primaryLight text-primary rounded-lg p-2 text-sm">
                        <!-- DeepSeek Model -->
                        <option value="deepseek-chat">DeepSeek Chat (V3) - Featured</option>
                        
                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ Claude 3 Models â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        <!-- Claude 3 Models via OpenRouter -->
                        <option value="claude-opus">Claude 3 Opus - Most Powerful</option>
                        <option value="claude-sonnet">Claude 3 Sonnet - Ultra Balanced</option>
                        
                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ Free Models â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        <!-- Free Models via OpenRouter -->
                        <option value="qwen3-235b">QWEN3 235B - Powerful & Free</option>
                    </select>
                </div>

                <!-- Context Selection Panel -->
                <div class="flex-shrink-0 bg-primaryLight/20 p-3 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-medium text-secondary">Story Context</span>
                        <button id="toggleContextBtn" class="text-xs text-primary hover:text-primary/80">
                            <i class="fas fa-chevron-down mr-1"></i>Show/Hide
                        </button>
                    </div>
                    
                    <!-- Selected context items summary -->
                    <div id="contextSummary" class="text-sm text-primary mt-1">
                        No context items selected
                    </div>
                    
                    <!-- Context selection panel (collapsed by default) -->
                    <div id="contextSelectionPanel" class="hidden mt-3 border-t border-gray-200 pt-3">
                        <!-- Characters section -->
                        <div class="mb-3">
                            <h3 class="text-xs font-medium text-secondary mb-1">Characters</h3>
                            <div id="characterContextItems" class="space-y-1 max-h-24 overflow-y-auto">
                                <div class="text-xs text-gray-500 italic">Loading characters...</div>
                            </div>
                        </div>
                        
                        <!-- Locations section -->
                        <div class="mb-3">
                            <h3 class="text-xs font-medium text-secondary mb-1">Locations</h3>
                            <div id="locationContextItems" class="space-y-1 max-h-24 overflow-y-auto">
                                <div class="text-xs text-gray-500 italic">Loading locations...</div>
                            </div>
                        </div>
                        
                        <!-- Timeline events section -->
                        <div>
                            <h3 class="text-xs font-medium text-secondary mb-1">Timeline Events</h3>
                            <div id="timelineContextItems" class="space-y-1 max-h-24 overflow-y-auto">
                                <div class="text-xs text-gray-500 italic">Loading events...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat View -->
                <div id="chatView" class="flex-1 flex flex-col hidden overflow-hidden">
                    <!-- Chat History (now at top) -->
                    <div id="chatHistory" class="flex-1 overflow-y-auto">
                        <!-- Example messages will be added here -->
                    </div>
                    
                    <!-- Chat Input (now at bottom) -->
                    <div class="flex-shrink-0 p-4 border-t border-gray-200">
                        <div class="relative">
                            <textarea id="chatInput" class="w-full min-h-[100px] max-h-[200px] border border-gray-200 rounded-lg p-3 pr-10 focus:border-primary focus:ring-1 focus:ring-primary outline-none resize-none" placeholder="Ask the AI..."></textarea>
                            <button id="chatSubmit" class="absolute right-3 top-3 text-primary hover:text-primary/80 disabled:opacity-50">
                                <i class="fas fa-paper-plane"></i>
                            </button>
            </div>

                        <!-- Token usage info for DeepSeek models -->
                        <div id="tokenUsageInfo" class="text-xs text-gray-500 mt-2 hidden">
                            <span>Token usage: <span id="promptTokens">0</span> prompt + <span id="completionTokens">0</span> completion = <span id="totalTokens">0</span> total</span>
                </div>
            </div>
        </div>

                <!-- Generate/Edit View -->
                <div id="generateEditView" class="flex-1 flex flex-col overflow-hidden">
                    <!-- Output Area (now at top) -->
                    <div id="aiOutput" class="flex-1 bg-gray-50 rounded-lg m-4 py-1 px-6 overflow-y-auto">
                        <p class="text-gray-400 text-sm italic m-0">AI output will appear here...</p>
                    </div>

                    <!-- Controls (in middle) -->
                    <div class="flex-shrink-0 space-y-3 px-4">
                        <div>
                            <label class="text-sm font-medium block mb-2">Tone</label>
                            <select id="aiTone" class="w-full border border-gray-200 rounded-lg p-2 text-sm">
                                <option>Suspenseful</option>
                                <option>Humorous</option>
                                <option>Dramatic</option>
                                <option>Reflective</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium block mb-2">Length</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">Short</span>
                                <input type="range" id="aiLength" min="50" max="500" value="200" class="flex-grow">
                                <span class="text-xs text-gray-500">Long</span>
                    </div>
                        </div>
                    </div>

                    <!-- Input Area (now at bottom) -->
                    <div class="flex-shrink-0 p-4 border-t border-gray-200">
                        <div class="relative">
                            <textarea id="aiInput" class="w-full min-h-[100px] max-h-[200px] border border-gray-200 rounded-lg p-3 pr-10 focus:border-primary focus:ring-1 focus:ring-primary outline-none resize-none" placeholder="Write a scene with Jane..."></textarea>
                            <button id="aiSubmit" class="absolute right-3 top-3 text-primary hover:text-primary/80 disabled:opacity-50">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                </div>

            <!-- Mobile Overlay (shown on small screens) -->
            <div id="aiMobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

            <!-- Toast Notification -->
            <div id="aiToast" class="fixed bottom-4 right-4 bg-success text-white p-3 rounded-lg shadow-md-custom hidden transform transition-transform duration-300">
                <p class="text-sm"></p>
            </div>

            <!-- Editor Content -->
            <div class="flex-1 overflow-y-auto p-8 bg-white">
                <div id="editorContent" class="editor-content max-w-3xl mx-auto" contenteditable="true">
                    <h1 id="chapterTitle" class="text-3xl font-bold mb-6">Loading chapter...</h1>
                    <p class="mb-4 placeholder-text">Select a chapter to start writing, or create a new one.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Preview Modal (Hidden by default) -->
    <div class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center modal" id="aiModal">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 shadow-md-custom fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-primary">AI Suggestion</h2>
                <button class="text-gray-400 hover:text-gray-600" id="closeModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="bg-gray-50 p-5 rounded-lg mb-5 border border-gray-100">
                <p class="text-gray-700 leading-relaxed">The city lights twinkled below as John gazed out from his apartment window. Tomorrow would mark one year since the accident changed everything. He sighed, knowing that returning to New York had been necessary, even if every street corner held a memory he'd rather forget.</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-5">
                        <div>
                    <label class="text-sm font-medium block mb-2">Tone</label>
                    <select class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                        <option>Suspenseful</option>
                        <option>Humorous</option>
                        <option>Dramatic</option>
                        <option>Reflective</option>
                    </select>
                        </div>
                <div>
                    <label class="text-sm font-medium block mb-2">Length</label>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Short</span>
                        <input type="range" min="50" max="500" value="200" class="flex-grow">
                        <span class="text-xs text-gray-500">Long</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i>
                    Regenerate
                </button>
                <button class="btn btn-error">
                    <i class="fas fa-times"></i>
                    Reject
                </button>
                <button class="btn btn-success">
                    <i class="fas fa-check"></i>
                    Accept
                </button>
        </div>
        </div>
    </div>

    <!-- Context Manager Modal (Hidden by default) -->
    <div class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center modal" id="contextModal">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 shadow-md-custom fade-in overflow-y-auto max-h-[90vh]">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-primary">Manage Story Context</h2>
                <button class="text-gray-400 hover:text-gray-600" id="closeContextModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="border-b border-gray-200 mb-4">
                <div class="flex space-x-2">
                    <button class="px-4 py-2 border-b-2 border-primary text-primary font-medium context-tab" data-tab="protagonists">Characters</button>
                    <button class="px-4 py-2 border-b-2 border-transparent hover:text-primary context-tab" data-tab="settings">Settings</button>
                    <button class="px-4 py-2 border-b-2 border-transparent hover:text-primary context-tab" data-tab="timeline">Timeline</button>
                    <button class="px-4 py-2 border-b-2 border-transparent hover:text-primary context-tab" data-tab="other">Other</button>
                </div>
            </div>

            <!-- Context Items List -->
                        <div class="mb-4">
                <!-- Character Tree View (for Characters tab) -->
                <div id="characterTreeView" class="bg-white rounded-lg p-3 shadow-sm-custom">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-primary">Characters Network</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-textSecondary">3 characters</span>
                            <button class="btn btn-primary text-xs py-1 px-2" id="newCharacterBtn">
                                <i class="fas fa-plus text-xs mr-1"></i>
                                New Character
                            </button>
                        </div>
                    </div>
                    <div class="character-tree relative" id="characterTreeContainer">
                        <!-- Character nodes will be placed here dynamically -->
                        <div class="character-node protagonist" style="top: 50px; left: 50%;" data-name="John Doe" data-role="Protagonist">
                            <div class="font-medium text-center">John</div>
                            <div class="character-tooltip">
                                <div class="font-bold text-primary mb-1">John Doe</div>
                                <div class="text-xs text-textSecondary mb-2">Protagonist</div>
                                <div class="text-sm">Brave, curious explorer who survived an accident in New York.</div>
                </div>
                    </div>
                        <div class="character-node antagonist" style="top: 150px; left: 30%;" data-name="Mystery Figure" data-role="Antagonist">
                            <div class="font-medium text-center">Mystery</div>
                            <div class="character-tooltip">
                                <div class="font-bold text-primary mb-1">Mystery Figure</div>
                                <div class="text-xs text-textSecondary mb-2">Antagonist</div>
                                <div class="text-sm">Unknown entity connected to the accident, with hidden motives.</div>
                        </div>
                    </div>
                        <div class="character-node supporting" style="top: 150px; left: 70%;" data-name="Sarah" data-role="Supporting">
                            <div class="font-medium text-center">Sarah</div>
                            <div class="character-tooltip">
                                <div class="font-bold text-primary mb-1">Sarah</div>
                                <div class="text-xs text-textSecondary mb-2">Supporting Character</div>
                                <div class="text-sm">John's friend who helps him navigate his return to the city.</div>
                </div>
                        </div>
                        <!-- Character links -->
                        <div class="character-link" style="width: 150px; top: 80px; left: 50%; transform: rotate(45deg);"></div>
                        <div class="character-link" style="width: 150px; top: 80px; left: 50%; transform: rotate(-45deg);"></div>
                        
                        <!-- Network area interaction overlay -->
                        <div id="networkInteractionOverlay" class="absolute inset-0 cursor-pointer hidden">
                            <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-md-custom p-3 text-center">
                                <button class="btn btn-primary text-sm" id="addCharacterFromNetworkBtn">
                                    <i class="fas fa-plus mr-1"></i>
                                    Add Character Here
                                </button>
                        </div>
                    </div>
                </div>
                    <div class="text-center mt-4">
                        <div class="flex justify-center space-x-4">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-primary mr-1"></div>
                                <span class="text-xs">Protagonist</span>
            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-error mr-1"></div>
                                <span class="text-xs">Antagonist</span>
        </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-accent mr-1"></div>
                                <span class="text-xs">Supporting</span>
            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-secondary mr-1"></div>
                                <span class="text-xs">Minor</span>
                    </div>
                        </div>
                    </div>
                </div>

                <!-- Regular List View (for other tabs) -->
                <div id="regularListView" class="bg-primaryLight p-3 rounded-lg hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-primary">Current Items</h3>
                        <span class="text-xs text-textSecondary" id="contextItemCount">3 items</span>
                    </div>
                    <div class="space-y-1 max-h-32 overflow-y-auto" id="contextItemsList">
                        <div class="p-2 text-sm bg-white rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium">John Doe</div>
                                <div class="text-xs text-textSecondary">Protagonist</div>
                    </div>
                            <div>
                                <button class="text-primary hover:text-opacity-80 mr-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-error hover:text-opacity-80" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                </div>
                    </div>
                        <div class="p-2 text-sm bg-white rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium">New York City</div>
                                <div class="text-xs text-textSecondary">Setting</div>
                    </div>
                            <div>
                                <button class="text-primary hover:text-opacity-80 mr-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-error hover:text-opacity-80" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                </div>
                    </div>
                        <div class="p-2 text-sm bg-white rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium">The Accident</div>
                                <div class="text-xs text-textSecondary">Timeline</div>
                            </div>
                            <div>
                                <button class="text-primary hover:text-opacity-80 mr-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-error hover:text-opacity-80" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

            <!-- Form containers for each tab -->
            <div id="protagonistsForm" class="context-form-container hidden">
                <div id="characterFormHeader" class="bg-primaryLight p-3 mb-4 rounded-lg">
                    <h3 class="text-primary font-medium" id="characterFormTitle">Add New Character</h3>
                    <p class="text-sm text-secondary">Fill in the details below to add a character to your story.</p>
                    </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-medium block mb-2">Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Character name" id="protagonistName">
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Role <span class="text-error">*</span></label>
                        <select class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" id="protagonistRole">
                            <option value="Protagonist">Protagonist</option>
                            <option value="Antagonist">Antagonist</option>
                            <option value="Supporting">Supporting Character</option>
                            <option value="Minor">Minor Character</option>
                        </select>
                </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Traits</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Character traits (e.g., brave, curious, impulsive)" id="protagonistTraits"></textarea>
            </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Relationships</label>
                        <div class="bg-gray-50 rounded-lg p-2 h-auto">
                            <div class="text-xs text-textSecondary mb-2">Connected to:</div>
                            <div id="relationshipList" class="space-y-1 mb-3">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-primary mr-2"></div>
                                        <span>John Doe (Protagonist)</span>
        </div>
                                    <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-error mr-2"></div>
                                        <span>Mystery Figure (Antagonist)</span>
                                    </div>
                                    <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 pt-2">
                                <div class="text-xs text-textSecondary mb-1">Add Relationship:</div>
                                <div class="flex space-x-2">
                                    <select id="newRelationshipSelect" class="text-sm flex-grow border border-gray-200 rounded-lg p-1 focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                                        <option value="">Select a character...</option>
                                        <option value="John Doe">John Doe (Protagonist)</option>
                                        <option value="Mystery Figure">Mystery Figure (Antagonist)</option>
                                        <option value="Sarah">Sarah (Supporting)</option>
                                    </select>
                                    <button id="addRelationshipBtn" class="btn btn-primary py-1 px-2 text-xs">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Backstory</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Character's history and background" id="protagonistBackstory"></textarea>
                    </div>
                </div>

                <div class="bg-primaryLight p-3 rounded-lg mb-4">
                    <div class="text-sm font-medium mb-2">Character Position in Network</div>
                    <p class="text-xs text-textSecondary mb-3">Characters are automatically positioned in the network based on their relationships. Protagonists are placed in the center, with other characters connected to them.</p>
                    <div class="flex space-x-4">
                        <div class="w-5 h-5 rounded-full bg-primary"></div>
                        <div class="w-5 h-5 rounded-full bg-error"></div>
                        <div class="w-5 h-5 rounded-full bg-accent"></div>
                        <div class="w-5 h-5 rounded-full bg-secondary"></div>
                    </div>
                    <div class="flex space-x-4 text-xs mt-1">
                        <div>Protagonist</div>
                        <div>Antagonist</div>
                        <div>Supporting</div>
                        <div>Minor</div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button class="btn btn-error" id="cancelCharacterBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                </button>
                    <button class="btn btn-success" id="saveCharacterBtn">
                        <i class="fas fa-save"></i>
                        Save Character
                    </button>
        </div>
            </div>

            <div id="settingsForm" class="context-form-container hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                        <label class="text-sm font-medium block mb-2">Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Setting name (e.g., Darkwood Forest)" id="settingName">
                </div>
                <div>
                        <label class="text-sm font-medium block mb-2">Type</label>
                        <select class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" id="settingType">
                            <option value="Location">Location</option>
                            <option value="Building">Building</option>
                            <option value="City">City</option>
                            <option value="Country">Country</option>
                            <option value="Planet">Planet</option>
                            <option value="Other">Other</option>
                        </select>
                </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Description <span class="text-error">*</span></label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Setting description" id="settingDescription"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Key Features</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Notable features (e.g., haunted, foggy, ancient)" id="settingFeatures"></textarea>
                    </div>
                </div>
            </div>

            <div id="timelineForm" class="context-form-container hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                        <label class="text-sm font-medium block mb-2">Event Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Event name" id="timelineEventName">
                </div>
                <div>
                        <label class="text-sm font-medium block mb-2">Date/Time</label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="e.g., Full moon, 2025, Day 3" id="timelineDateTime">
                </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Description <span class="text-error">*</span></label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="What happened in this event" id="timelineDescription"></textarea>
            </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Significance</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Why this event matters to the story (e.g., turning point, revelation)" id="timelineSignificance"></textarea>
                </div>
            </div>
        </div>

            <div id="otherForm" class="context-form-container hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-medium block mb-2">Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Item name" id="otherName">
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Type</label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="e.g., Theme, Object, Faction" id="otherType">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Description <span class="text-error">*</span></label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-24" placeholder="Description" id="otherDescription"></textarea>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button class="btn btn-error" id="deleteContextBtn">
                    <i class="fas fa-trash"></i>
                    Delete
                </button>
                <button class="btn btn-secondary" id="cancelContextBtn">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn btn-success" id="saveContextBtn">
                    <i class="fas fa-save"></i>
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Simple JS for Modal Toggle (Demo Only) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Select elements
            const contextModal = document.getElementById('contextModal');
            const manageContextBtn = document.getElementById('manageContextBtn');
            const closeContextModalBtn = document.getElementById('closeContextModal');
            const cancelContextBtn = document.getElementById('cancelContextBtn');
            const saveContextBtn = document.getElementById('saveContextBtn');
            const deleteContextBtn = document.getElementById('deleteContextBtn');
            const contextTabs = document.querySelectorAll('.context-tab');
            const contextForms = document.querySelectorAll('.context-form-container');
            const characterTreeView = document.getElementById('characterTreeView');
            const regularListView = document.getElementById('regularListView');
            const characterFormContainer = document.getElementById('protagonistsForm');
            const newCharacterBtn = document.getElementById('newCharacterBtn');
            const cancelCharacterBtn = document.getElementById('cancelCharacterBtn');
            const saveCharacterBtn = document.getElementById('saveCharacterBtn');
            const networkInteractionOverlay = document.getElementById('networkInteractionOverlay');
            const addCharacterFromNetworkBtn = document.getElementById('addCharacterFromNetworkBtn');
            const characterFormTitle = document.getElementById('characterFormTitle');
            const newRelationshipSelect = document.getElementById('newRelationshipSelect');
            const addRelationshipBtn = document.getElementById('addRelationshipBtn');
            const relationshipList = document.getElementById('relationshipList');
            
            // Current editing state
            let currentlyEditing = null;
            let networkClickPosition = { x: 0, y: 0 };
            
            // Show context modal when manage context button is clicked
            manageContextBtn.addEventListener('click', function() {
                window.location.href = 'context.html';
            });
            
            // Close context modal
            function closeContextModal() {
                contextModal.style.display = 'none';
                currentlyEditing = null;
                resetForms();
                // Hide character form
                characterFormContainer.classList.add('hidden');
            }
            
            closeContextModalBtn.addEventListener('click', closeContextModal);
            cancelContextBtn.addEventListener('click', closeContextModal);
            
            // Toggle between character tree and regular views based on tab
            function toggleContextView(tabName) {
                if (tabName === 'protagonists') {
                    // Show character tree view for 'Characters' tab
                    characterTreeView.classList.remove('hidden');
                    regularListView.classList.add('hidden');
                    
                    // Hide character form by default
                    characterFormContainer.classList.add('hidden');
                    
                    // Refresh character tree (if needed)
                    refreshCharacterTree();
                    } else {
                    // Show regular list view for other tabs
                    characterTreeView.classList.add('hidden');
                    regularListView.classList.remove('hidden');
                }
            }
            
            // Show the character form for new character
            function showNewCharacterForm() {
                // Reset any previous values
                resetCharacterForm();
                
                // Set the form title for new character
                characterFormTitle.textContent = 'Add New Character';
                
                // Show the character form
                characterFormContainer.classList.remove('hidden');
                
                // Not currently editing an existing character
                currentlyEditing = null;
                
                // Update delete button state
                updateDeleteButtonState();
                
                // Update relationship select
                updateRelationshipSelect();
            }
            
            // Show the character form for editing an existing character
            function showEditCharacterForm(character) {
                // Fill the form with character data
                document.getElementById('protagonistName').value = character.name;
                document.getElementById('protagonistRole').value = character.role;
                document.getElementById('protagonistTraits').value = character.traits || '';
                document.getElementById('protagonistBackstory').value = character.backstory || '';
                
                // Clear existing relationships
                relationshipList.innerHTML = '';
                
                // Add existing relationships to the form
                const relationships = character.relationships || [];
                if (relationships.length > 0) {
                    // Get all character nodes to get their roles and colors
                    const characterNodes = document.querySelectorAll('.character-node');
                    
                    relationships.forEach(relatedName => {
                        // Find the related character node to get its role
                        const relatedNode = Array.from(characterNodes).find(node => 
                            node.getAttribute('data-name') === relatedName);
                        
                        if (relatedNode) {
                            const relatedRole = relatedNode.getAttribute('data-role');
                            
                            // Determine color based on character role
                            let colorClass = 'bg-primary'; // default
                            if (relatedRole === 'Antagonist') {
                                colorClass = 'bg-error';
                            } else if (relatedRole === 'Supporting') {
                                colorClass = 'bg-accent';
                            } else if (relatedRole === 'Minor') {
                                colorClass = 'bg-secondary';
                            }
                            
                            // Create relationship element
                            const relationshipEl = document.createElement('div');
                            relationshipEl.className = 'flex items-center justify-between text-sm';
                            relationshipEl.innerHTML = `
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full ${colorClass} mr-2"></div>
                                    <span>${relatedName} (${relatedRole})</span>
                                </div>
                                <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            
                            // Add to list
                            relationshipList.appendChild(relationshipEl);
                        }
                    });
                    
                    // Add delete handlers
                    initRelationshipDeleteButtons();
                }
                
                // Set the form title for editing
                characterFormTitle.textContent = 'Edit Character: ' + character.name;
                
                // Show the character form
                characterFormContainer.classList.remove('hidden');
                
                // Set currently editing
                currentlyEditing = character;
                
                // Update delete button state
                updateDeleteButtonState();
                
                // Update relationship select
                updateRelationshipSelect();
            }
            
            // Reset the character form
            function resetCharacterForm() {
                document.getElementById('protagonistName').value = '';
                document.getElementById('protagonistRole').value = 'Protagonist';
                document.getElementById('protagonistTraits').value = '';
                document.getElementById('protagonistBackstory').value = '';
                
                // Clear existing relationships
                relationshipList.innerHTML = '';
            }
            
            // New Character button click handler
            newCharacterBtn.addEventListener('click', function() {
                showNewCharacterForm();
            });
            
            // Cancel Character button click handler
            cancelCharacterBtn.addEventListener('click', function() {
                characterFormContainer.classList.add('hidden');
                currentlyEditing = null;
            });
            
            // Character network background click handler
            document.getElementById('characterTreeContainer').addEventListener('click', function(e) {
                // Only register clicks directly on the container (not on nodes)
                if (e.target === this || e.target === networkInteractionOverlay) {
                    // Store the click position for potential character placement
                    const rect = this.getBoundingClientRect();
                    networkClickPosition = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                    
                    // Show the interaction overlay
                    networkInteractionOverlay.style.display = 'block';
                    
                    // Position the overlay interaction button near the click
                    const overlayBtn = networkInteractionOverlay.querySelector('div');
                    overlayBtn.style.left = networkClickPosition.x + 'px';
                    overlayBtn.style.top = networkClickPosition.y + 'px';
                }
            });
            
            // Add Character from Network button click handler
            addCharacterFromNetworkBtn.addEventListener('click', function() {
                // Hide the overlay
                networkInteractionOverlay.style.display = 'none';
                
                // Show the new character form
                showNewCharacterForm();
            });
            
            // Hide network overlay when clicking anywhere else
            document.addEventListener('click', function(e) {
                // If click is outside the network container, hide the overlay
                if (!e.target.closest('#characterTreeContainer')) {
                    networkInteractionOverlay.style.display = 'none';
                }
            });
            
            // Handle tab switching
            contextTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    contextTabs.forEach(t => {
                        t.classList.remove('border-primary', 'text-primary', 'font-medium');
                        t.classList.add('border-transparent');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('border-primary', 'text-primary', 'font-medium');
                    this.classList.remove('border-transparent');
                    
                    // Get the tab name
                    const tabName = this.getAttribute('data-tab');
                    
                    // Show the corresponding form and hide others
                    contextForms.forEach(form => {
                        if (form.id === tabName + 'Form') {
                            // Only show the form if we're not on protagonists tab
                            // For protagonists, we only show the form when a character is clicked
                            if (tabName !== 'protagonists') {
                                form.classList.remove('hidden');
                            } else {
                                form.classList.add('hidden');
                            }
                        } else {
                            form.classList.add('hidden');
                        }
                    });
                    
                    // Toggle between character tree and regular views
                    toggleContextView(tabName);
                });
            });
            
            // Character Tree Management
            const characterTreeContainer = document.getElementById('characterTreeContainer');
            
            // Update relationship lines in the network
            function updateRelationshipLines() {
                // Clear all existing relationship lines
                document.querySelectorAll('.character-link').forEach(link => {
                    link.remove();
                });
                
                // Get all character nodes
                const characterNodes = document.querySelectorAll('.character-node');
                
                // Create an adjacency list of relationships
                const relationships = {};
                
                // Initialize relationships for all characters
                characterNodes.forEach(node => {
                    const name = node.getAttribute('data-name');
                    relationships[name] = [];
                });
                
                // Populate relationships
                characterNodes.forEach(node => {
                    const name = node.getAttribute('data-name');
                    const nodeRelationships = JSON.parse(node.getAttribute('data-relationships') || '[]');
                    
                    // Add bidirectional relationships
                    nodeRelationships.forEach(relatedName => {
                        if (relationships[name] && !relationships[name].includes(relatedName)) {
                            relationships[name].push(relatedName);
                        }
                        if (relationships[relatedName] && !relationships[relatedName].includes(name)) {
                            relationships[relatedName].push(name);
                        }
                    });
                });
                
                // Create lines for each relationship (avoiding duplicates)
                const processedPairs = new Set();
                
                Object.keys(relationships).forEach(name => {
                    const node = Array.from(characterNodes).find(n => n.getAttribute('data-name') === name);
                    
                    relationships[name].forEach(relatedName => {
                        const relatedNode = Array.from(characterNodes).find(n => n.getAttribute('data-name') === relatedName);
                        
                        // Create a unique key for this pair
                        const pairKey = [name, relatedName].sort().join('_');
                        
                        // Only process each pair once
                        if (!processedPairs.has(pairKey) && node && relatedNode) {
                            createLink(node, relatedNode);
                            processedPairs.add(pairKey);
                        }
                    });
                });
            }
            
            // Create link between two character nodes
            function createLink(nodeA, nodeB) {
                // Get positions
                const rectA = nodeA.getBoundingClientRect();
                const rectB = nodeB.getBoundingClientRect();
                const containerRect = characterTreeContainer.getBoundingClientRect();
                
                // Calculate center points relative to container
                const aX = rectA.left + rectA.width / 2 - containerRect.left;
                const aY = rectA.top + rectA.height / 2 - containerRect.top;
                const bX = rectB.left + rectB.width / 2 - containerRect.left;
                const bY = rectB.top + rectB.height / 2 - containerRect.top;
                
                // Calculate distance and angle
                const distance = Math.sqrt(Math.pow(bX - aX, 2) + Math.pow(bY - aY, 2));
                const angle = Math.atan2(bY - aY, bX - aX) * 180 / Math.PI;
                
                // Create link element
                const link = document.createElement('div');
                link.className = 'character-link';
                link.style.width = `${distance}px`;
                link.style.top = `${aY}px`;
                link.style.left = `${aX}px`;
                link.style.transform = `rotate(${angle}deg)`;
                
                // Add to tree
                characterTreeContainer.appendChild(link);
                
                return link;
            }
            
            // Refresh character tree visualization
            function refreshCharacterTree() {
                // This function would update the tree based on actual data
                // For the demo, we'll just make sure the nodes are positioned properly
                
                // Add click handlers to character nodes for editing
                document.querySelectorAll('.character-node').forEach(node => {
                    node.onclick = function(e) {
                        // Stop propagation to prevent the network overlay from showing
                        e.stopPropagation();
                        
                        const name = this.getAttribute('data-name');
                        const role = this.getAttribute('data-role');
                        const relationships = JSON.parse(this.getAttribute('data-relationships') || '[]');
                        
                        // Set current editing item and show form
                        const character = { 
                            id: 'mock-id', 
                            name: name, 
                            role: role,
                            traits: "Sample traits for " + name,
                            backstory: "Sample backstory for " + name,
                            type: 'Protagonist',
                            relationships: relationships
                        };
                        
                        // Show the edit form
                        showEditCharacterForm(character);
                    };
                });
                
                // Update relationship lines
                updateRelationshipLines();
            }
            
            // Add character to tree visualization
            function addCharacterToTree(character) {
                // If we have a position from network click, use that
                // Otherwise, position based on relationships
                let posX, posY;
                
                if (networkClickPosition.x && networkClickPosition.y) {
                    posX = networkClickPosition.x;
                    posY = networkClickPosition.y;
                    
                    // Reset the network click position
                    networkClickPosition = { x: 0, y: 0 };
                } else {
                    // Calculate position based on existing nodes
                    const nodeCount = characterTreeContainer.querySelectorAll('.character-node').length;
                    const angle = nodeCount * (Math.PI / 4);
                    const centerX = characterTreeContainer.offsetWidth / 2;
                    const centerY = 120;
                    const radius = 100;
                    
                    // Calculate position
                    posX = centerX + radius * Math.cos(angle);
                    posY = centerY + radius * Math.sin(angle);
                }
                
                // Create node
                const node = document.createElement('div');
                node.className = `character-node ${character.role.toLowerCase()}`;
                node.style.top = `${posY}px`;
                node.style.left = `${posX}px`;
                node.setAttribute('data-name', character.name);
                node.setAttribute('data-role', character.role);
                
                // Create node content
                const nameDisplay = character.name.split(' ')[0]; // Just first name for display
                node.innerHTML = `
                    <div class="font-medium text-center">${nameDisplay}</div>
                    <div class="character-tooltip">
                        <div class="font-bold text-primary mb-1">${character.name}</div>
                        <div class="text-xs text-textSecondary mb-2">${character.role}</div>
                        <div class="text-sm">${character.traits || 'No traits specified.'}</div>
                    </div>
                `;
                
                // Add to tree
                characterTreeContainer.appendChild(node);
                
                // Note: We no longer automatically create links here
                // Links will be created based on the relationships in updateRelationshipLines()
                
                // Attach click handler
                node.onclick = function(e) {
                    // Stop propagation to prevent the network overlay from showing
                    e.stopPropagation();
                    
                    const name = this.getAttribute('data-name');
                    const role = this.getAttribute('data-role');
                    const relationships = JSON.parse(this.getAttribute('data-relationships') || '[]');
                    
                    // Set current editing item
                    const character = { 
                        id: 'mock-id', 
                        name: name, 
                        role: role,
                        traits: character.traits || '',
                        backstory: character.backstory || '',
                        type: 'Protagonist',
                        relationships: relationships
                    };
                    
                    // Show the edit form
                    showEditCharacterForm(character);
                };
                
                return node;
            }
            
            // Handle delete button state
            function updateDeleteButtonState() {
                if (currentlyEditing) {
                    deleteContextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    deleteContextBtn.disabled = false;
                } else {
                    deleteContextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    deleteContextBtn.disabled = true;
                }
            }
            
            // Reset all forms
            function resetForms() {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    input.value = '';
                });
                updateDeleteButtonState();
            }
            
            // Initialize delete button state
            updateDeleteButtonState();
            
            // Initialize view based on current tab
            toggleContextView('protagonists');
            
            // Save Character button handler
            saveCharacterBtn.addEventListener('click', function() {
                // Basic validation
                let isValid = true;
                let formData = {};
                
                const name = document.getElementById('protagonistName').value;
                const role = document.getElementById('protagonistRole').value;
                
                if (!name) {
                    document.getElementById('protagonistName').classList.add('border-error');
                    isValid = false;
                } else {
                    document.getElementById('protagonistName').classList.remove('border-error');
                }
                
                if (isValid) {
                    // Get relationships from the relationship list
                    const relationships = [];
                    relationshipList.querySelectorAll('span').forEach(span => {
                        const relationshipText = span.textContent;
                        // Extract name from text like "John Doe (Protagonist)"
                        const relationshipName = relationshipText.split(' (')[0];
                        relationships.push(relationshipName);
                    });
                    
                    formData = {
                        name: name,
                        role: role,
                        traits: document.getElementById('protagonistTraits').value,
                        backstory: document.getElementById('protagonistBackstory').value,
                        type: 'Protagonist',
                        relationships: relationships
                    };
                    
                    if (currentlyEditing) {
                        // Update existing character
                        console.log('Updated character:', formData);
                        
                        // Find and update node
                        const node = Array.from(document.querySelectorAll('.character-node')).find(
                            node => node.getAttribute('data-name') === currentlyEditing.name
                        );
                        
                        if (node) {
                            // Store old name to update relationships
                            const oldName = node.getAttribute('data-name');
                            
                            // Update node data
                            node.setAttribute('data-name', formData.name);
                            node.setAttribute('data-role', formData.role);
                            node.setAttribute('data-relationships', JSON.stringify(relationships));
                            
                            // Update class for role
                            node.className = node.className.replace(/protagonist|antagonist|supporting|minor/g, '');
                            node.classList.add(formData.role.toLowerCase());
                            node.classList.add('character-node');
                            
                            // Update content
                            const nameDisplay = formData.name.split(' ')[0]; // Just first name for display
                            node.querySelector('.font-medium').textContent = nameDisplay;
                            
                            const tooltip = node.querySelector('.character-tooltip');
                            tooltip.querySelector('.font-bold').textContent = formData.name;
                            tooltip.querySelector('.text-xs').textContent = formData.role;
                            tooltip.querySelector('.text-sm').textContent = formData.traits || 'No traits specified.';
                            
                            // If name changed, update relationships in other characters that reference this character
                            if (oldName !== formData.name) {
                                document.querySelectorAll('.character-node').forEach(otherNode => {
                                    if (otherNode !== node) {
                                        const otherRelationships = JSON.parse(otherNode.getAttribute('data-relationships') || '[]');
                                        const index = otherRelationships.indexOf(oldName);
                                        if (index !== -1) {
                                            otherRelationships[index] = formData.name;
                                            otherNode.setAttribute('data-relationships', JSON.stringify(otherRelationships));
                                        }
                                    }
                                });
                            }
                        }
                    } else {
                        // Add new character
                        console.log('Added new character:', formData);
                        const newNode = addCharacterToTree(formData);
                        newNode.setAttribute('data-relationships', JSON.stringify(relationships));
                        
                        // Update character count
                        const characterCount = characterTreeContainer.querySelectorAll('.character-node').length;
                        characterTreeView.querySelector('span.text-xs').textContent = `${characterCount} characters`;
                    }
                    
                    // Update relationship lines in the network
                    updateRelationshipLines();
                    
                    // Hide the form
                    characterFormContainer.classList.add('hidden');
                    
                    // Reset editing state
                    currentlyEditing = null;
                    
                    // Reset form
                    resetCharacterForm();
                }
            });
            
            // Add relationship
            addRelationshipBtn.addEventListener('click', function() {
                addRelationship();
            });
            
            // Add relationship function
            function addRelationship() {
                const selectedCharacter = newRelationshipSelect.value;
                const selectedOption = newRelationshipSelect.options[newRelationshipSelect.selectedIndex];
                
                if (!selectedCharacter) {
                    return; // Nothing selected
                }
                
                // Check if relationship already exists
                const existingRelationships = relationshipList.querySelectorAll('span');
                for (let i = 0; i < existingRelationships.length; i++) {
                    if (existingRelationships[i].textContent.includes(selectedCharacter)) {
                        return; // Relationship already exists
                    }
                }
                
                // Create relationship element
                const relationshipEl = document.createElement('div');
                relationshipEl.className = 'flex items-center justify-between text-sm';
                
                // Determine color based on character role
                let colorClass = 'bg-primary'; // default
                if (selectedOption.textContent.includes('Antagonist')) {
                    colorClass = 'bg-error';
                } else if (selectedOption.textContent.includes('Supporting')) {
                    colorClass = 'bg-accent';
                } else if (selectedOption.textContent.includes('Minor')) {
                    colorClass = 'bg-secondary';
                }
                
                relationshipEl.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full ${colorClass} mr-2"></div>
                        <span>${selectedOption.textContent}</span>
                    </div>
                    <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add to list
                relationshipList.appendChild(relationshipEl);
                
                // Add delete handler
                const deleteBtn = relationshipEl.querySelector('.relationship-delete-btn');
                deleteBtn.addEventListener('click', function() {
                    relationshipEl.remove();
                });
                
                // Reset select
                newRelationshipSelect.value = '';
            }
            
            // Add delete handlers to existing relationship delete buttons
            function initRelationshipDeleteButtons() {
                const deleteButtons = relationshipList.querySelectorAll('.relationship-delete-btn');
                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.closest('div.flex.items-center.justify-between').remove();
                    });
                });
            }
            
            // Add keypress handler for relationship select (enter to add)
            newRelationshipSelect.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addRelationship();
                }
            });
            
            // Initialize relationship delete buttons
            initRelationshipDeleteButtons();
            
            // Populate relationship select from character nodes
            function updateRelationshipSelect() {
                // Clear existing options except first "Select a character..." option
                while (newRelationshipSelect.options.length > 1) {
                    newRelationshipSelect.remove(1);
                }
                
                // Add all characters from nodes
                document.querySelectorAll('.character-node').forEach(node => {
                    const name = node.getAttribute('data-name');
                    const role = node.getAttribute('data-role');
                    
                    // Skip if this is the currently editing character
                    if (currentlyEditing && currentlyEditing.name === name) {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${role})`;
                    newRelationshipSelect.appendChild(option);
                });
            }

            // AI Assistant Panel Functionality
            const aiAssistBtn = document.getElementById('aiAssistBtn');
            const aiAssistPanel = document.getElementById('aiAssistPanel');
            const closeAiPanel = document.getElementById('closeAiPanel');
            const aiMobileOverlay = document.getElementById('aiMobileOverlay');
            const modeButtons = document.querySelectorAll('.ai-mode-btn');
            const generateEditView = document.getElementById('generateEditView');
            const chatView = document.getElementById('chatView');
            const aiInput = document.getElementById('aiInput');
            const aiSubmit = document.getElementById('aiSubmit');
            const chatInput = document.getElementById('chatInput');
            const chatSubmit = document.getElementById('chatSubmit');
            const chatHistory = document.getElementById('chatHistory');
            const aiToast = document.getElementById('aiToast');
            const aiModel = document.getElementById('aiModel');
            
            let currentMode = 'generate';
            
            // Toggle AI Panel
            function toggleAiPanel() {
                const isOpen = aiAssistPanel.classList.contains('translate-x-0');
                aiAssistPanel.classList.toggle('translate-x-0');
                aiAssistPanel.classList.toggle('translate-x-full');
                aiMobileOverlay.classList.toggle('hidden');
                
                // Initialize the context panel when AI panel is opened
                if (!isOpen) {
                    if (!aiAssistPanel.__contextInitialized) {
                        initContextPanel();
                        aiAssistPanel.__contextInitialized = true;
                    }
                }
                
                // Remove the auto-focus
                /* if (!isOpen) {
                    if (currentMode === 'generate') {
                        aiInput.focus();
                    } else if (currentMode === 'chat') {
                        chatInput.focus();
                    }
                } */
            }
            
            aiAssistBtn.addEventListener('click', toggleAiPanel);
            closeAiPanel.addEventListener('click', toggleAiPanel);
            aiMobileOverlay.addEventListener('click', toggleAiPanel);
            
            // Mode Switching
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    currentMode = mode;
                    
                    // Update active state
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show/hide views
                    if (mode === 'chat') {
                        generateEditView.classList.add('hidden');
                        chatView.classList.remove('hidden');
                        // Remove auto-focus
                        // chatInput.focus();
                    } else {
                        generateEditView.classList.remove('hidden');
                        chatView.classList.add('hidden');
                        // Remove auto-focus
                        // aiInput.focus();
                    }
                    
                    // Update placeholder
                    updatePlaceholder();
                });
            });
            
            // Update input placeholder based on mode
            function updatePlaceholder() {
                const placeholders = {
                    generate: 'Write a scene with Jane...',
                    chat: 'Ask the AI...'
                };
                
                if (currentMode === 'chat') {
                    chatInput.placeholder = placeholders.chat;
                } else {
                    aiInput.placeholder = placeholders.generate;
                }
            }
            
            // Get the active context items
            function getActiveContext() {
                const selectedContext = {
                    characters: [],
                    locations: [],
                    events: []
                };
                
                // Get all checked context items
                document.querySelectorAll('.context-item-checkbox:checked').forEach(checkbox => {
                    const type = checkbox.getAttribute('data-type');
                    const item = {
                        id: checkbox.getAttribute('data-id'),
                        name: checkbox.getAttribute('data-name')
                    };
                    
                    // Add to appropriate category
                    switch(type) {
                        case 'character':
                            selectedContext.characters.push(item);
                            break;
                        case 'location':
                            selectedContext.locations.push(item);
                            break;
                        case 'event':
                            selectedContext.events.push(item);
                            break;
                    }
                });
                
                return selectedContext;
            }
            
            // Update the context summary based on selected items
            function updateContextSummary() {
                const selectedItems = document.querySelectorAll('.context-item-checkbox:checked');
                const contextSummary = document.getElementById('contextSummary');
                
                if (selectedItems.length === 0) {
                    contextSummary.textContent = 'No context items selected';
                } else {
                    const itemNames = Array.from(selectedItems).map(item => 
                        item.getAttribute('data-name')
                    );
                    contextSummary.textContent = itemNames.join(', ');
                }
            }
            
            // Load context items from the app state
            async function loadContextItems() {
                // Characters
                const charactersList = document.getElementById('characterContextItems');
                charactersList.innerHTML = ''; // Clear loading message
                
                // Locations
                const locationsList = document.getElementById('locationContextItems');
                locationsList.innerHTML = '';
                
                // Timeline events
                const timelineList = document.getElementById('timelineContextItems');
                timelineList.innerHTML = '';
                
                try {
                    // Check if supabase services are available
                    if (!window.supabaseServices || !window.supabaseServices.characters) {
                        console.warn('Supabase services not available, using fallback data');
                        throw new Error('Supabase services not initialized');
                    }
                    
                    if (!window.appState?.currentProject) {
                        throw new Error('No current project');
                    }
                    
                    // Load characters
                    const { data: projectCharacters, error: charError } = await window.supabaseServices.characters.getByProject(
                        window.appState.currentProject.id
                    );
                    
                    if (charError) throw charError;
                    
                    // Load locations
                    const { data: projectLocations, error: locError } = await window.supabaseServices.locations.getByProject(
                        window.appState.currentProject.id
                    );
                    
                    if (locError) throw locError;
                    
                    // Load timeline events
                    const { data: projectEvents, error: eventsError } = await window.supabaseServices.timelineEvents.getByProject(
                        window.appState.currentProject.id
                    );
                    
                    if (eventsError) throw eventsError;
                    
                    // Add characters to the list
                    if (projectCharacters && projectCharacters.length > 0) {
                        projectCharacters.forEach(character => {
                            const item = createContextItem(character.id, character.name, 'character');
                            charactersList.appendChild(item);
                        });
                    } else {
                        charactersList.innerHTML = '<div class="text-xs text-gray-500 italic">No characters found</div>';
                    }
                    
                    // Add locations to the list
                    if (projectLocations && projectLocations.length > 0) {
                        projectLocations.forEach(location => {
                            const item = createContextItem(location.id, location.name, 'location');
                            locationsList.appendChild(item);
                        });
                    } else {
                        locationsList.innerHTML = '<div class="text-xs text-gray-500 italic">No locations found</div>';
                    }
                    
                    // Add timeline events to the list
                    if (projectEvents && projectEvents.length > 0) {
                        projectEvents.forEach(event => {
                            const item = createContextItem(event.id, event.name, 'event');
                            timelineList.appendChild(item);
                        });
                    } else {
                        timelineList.innerHTML = '<div class="text-xs text-gray-500 italic">No timeline events found</div>';
                    }
                } catch (error) {
                    console.error('Error loading context items:', error);
                    
                    // Fallback to some demo data if we have errors
                    charactersList.innerHTML = '';
                    [
                        { id: 'char1', name: 'John Doe', type: 'character' },
                        { id: 'char2', name: 'Mystery Figure', type: 'character' },
                        { id: 'char3', name: 'Sarah', type: 'character' }
                    ].forEach(char => {
                        const item = createContextItem(char.id, char.name, char.type);
                        charactersList.appendChild(item);
                    });
                    
                    locationsList.innerHTML = '';
                    [
                        { id: 'loc1', name: 'New York City', type: 'location' },
                        { id: 'loc2', name: 'Darkwood Forest', type: 'location' }
                    ].forEach(loc => {
                        const item = createContextItem(loc.id, loc.name, loc.type);
                        locationsList.appendChild(item);
                    });
                    
                    timelineList.innerHTML = '';
                    [
                        { id: 'evt1', name: 'The Accident', type: 'event' },
                        { id: 'evt2', name: 'Full Moon Encounter', type: 'event' }
                    ].forEach(evt => {
                        const item = createContextItem(evt.id, evt.name, evt.type);
                        timelineList.appendChild(item);
                    });
                }
                
                // Update the context summary based on default selected items
                setTimeout(updateContextSummary, 100);
            }
            
            // Create a context item for the selection list
            function createContextItem(id, name, type) {
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-2 mb-1 p-1 hover:bg-gray-50 rounded';
                
                // Create a unique ID for the checkbox
                const checkboxId = `context-item-${type}-${id}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = checkboxId;
                checkbox.className = 'context-item-checkbox rounded text-primary focus:ring-primary';
                checkbox.setAttribute('data-id', id);
                checkbox.setAttribute('data-name', name);
                checkbox.setAttribute('data-type', type);
                
                // Add change event listener to update the summary when selection changes
                checkbox.addEventListener('change', updateContextSummary);
                
                // Set some default selections
                if ((type === 'character' && name === 'John Doe') || 
                    (type === 'location' && name === 'Darkwood Forest')) {
                    checkbox.checked = true;
                }
                
                const label = document.createElement('label');
                label.className = 'text-xs cursor-pointer select-none flex-grow';
                label.textContent = name;
                label.setAttribute('for', checkboxId); // Associate label with checkbox
                
                // Add click event to the whole item to toggle checkbox
                item.addEventListener('click', (e) => {
                    // Prevent double-toggling when clicking directly on checkbox or label
                    if (e.target !== checkbox && e.target !== label) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                item.appendChild(checkbox);
                item.appendChild(label);
                
                return item;
            }
            
            // Initialize context selection panel
            function initContextPanel() {
                const toggleContextBtn = document.getElementById('toggleContextBtn');
                const contextSelectionPanel = document.getElementById('contextSelectionPanel');
                
                // Toggle the context selection panel
                toggleContextBtn.addEventListener('click', () => {
                    const isHidden = contextSelectionPanel.classList.contains('hidden');
                    
                    // Toggle the panel
                    contextSelectionPanel.classList.toggle('hidden', !isHidden);
                    
                    // Update the icon
                    const icon = toggleContextBtn.querySelector('i');
                    if (isHidden) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                    
                    // Load context items if opening the panel
                    if (isHidden) {
                        loadContextItems();
                    }
                });
                
                // Initialize with some selected items (when the panel opens for the first time)
                loadContextItems();
            }
            
            // Handle input validation and submit button state
            function validateInput(input) {
                const isValid = input.value.trim().length > 0;
                const submitBtn = input.id === 'chatInput' ? chatSubmit : aiSubmit;
                
                submitBtn.disabled = !isValid;
                submitBtn.classList.toggle('pulse', isValid);
            }
            
            // Auto-expand textarea
            function autoExpandTextarea(textarea) {
                // Reset height to allow shrinking
                textarea.style.height = 'auto';
                
                // Calculate new height (min 100px, max 300px)
                const newHeight = Math.max(100, Math.min(textarea.scrollHeight, 300));
                textarea.style.height = newHeight + 'px';
            }
            
            // Handle AI input
            aiInput.addEventListener('input', function() {
                validateInput(this);
                autoExpandTextarea(this);
            });

            // Initialize textarea height
            window.addEventListener('load', function() {
                autoExpandTextarea(aiInput);
                autoExpandTextarea(chatInput);
            });
            
            // Handle chat input
            chatInput.addEventListener('input', function() {
                validateInput(this);
                autoExpandTextarea(this);
            });
            
            // Add a delay function to rate limit requests
            function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // Handle chat submit with Hugging Face API call
            chatSubmit.addEventListener('click', async () => {
                const message = chatInput.value.trim();
                if (!message) return;
                
                addChatMessage(message, true);
                
                // Reset input and height
                chatInput.value = '';
                chatInput.style.height = 'auto';
                validateInput(chatInput);
                
                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'chat-message ai';
                typingIndicator.innerHTML = `
                    <p class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i>
                        AI is typing...
                    </p>
                `;
                chatHistory.appendChild(typingIndicator);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                try {
                    // Add a small delay to avoid hitting rate limits
                    await delay(500);
                    
                    const model = aiModel.value;
                    
                    // Get current project and user IDs from app state
                    const user_id = window.appState?.currentUser?.id || '';
                    const project_id = window.appState?.currentProject?.id || '';
                    
                    const response = await fetch(`/.netlify/functions/generate-text?model=${model}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: message,
                            context: getActiveContext(),
                            mode: 'chat',
                            tone: 'neutral',
                            length: 200,
                            user_id: user_id,
                            project_id: project_id
                        }),
                    });

                    const data = await response.json();
                    
                    // Remove typing indicator
                    typingIndicator.remove();
                    
                    if (data.error && !data.text) {
                        throw new Error(data.error);
                    }
                    
                    // Format the response text to remove the input prompt if it's repeated
                    let responseText = data.text || '';
                    if (responseText.includes(message)) {
                        responseText = responseText.replace(message, '');
                    }
                    
                    // Add model information to the response
                    let formattedResponse = responseText || 'I apologize, but I couldn\'t generate a proper response.';
                    
                    // Add model info for non-fallback responses
                    if (data.model && !data.isFallback) {
                        formattedResponse = `<div class="text-xs text-gray-500 mb-2">Using model: ${data.model}</div>${formattedResponse}`;
                    }
                    
                    // Add warning for fallback responses
                    if (data.isFallback) {
                        formattedResponse = `<div class="text-xs text-orange-500 mb-2">Note: Using offline response due to API limits.</div>${formattedResponse}`;
                    }
                    
                    // Add AI response
                    addChatMessage(formattedResponse, false, true);
                } catch (error) {
                    console.error('Error:', error);
                    typingIndicator.remove();
                    addChatMessage(`Error: ${error.message || 'Could not connect to AI. Please try again later.'}`, false);
                    showToast('Error connecting to AI', 'error');
                }
            });
            
            // Handle AI submit with Hugging Face API call for Generate/Edit modes
            aiSubmit.addEventListener('click', async () => {
                const prompt = aiInput.value.trim();
                if (!prompt) return;
                
                // Show loading state
                aiOutput.innerHTML = '<p class="text-gray-400 text-sm m-0 p-0"><i class="fas fa-spinner fa-spin mr-2"></i>Generating...</p>';
                aiInput.value = '';
                validateInput(aiInput);
                
                try {
                    // Add a small delay to avoid hitting rate limits
                    await delay(500);
                    
                    const model = aiModel.value;
                    const tone = document.getElementById('aiTone').value;
                    const length = document.getElementById('aiLength').value;
                    
                    // Get current project and user IDs from app state
                    const user_id = window.appState?.currentUser?.id || '';
                    const project_id = window.appState?.currentProject?.id || '';
                    
                    // Get selected context items
                    const selectedContext = getActiveContext();
                    console.log('Selected context for AI:', selectedContext);
                    
                    const response = await fetch(`/.netlify/functions/generate-text?model=${model}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt,
                            context: selectedContext,
                            mode: currentMode,
                            tone: tone,
                            length: length,
                            user_id: user_id,
                            project_id: project_id
                        }),
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Show success output with insert button
                        aiOutput.innerHTML = `
                            <div class="space-y-2 m-0 p-0">
                                <div class="prose max-w-none text-gray-800 m-0 p-0">
                                    ${data.text.split('\n')
                                        .filter(line => line.trim())
                                        .map((line, index) => 
                                            `<p class="mb-2 mt-0">${line}</p>`
                                        )
                                        .join('')}
                                </div>
                                <div class="flex justify-end mt-3 border-t pt-3">
                                    <button class="px-3 py-1.5 text-sm font-medium text-white dark:text-black bg-black dark:bg-white border border-black dark:border-white rounded hover:bg-black/80 dark:hover:bg-white/80 transition-colors flex items-center space-x-2" 
                                            id="insertIntoChapterBtn" data-shadcn="button" data-variant="monochrome">
                                        <i class="fas fa-paste"></i>
                                        <span>Insert into Chapter</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Add event listener to the insert button
                        document.getElementById('insertIntoChapterBtn').addEventListener('click', function() {
                            insertIntoChapter(data.text);
                        });
                        
                        // Track successful generation
                        if (window.gtag) {
                            window.gtag('event', 'ai_generation_success', {
                                'event_category': 'engagement',
                                'event_label': currentMode
                            });
                        }
                    } else {
                        throw new Error(data.error || 'Failed to generate text');
                    }
                } catch (error) {
                    console.error('Error generating text:', error);
                    aiOutput.innerHTML = `
                        <div class="text-error m-0 p-0">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            ${error.message || 'An error occurred while generating text'}
                        </div>
                    `;
                }
            });

            // Function to insert AI output into the current chapter
            function insertIntoChapter(text) {
                if (!appState.currentChapter) {
                    showToast('Please select a chapter first', 'error');
                    return;
                }

                const editorContent = document.getElementById('editorContent');
                if (!editorContent) {
                    showToast('Could not find chapter editor', 'error');
                    return;
                }

                // Get current cursor position or append to end
                let selection = window.getSelection();
                let range;
                
                try {
                    range = selection.getRangeAt(0);
                } catch (e) {
                    // If no range exists, create one at the end of the editor
                    range = document.createRange();
                    range.selectNodeContents(editorContent);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                
                // Format the text into paragraphs
                const formattedText = text.split('\n')
                    .filter(line => line.trim())
                    .map(line => `<p>${line}</p>`)
                    .join('');
                
                // Create a temporary container for the HTML content
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = formattedText;

                // Insert at cursor position or append to end
                if (selection.rangeCount > 0 && editorContent.contains(range.commonAncestorContainer)) {
                    range.deleteContents();
                    
                    // Insert each child node individually to maintain proper DOM structure
                    Array.from(tempContainer.childNodes).forEach(node => {
                        range.insertNode(node);
                        range.setStartAfter(node);
                        range.collapse(true);
                    });
                } else {
                    editorContent.appendChild(tempContainer);
                }

                // Mark content as needing to be saved
                appState.isDirty = true;
                
                // Update save button to indicate unsaved changes
                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.classList.remove('btn-primary');
                    saveBtn.classList.add('btn-error');
                }
                
                // Show success message
                showToast('Text inserted successfully', 'success');
                
                // Trigger auto-save after a short delay
                setTimeout(() => {
                    if (appState.isDirty && appState.currentChapter) {
                        saveCurrentChapter();
                    }
                }, 1000);
                
                // Track insertion
                if (window.gtag) {
                    window.gtag('event', 'ai_text_inserted', {
                        'event_category': 'engagement',
                        'event_label': 'chapter_content'
                    });
                }
            }
            
            // Handle Enter key in chat input (Shift+Enter for new line)
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                    if (!chatSubmit.disabled) {
                        chatSubmit.click();
                    }
                }
            });
            
            // Handle keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Shift + A to toggle AI panel
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'a') {
                    e.preventDefault();
                    toggleAiPanel();
                }
                
                // Enter to submit in chat or generate/edit
                if (e.key === 'Enter' && !e.shiftKey) {
                    if (document.activeElement === chatInput) {
                        e.preventDefault();
                        chatSubmit.click();
                    } else if (document.activeElement === aiInput) {
                        e.preventDefault();
                        aiSubmit.click();
                    }
                }
            });
            
            // Initialize
            updatePlaceholder();
            validateInput(aiInput);
            validateInput(chatInput);
            
            // Show toast message
            function showToast(message, type = 'success') {
                const toast = document.getElementById('aiToast');
                toast.querySelector('p').textContent = message;
                toast.classList.remove('hidden');
                toast.classList.add('transform', 'translate-y-0');
                
                if (type === 'success') {
                    toast.classList.add('bg-success');
                    toast.classList.remove('bg-error');
                } else {
                    toast.classList.add('bg-error');
                    toast.classList.remove('bg-success');
                }
                
                setTimeout(() => {
                    toast.classList.add('translate-y-full');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                        toast.classList.remove('translate-y-full', 'bg-success', 'bg-error');
                    }, 300);
                }, 3000);
            }
            
            // Add chat message
            function addChatMessage(message, isUser = false, allowHtml = false) {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${isUser ? 'user' : 'ai'}`;
                
                // Format message text (handle newlines and lists)
                const formattedMessage = message
                    .replace(/\n/g, '<br>')
                    .replace(/(\d+\.\s.*?)(?=(?:\d+\.|$))/g, '<div class="mb-1">$1</div>')
                    .replace(/â€¢\s(.*?)(?=(?:â€¢|$))/g, '<div class="mb-1">â€¢ $1</div>');
                
                // If allowHtml is true, use innerHTML directly
                if (allowHtml) {
                    messageEl.innerHTML = `<div>${formattedMessage}</div>`;
                } else {
                    messageEl.innerHTML = `<p>${formattedMessage}</p>`;
                }
                
                chatHistory.appendChild(messageEl);
                
                // Ensure we scroll to see the new message
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });
    </script>

    <!-- New Project Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center modal" id="newProjectModal">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-md-custom fade-in" data-shadcn="card">
            <div class="flex items-center justify-between mb-4" data-shadcn="card-header">
                <h2 class="text-xl font-bold text-primary" data-shadcn="card-title">Create New Project</h2>
                <button class="text-gray-400 hover:text-gray-600" id="closeNewProjectModal" data-shadcn="button" data-variant="ghost" data-size="icon">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4" data-shadcn="card-content">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Project Title <span class="text-error">*</span></label>
                    <input type="text" id="newProjectTitle" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Enter project title" data-shadcn="input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="newProjectDescription" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-24" placeholder="Enter project description (optional)" data-shadcn="textarea"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelNewProject" class="btn btn-secondary" data-shadcn="button" data-variant="secondary">Cancel</button>
                    <button id="createNewProject" class="btn btn-primary" data-shadcn="button" data-variant="default">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-5 rounded-lg shadow-lg text-center">
            <div class="animate-spin mb-3 mx-auto w-8 h-8 border-4 border-primary border-t-transparent rounded-full"></div>
            <p id="loadingMessage">Loading...</p>
        </div>
    </div>

    <!-- Add this script at the end of the body -->
    <script>
        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (!sidebar || !overlay) {
                console.error('Sidebar or overlay not found');
                return;
            }
            
            // Toggle the sidebar active state
            sidebar.classList.toggle('active');
            
            // Handle overlay visibility
            if (sidebar.classList.contains('active')) {
                // Showing sidebar
                overlay.style.display = 'block';
                overlay.classList.remove('hidden');
                
                // Small delay to ensure proper animation
                setTimeout(() => {
                    overlay.classList.add('active');
                }, 10);
            } else {
                // Hiding sidebar
                overlay.classList.remove('active');
                
                // Wait for animation to complete before hiding
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            }
            
            console.log('Sidebar toggled', sidebar.classList.contains('active'));
        }
        
                // Add click handlers for sidebar toggle        document.addEventListener('DOMContentLoaded', function() {            // Mobile menu button click handler            const mobileMenuBtn = document.getElementById('mobileMenuBtn');            if (mobileMenuBtn) {                mobileMenuBtn.addEventListener('click', function(e) {                    e.preventDefault();                    toggleSidebar();                });            } else {                console.error('Mobile menu button not found');            }                        // Sidebar overlay click handler            const sidebarOverlay = document.getElementById('sidebarOverlay');            if (sidebarOverlay) {                sidebarOverlay.addEventListener('click', function() {                    toggleSidebar();                });            }
            
                         // User Profile Button click handler
             const userProfileBtn = document.getElementById('userProfileBtn');
             const profileDropdownContainer = document.getElementById('profileDropdownContainer');
             
             if (userProfileBtn && profileDropdownContainer) {
                 userProfileBtn.addEventListener('click', function(e) {
                     e.preventDefault();
                     
                     // Toggle dropdown visibility
                     const isHidden = profileDropdownContainer.classList.contains('hidden');
                     
                     if (isHidden) {
                         // Show dropdown
                         profileDropdownContainer.classList.remove('hidden');
                         
                         // Position dropdown properly for mobile
                         if (window.innerWidth <= 768) {
                             profileDropdownContainer.style.position = 'fixed';
                             profileDropdownContainer.style.right = '10px';
                             profileDropdownContainer.style.top = '60px';
                             profileDropdownContainer.style.zIndex = '100';
                             
                             // Add a temporary overlay to handle clicks outside
                             const overlay = document.createElement('div');
                             overlay.id = 'profileOverlay';
                             overlay.className = 'fixed inset-0 z-40';
                             overlay.style.background = 'transparent';
                             document.body.appendChild(overlay);
                             
                             // Close dropdown when clicking outside
                             overlay.addEventListener('click', function() {
                                 profileDropdownContainer.classList.add('hidden');
                                 document.body.removeChild(overlay);
                             });
                         }
                     } else {
                         // Hide dropdown
                         profileDropdownContainer.classList.add('hidden');
                         
                         // Remove overlay if it exists
                         const overlay = document.getElementById('profileOverlay');
                         if (overlay) {
                             document.body.removeChild(overlay);
                         }
                     }
                 });
             }                        // Check if dark mode was enabled previously and ensure the UI reflects it            const isDarkMode = document.documentElement.classList.contains('dark');            if (isDarkMode) {                // Apply dark mode button styles                if (window.applyDarkModeButtonStyles) {                    window.applyDarkModeButtonStyles();                    console.log('Dark mode button styles applied on page load');                }                                // Apply header and toolbar dark styles on initial load                const header = document.querySelector('header');                const toolbar = document.querySelector('.editor-toolbar');                const editorContent = document.querySelector('#editorContent');                const projectInfoBox = document.querySelector('.sidebar .bg-white.rounded-lg');                const contextBox = document.querySelector('#contextList');                const wordCountContainer = document.querySelector('.flex.items-center.justify-between.bg-white.p-3.rounded-lg.shadow-sm-custom.text-sm');                if (header) header.style.backgroundColor = 'hsl(240, 3.7%, 15.9%)';                if (toolbar) toolbar.style.backgroundColor = 'hsl(240, 3.7%, 15.9%)';                if (editorContent) editorContent.style.backgroundColor = 'hsl(240, 3.7%, 15.9%)';                if (projectInfoBox) projectInfoBox.style.backgroundColor = 'hsl(240, 3.7%, 15.9%)';                if (contextBox) contextBox.style.backgroundColor = 'hsl(240, 3.7%, 15.9%)';                if (wordCountContainer) wordCountContainer.style.backgroundColor = 'hsl(240, 3.7%, 15.9%)';                // Apply to all sidebar white background elements                document.querySelectorAll('.sidebar .bg-white').forEach(el => {                    el.style.backgroundColor = 'hsl(240, 3.7%, 15.9%)';                });            }                        // The old dark mode toggle button is now removed, using switch in profile dropdown instead                        // Ensure AI output containers can scroll properly when content changes            const aiOutput = document.getElementById('aiOutput');            const chatHistory = document.getElementById('chatHistory');                        // Setup resize observer for AI output and chat history            if (window.ResizeObserver) {                // For aiOutput                const outputObserver = new ResizeObserver(entries => {                    for (let entry of entries) {                        if (entry.target.scrollHeight > entry.target.clientHeight) {                            // Content exceeds container height, ensure scrollable                            entry.target.style.overflowY = 'auto';                        }                    }                });                                if (aiOutput) outputObserver.observe(aiOutput);                                // For chatHistory                const chatObserver = new ResizeObserver(entries => {                    for (let entry of entries) {                        if (entry.target.scrollHeight > entry.target.clientHeight) {                            // Scroll to the bottom when content changes                            entry.target.scrollTop = entry.target.scrollHeight;                        }                    }                });                                if (chatHistory) chatObserver.observe(chatHistory);            }                        // Mobile keyboard handling for AI chat inputs            const chatInput = document.getElementById('chatInput');            const aiInput = document.getElementById('aiInput');            const aiAssistPanel = document.getElementById('aiAssistPanel');                        // Function to adjust input position when keyboard appears            function handleMobileKeyboard(input) {                if (!input || window.innerWidth > 768) return; // Only apply on mobile devices                                // When input is focused (keyboard appears)                input.addEventListener('focus', () => {                    // Small delay to ensure keyboard is fully shown                    setTimeout(() => {                        // Get the input container (the parent div of the textarea)                        const inputContainer = input.closest('.flex-shrink-0');                        if (!inputContainer) return;                                                // Add class to position the input above keyboard                        inputContainer.classList.add('keyboard-visible');                                                // Scroll the panel to ensure input is visible                        aiAssistPanel.scrollTop = aiAssistPanel.scrollHeight;                                                // Scroll the input into view                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });                    }, 300);                });                                // When input loses focus (keyboard disappears)                input.addEventListener('blur', () => {                    // Get the input container                    const inputContainer = input.closest('.flex-shrink-0');                    if (!inputContainer) return;                                        // Remove the positioning class                    inputContainer.classList.remove('keyboard-visible');                });            }                        // Apply keyboard handling to both chat inputs            handleMobileKeyboard(chatInput);            handleMobileKeyboard(aiInput);                        // Handle visual viewport changes (for iOS)            if (window.visualViewport) {                window.visualViewport.addEventListener('resize', () => {                    const activeInput = document.activeElement;                    // Check if active element is one of our inputs                    if (activeInput === chatInput || activeInput === aiInput) {                        // Calculate the difference between window height and viewport height (keyboard height)                        const keyboardHeight = window.innerHeight - window.visualViewport.height;                                                if (keyboardHeight > 100) { // Keyboard is visible                            // Get the input container                            const inputContainer = activeInput.closest('.flex-shrink-0');                            if (!inputContainer) return;                                                        // Position the input above the keyboard                            inputContainer.style.marginBottom = `${keyboardHeight}px`;                                                        // Scroll input into view                            activeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });                        }                    }                });            }        });
    </script>
    
    <style>
        /* Fix for mobile buttons icon display */
        @media (max-width: 768px) {
            /* Header optimizations - default light mode */
            header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 56px;
                z-index: 50;
                padding: 0;
                display: flex;
                justify-content: space-between;
            }
            
            /* Fix editor toolbar position */
            .editor-toolbar {
                position: fixed;
                top: 56px;
                left: 0;
                right: 0;
                z-index: 49;
            }
            
            /* Adjust main content */
            main {
                margin-top: 106px; /* Header + editor toolbar */
            }
            
            /* Mobile icon buttons - properly sized */
            .mobile-icon-btn {
                min-width: unset;
                width: 36px;
                height: 36px;
                border-radius: 6px;
                padding: 0;
                margin: 0 2px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Dark mode specific styles */
            .dark header, 
            .dark .editor-toolbar {
                background-color: #1f1f1f;
                border-color: #333;
            }
            
            /* Dark mode sidebar */
            .dark .sidebar {
                background-color: #1f1f1f;
                border-color: #333;
                color: white;
            }
            
            /* When in dark mode, ensure icon visibility */
            .dark .mobile-icon-btn i,
            .dark header i,
            .dark .fa-bars,
            .dark .fa-feather-alt,
            .dark .fa-folder-open,
            .dark .fa-plus,
            .dark button.mobile-icon-btn i {
                color: white;
                display: inline-block;
                visibility: visible;
                opacity: 1;
            }
            
            /* Preserve the save button's light background in dark mode */
            .dark #saveBtn {
                background-color: white;
            }
            
            .dark #saveBtn i {
                color: black;
            }
            
            /* Make sure the app logo icon is visible */
            .dark .bg-primary i.fa-feather-alt {
                color: white;
                display: inline-block;
            }
            
            /* Style the AI Assist button */
            #aiAssistBtn {
                background-color: rgb(75, 94, 170);
            }
            
            /* Hide button text */
            #saveBtn span, 
            #loadProjectBtn span, 
            #newProjectBtn span {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                position: absolute !important;
                opacity: 0 !important;
            }
            
            /* Hide button text on mobile with stronger specificity */
            #saveBtn span, 
            #loadProjectBtn span, 
            #newProjectBtn span {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                position: absolute !important;
                opacity: 0 !important;
            }
            
            /* Improve sidebar visibility and transition */
            .sidebar.active {
                transform: translateX(250px) !important;
                visibility: visible !important;
                display: block !important;
            }
            
            #sidebarOverlay.active {
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            /* When keyboard is visible, ensure input stays visible */
            .keyboard-visible {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                z-index: 100 !important;
                padding: 10px !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
                margin-bottom: env(safe-area-inset-bottom, 0) !important;
                transition: transform 0.3s ease !important;
            }
            
            /* Dark mode adjustments for mobile keyboard */
            .dark .keyboard-visible {
                background: var(--background) !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.3) !important;
            }
            
            /* Adjust AI panel layout when keyboard is active */
            #aiAssistPanel.keyboard-active {
                height: auto !important;
                bottom: 0 !important;
                top: 50px !important;
                overflow-y: auto !important;
            }
            
            /* Ensure chat history scrolls properly with keyboard visible */
            #aiAssistPanel.keyboard-active #chatHistory,
            #aiAssistPanel.keyboard-active #aiOutput {
                max-height: calc(100vh - 220px) !important;
            }
        }
    </style>
    <!-- AI Assistant Button Fix Script -->
    <script src="fix-ai-buttons.js"></script>
    
    <!-- PDF Export Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center modal" id="pdfExportModal">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-md-custom fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-primary">Export to PDF</h2>
                <button class="text-gray-400 hover:text-gray-600" id="closePdfExportModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Export Content</label>
                    <div class="space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="exportScope" value="current" class="form-radio text-primary" checked>
                            <span class="ml-2">Current Chapter</span>
                        </label>
                        <br>
                        <label class="inline-flex items-center">
                            <input type="radio" name="exportScope" value="project" class="form-radio text-primary">
                            <span class="ml-2">Entire Project</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Export Mode</label>
                    <div class="space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="exportMode" value="visual" class="form-radio text-primary" checked>
                            <span class="ml-2">Visual Mode (with formatting)</span>
                        </label>
                        <br>
                        <label class="inline-flex items-center">
                            <input type="radio" name="exportMode" value="text" class="form-radio text-primary">
                            <span class="ml-2">Text Only (more compatible)</span>
                        </label>
                        <p class="text-xs text-gray-500 ml-5 mt-1">Use Text Only if Visual Mode doesn't work</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filename</label>
                    <input type="text" id="pdfFilename" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" value="story-export.pdf">
                </div>
                
                <div class="flex flex-col space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Options</label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="includeChapterTitles" class="form-checkbox text-primary" checked>
                        <span class="ml-2">Include Chapter Titles</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="includeMetadata" class="form-checkbox text-primary" checked>
                        <span class="ml-2">Include Project Metadata</span>
                    </label>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Page Size</label>
                    <select id="pageSize" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                        <option value="a4">A4</option>
                        <option value="letter">Letter</option>
                        <option value="legal">Legal</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelExportBtn" class="btn btn-secondary">Cancel</button>
                    <button id="confirmExportBtn" class="btn btn-primary">Generate PDF</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PDF Export Script -->
    <script type="module">
        import { exportToPdf } from './lib/pdf-exporter.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            // Get elements
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const pdfExportModal = document.getElementById('pdfExportModal');
            const closePdfExportModal = document.getElementById('closePdfExportModal');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            
            // Export PDF Button
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', () => {
                    // Show the export modal
                    pdfExportModal.classList.remove('hidden');
                    pdfExportModal.classList.add('flex');
                    
                    // Set default filename based on project title
                    const projectTitle = window.appState?.currentProject?.title || 'story';
                    const sanitizedTitle = projectTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    document.getElementById('pdfFilename').value = `${sanitizedTitle}.pdf`;
                });
            }
            
            // Close Modal Buttons
            if (closePdfExportModal) {
                closePdfExportModal.addEventListener('click', closeModal);
            }
            
            if (cancelExportBtn) {
                cancelExportBtn.addEventListener('click', closeModal);
            }
            
            // Close modal function
            function closeModal() {
                pdfExportModal.classList.add('hidden');
                pdfExportModal.classList.remove('flex');
            }
            
            // Confirm Export Button
            if (confirmExportBtn) {
                confirmExportBtn.addEventListener('click', async () => {
                    try {
                        // Get export options from form
                        const exportScope = document.querySelector('input[name="exportScope"]:checked')?.value || 'current';
                        const exportMode = document.querySelector('input[name="exportMode"]:checked')?.value || 'visual';
                        const filename = document.getElementById('pdfFilename').value || 'story-export.pdf';
                        const includeChapterTitles = document.getElementById('includeChapterTitles')?.checked ?? true;
                        const includeMetadata = document.getElementById('includeMetadata')?.checked ?? true;
                        const pageSize = document.getElementById('pageSize')?.value || 'a4';
                        
                        // Close modal before starting export (shows loading overlay)
                        closeModal();
                        
                        // Export PDF with options
                        await exportToPdf({
                            exportEntireProject: exportScope === 'project',
                            filename,
                            includeChapterTitles,
                            includeMetadata,
                            pageSize,
                            useFallbackMode: exportMode === 'text'
                        });
                    } catch (error) {
                        console.error('PDF export error:', error);
                        showToast('PDF export failed: ' + error.message, 'error');
                    }
                });
            }
            
            // Helper function to show toast messages
            function showToast(message, type = 'success') {
                const toast = document.getElementById('aiToast');
                if (!toast) return;
                
                const toastText = toast.querySelector('p');
                if (toastText) toastText.textContent = message;
                
                toast.classList.remove('hidden');
                toast.classList.add('transform', 'translate-y-0');
                
                if (type === 'success') {
                    toast.classList.add('bg-success');
                    toast.classList.remove('bg-error');
                } else {
                    toast.classList.add('bg-error');
                    toast.classList.remove('bg-success');
                }
                
                setTimeout(() => {
                    toast.classList.add('translate-y-full');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                        toast.classList.remove('translate-y-full', 'bg-success', 'bg-error');
                    }, 300);
                }, 3000);
            }
        });
    </script>
</body>
</html> 
