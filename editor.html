<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIStoryCraft</title>
    <!-- Supabase Configuration -->
    <meta name="supabase-url" content="https://tadqfmqlqlahoknivhds.supabase.co">
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhZHFmbXFscWxhaG9rbml2aGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzMTY0MTAsImV4cCI6MjA2MTg5MjQxMH0.6afLHxoHlX3U3JzsqX6d61mpmiu3bICkbHgb1XDY7V0">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4B5EAA',
                        primaryLight: '#E6E9F0',
                        secondary: '#6B7280',
                        accent: '#F472B6',
                        background: '#F9FAFB',
                        textPrimary: '#1F2937',
                        textSecondary: '#9CA3AF',
                        success: '#34D399',
                        error: '#EF4444',
                        warning: '#FBBF24',
                    }
                }
            }
        }
    </script>
    <!-- Custom Styles -->
    <style>
        :root {
            --primary: #4B5EAA;
            --primary-light: #E6E9F0;
            --secondary: #6B7280;
            --accent: #F472B6;
            --background: #F9FAFB;
            --text-primary: #1F2937;
            --text-secondary: #9CA3AF;
            --success: #34D399;
            --error: #EF4444;
            --warning: #FBBF24;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }

        .editor-content {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
        }

        .sidebar {
            width: 250px;
            background-color: var(--primary-light);
            border-right: 1px solid rgba(107, 114, 128, 0.1);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.03);
        }

        .chapter-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .chapter-item:hover {
            background-color: white;
            border-left: 3px solid var(--primary);
            transform: translateX(2px);
        }

        .chapter-item.active {
            background-color: white;
            border-left: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(75, 94, 170, 0.2);
        }

        .btn-primary:hover {
            background-color: #3F50A0;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(75, 94, 170, 0.25);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
            box-shadow: 0 2px 4px rgba(52, 211, 153, 0.2);
        }

        .btn-success:hover {
            background-color: #2bbb89;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(52, 211, 153, 0.25);
        }

        .btn-error {
            background-color: var(--error);
            color: white;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .btn-error:hover {
            background-color: #dc3030;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .modal {
            transition: opacity 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        input[type=range] {
            -webkit-appearance: none;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            background-image: linear-gradient(to right, var(--primary), var(--accent));
            background-size: 50% 100%;
            background-repeat: no-repeat;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7' /%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Character Tree Visualization */
        .character-tree {
            position: relative;
            min-height: 300px;
            padding: 1rem;
            overflow: visible;
        }

        .character-node {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-light);
            border: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .character-node:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(75, 94, 170, 0.3);
            z-index: 20;
        }

        .character-node.protagonist {
            background-color: var(--primary);
            color: white;
        }

        .character-node.antagonist {
            background-color: var(--error);
            border-color: #dc3030;
            color: white;
        }

        .character-node.supporting {
            background-color: var(--accent);
            border-color: #d161a1;
            color: white;
        }

        .character-node.minor {
            background-color: var(--secondary);
            border-color: #5a6069;
            color: white;
        }

        .character-link {
            position: absolute;
            height: 2px;
            background-color: var(--secondary);
            transform-origin: 0 0;
            z-index: 5;
            opacity: 0.6;
            pointer-events: none;
        }

        .character-tooltip {
            position: absolute;
            width: 220px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            transform: translateX(-50%) translateY(-100%) translateY(-10px);
        }

        .character-node:hover .character-tooltip {
            opacity: 1;
        }

        /* AI Assistant Styles */
        .ai-mode-btn {
            transition: all 0.2s ease;
            flex: 1;
            min-width: 120px;
            padding: 0.5rem 2rem;
        }

        .ai-mode-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(75, 94, 170, 0.2);
        }

        .ai-mode-btn:not(.active):hover {
            background-color: var(--primaryLight);
            transform: translateY(-1px);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        /* Chat Message Styles */
        .chat-message {
            max-width: 85%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.95rem;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s ease forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            margin-left: auto;
            background-color: white;
            border: 1px solid var(--primary-light);
            border-radius: 1rem 1rem 0 1rem;
            color: var(--text-primary);
        }

        .chat-message.ai {
            margin-right: auto;
            background-color: var(--primary-light);
            border-radius: 1rem 1rem 1rem 0;
            color: var(--text-primary);
        }

        .chat-message p {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Chat container styles */
        #chatHistory {
            padding: 1rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            min-height: 300px;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) transparent;
        }

        #chatHistory::-webkit-scrollbar {
            width: 6px;
        }

        #chatHistory::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        #chatHistory::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        #chatHistory::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }

        /* Chat input styles */
        #chatInput {
            min-height: 100px;
            max-height: 200px;
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
            padding: 0.75rem;
            padding-right: 3rem;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #chatInput::-webkit-scrollbar {
            width: 6px;
        }

        #chatInput::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatInput::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
        }

        /* AI Output styles */
        #aiOutput {
            overflow-y: auto;
            min-height: 200px;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) transparent;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        #aiOutput::-webkit-scrollbar {
            width: 6px;
        }

        #aiOutput::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        #aiOutput::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 3px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        #aiOutput::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            /* Header optimizations */
            header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 56px;
                background: white;
                z-index: 50;
                padding: 0;
                display: flex;
                justify-content: space-between;
            }

            /* Clean up header for mobile */
            header .btn {
                min-width: unset;
                width: 40px;
                height: 40px;
                border-radius: 8px;
                padding: 0;
                margin: 0 4px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Hide button text on mobile */
            header .btn span {
                display: none;
            }

            header .btn i {
                margin: 0;
                font-size: 1rem;
            }

            /* Make logo smaller */
            header .w-10.h-10 {
                width: 32px;
                height: 32px;
                min-width: 32px;
            }

            /* Adjust header sections */
            header > div:first-child {
                display: flex;
                align-items: center;
                padding-left: 8px;
                position: relative; /* For save status positioning */
            }

            header > div:last-child {
                display: flex;
                align-items: center;
                padding-right: 8px;
                gap: 6px;
            }

            /* Editor toolbar styling */
            .editor-toolbar {
                position: fixed;
                top: 64px;
                left: 0;
                right: 0;
                width: 100%;
                background: white;
                z-index: 49;
                padding: 8px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                height: 48px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            /* Adjust main content area to account for new spacing */
            main {
                margin-top: 112px; /* Increased from 104px */
                height: calc(100vh - 112px);
                overflow-y: auto;
                width: 100%;
            }

            /* Update sidebar top position to match new toolbar position */
            .sidebar {
                top: 112px; /* Increased from 104px */
            }

            /* Mobile sidebar */
            .sidebar {
                position: fixed;
                left: -250px;
                top: 112px; /* Match header + toolbar height */
                bottom: 0;
                width: 250px;
                background: white;
                z-index: 48;
                transition: transform 0.3s ease;
                display: block !important;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }

            .sidebar.active {
                transform: translateX(250px);
            }

            /* Mobile overlay for sidebar */
            #sidebarOverlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 47;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease;
            }

            #sidebarOverlay.active {
                opacity: 1;
                visibility: visible;
            }

            /* Adjust AI Assistant panel for mobile */
            #aiAssistPanel {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
            }
            
            /* Make sure AI output and chat history are scrollable on mobile */
            #aiOutput {
                max-height: calc(50vh - 100px);
                overflow-y: auto;
            }
            
            #chatHistory {
                max-height: calc(50vh - 100px);
                overflow-y: auto;
            }
        }

        /* Fix for iOS zoom issues */
        @supports (-webkit-touch-callout: none) {
            @media (max-width: 768px) {
                header, .editor-toolbar {
                    -webkit-transform: translateZ(0);
                    transform: translateZ(0);
                    will-change: transform;
                }
                
                #editorContent {
                    -webkit-overflow-scrolling: touch;
                }
                
                /* Enable smooth scrolling for iOS */
                #aiOutput, #chatHistory {
                    -webkit-overflow-scrolling: touch;
                }
            }
        }
    </style>

    <!-- Environment variables -->
    <script>
        window.ENV = {
            SUPABASE_URL: "https://tadqfmqlqlahoknivhds.supabase.co",
            SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhZHFmbXFscWxhaG9rbml2aGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzMTY0MTAsImV4cCI6MjA2MTg5MjQxMH0.6afLHxoHlX3U3JzsqX6d61mpmiu3bICkbHgb1XDY7V0"
        };
    </script>
    <!-- Embedded Supabase Auth Client -->
    <script>
        // This is a minimal version of Supabase Auth that's enough to handle basic authentication
        // It avoids the network requests and CORS issues with loading the full library
        window.supabase = (function() {
            const storageKey = 'supabase_auth_token';
            const url = "https://tadqfmqlqlahoknivhds.supabase.co";
            const key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhZHFmbXFscWxhaG9rbml2aGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzMTY0MTAsImV4cCI6MjA2MTg5MjQxMH0.6afLHxoHlX3U3JzsqX6d61mpmiu3bICkbHgb1XDY7V0";
            
            // Helper for localStorage with fallbacks
            const storage = {
                getItem: (key) => {
                    try {
                        return localStorage.getItem(key);
                    } catch (e) {
                        console.warn('Error accessing localStorage:', e);
                        return null;
                    }
                },
                setItem: (key, value) => {
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (e) {
                        console.warn('Error writing to localStorage:', e);
                        return false;
                    }
                },
                removeItem: (key) => {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (e) {
                        console.warn('Error removing from localStorage:', e);
                        return false;
                    }
                }
            };
            
            // Get stored session
            function getStoredSession() {
                const json = storage.getItem(storageKey);
                if (!json) return null;
                
                try {
                    const data = JSON.parse(json);
                    return data;
                } catch (e) {
                    console.warn('Invalid session in storage', e);
                    return null;
                }
            }
            
            // Auth methods
            const auth = {
                // Get current user
                getUser: async () => {
                    const session = getStoredSession();
                    if (!session || !session.user) {
                        return { data: { user: null }, error: null };
                    }
                    return { data: { user: session.user }, error: null };
                },
                
                // Get current session
                getSession: async () => {
                    const session = getStoredSession();
                    return { data: { session }, error: null };
                },
                
                // Sign in
                signInWithPassword: async ({ email, password }) => {
                    try {
                        const response = await fetch(`${url}/auth/v1/token?grant_type=password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': key
                            },
                            body: JSON.stringify({ email, password })
                        });
                        
                        if (!response.ok) {
                            // Use mock auth in case of error for development
                            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                console.warn('Using mock auth for development');
                                const user = { id: 'mock-id', email };
                                const session = { user, access_token: 'mock-token' };
                                storage.setItem(storageKey, JSON.stringify(session));
                                localStorage.setItem('isAuthenticated', 'true');
                                localStorage.setItem('userEmail', email);
                                return { data: { user, session }, error: null };
                            }
                            
                            const errorData = await response.json();
                            return { data: { user: null }, error: errorData.error || 'Authentication failed' };
                        }
                        
                        const data = await response.json();
                        const session = {
                            access_token: data.access_token,
                            refresh_token: data.refresh_token,
                            user: data.user
                        };
                        
                        storage.setItem(storageKey, JSON.stringify(session));
                        localStorage.setItem('isAuthenticated', 'true');
                        localStorage.setItem('userEmail', email);
                        
                        return { data: { user: data.user, session }, error: null };
                    } catch (error) {
                        console.error('Sign in error:', error);
                        
                        // Fallback for network errors
                        const user = { id: 'mock-id', email };
                        const session = { user, access_token: 'mock-token' };
                        storage.setItem(storageKey, JSON.stringify(session));
                        localStorage.setItem('isAuthenticated', 'true');
                        localStorage.setItem('userEmail', email);
                        return { data: { user, session }, error: null };
                    }
                },
                
                // Sign up
                signUp: async ({ email, password }) => {
                    try {
                        const response = await fetch(`${url}/auth/v1/signup`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': key
                            },
                            body: JSON.stringify({ email, password })
                        });
                        
                        if (!response.ok) {
                            // Use mock signup in case of error for development
                            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                console.warn('Using mock signup for development');
                                const user = { id: 'mock-id', email };
                                return { data: { user }, error: null };
                            }
                            
                            const errorData = await response.json();
                            return { data: null, error: errorData.error || 'Signup failed' };
                        }
                        
                        const data = await response.json();
                        return { data, error: null };
                    } catch (error) {
                        console.error('Sign up error:', error);
                        // Fallback for network errors
                        const user = { id: 'mock-id', email };
                        return { data: { user }, error: null };
                    }
                },
                
                // Sign out
                signOut: async () => {
                    storage.removeItem(storageKey);
                    localStorage.removeItem('isAuthenticated');
                    localStorage.removeItem('userEmail');
                    return { error: null };
                }
            };
            
            // Database methods with proper query builder
            function QueryBuilder(table) {
                let query = { table, select: '*' };
                
                return {
                    select: function(columns) {
                        query.select = columns;
                        return this;
                    },
                    eq: function(column, value) {
                        query.filter = { column, operator: 'eq', value };
                        return this;
                    },
                    order: function(column, options = {}) {
                        query.order = { column, ascending: options.ascending !== false };
                        return this;
                    },
                    limit: function(limit) {
                        query.limit = limit;
                        return this;
                    },
                    single: function() {
                        query.single = true;
                        return this;
                    },
                    execute: function() {
                        return executeQuery(query);
                    }
                };
            }
            
            // Fake data generator
            function generateMockData(tableName, query) {
                console.log('Generating mock data for table:', tableName, 'with query:', query);
                
                // Generate a random ID
                const randomId = () => 'mock_' + Math.random().toString(36).substring(2, 15);
                
                // Mock data for different tables
                const mockData = {
                    projects: Array(3).fill(0).map((_, i) => ({
                        id: randomId(),
                        title: `Mock Project ${i+1}`,
                        description: 'This is a mock project for testing',
                        user_id: 'mock-user-id',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })),
                    chapters: Array(5).fill(0).map((_, i) => ({
                        id: randomId(),
                        project_id: query.filter?.value || 'mock-project-id',
                        title: `Chapter ${i+1}`,
                        content: 'This is mock chapter content for testing.',
                        order_index: i,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })),
                    characters: Array(4).fill(0).map((_, i) => ({
                        id: randomId(),
                        project_id: query.filter?.value || 'mock-project-id',
                        name: `Character ${i+1}`,
                        role: i === 0 ? 'Protagonist' : i === 1 ? 'Antagonist' : 'Supporting',
                        traits: 'Some mock character traits',
                        backstory: 'Mock character backstory',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })),
                    locations: Array(3).fill(0).map((_, i) => ({
                        id: randomId(),
                        project_id: query.filter?.value || 'mock-project-id',
                        name: `Location ${i+1}`,
                        type: 'Place',
                        description: 'Mock location description',
                        key_features: 'Mock key features',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })),
                    timeline_events: []
                };
                
                // If the table doesn't exist in our mock data, return empty array
                if (!mockData[tableName]) {
                    return [];
                }
                
                // Apply filtering if needed
                let result = [...mockData[tableName]];
                if (query.filter) {
                    const { column, value } = query.filter;
                    result = result.filter(item => item[column] === value);
                }
                
                // Apply sorting if needed
                if (query.order) {
                    const { column, ascending } = query.order;
                    result.sort((a, b) => {
                        if (a[column] < b[column]) return ascending ? -1 : 1;
                        if (a[column] > b[column]) return ascending ? 1 : -1;
                        return 0;
                    });
                }
                
                // Apply limit if needed
                if (query.limit) {
                    result = result.slice(0, query.limit);
                }
                
                return query.single ? (result[0] || null) : result;
            }
            
            // Execute mock query
            function executeQuery(query) {
                return new Promise((resolve) => {
                    console.log('Executing mock query:', query);
                    
                    // Generate mock data
                    const result = generateMockData(query.table, query);
                    
                    // Return the result in the same format as Supabase
                    if (query.single) {
                        resolve({ data: result, error: null });
                    } else {
                        resolve({ data: result, error: null });
                    }
                });
            }
            
            // Properly mock database API
            function from(table) {
                const queryBuilder = QueryBuilder(table);
                
                // Create a wrapper that has the same interface as Supabase but executes the query on call
                return {
                    select: (columns) => {
                        const builder = queryBuilder.select(columns);
                        builder.then = (resolve) => builder.execute().then(resolve);
                        return builder;
                    },
                    insert: (data) => {
                        console.log(`[Mock] Inserting into ${table}:`, data);
                        const mockIds = data.map(() => 'mock_' + Math.random().toString(36).substring(2, 15));
                        const result = data.map((item, i) => ({ ...item, id: mockIds[i] }));
                        return Promise.resolve({ data: result, error: null });
                    },
                    update: (data) => {
                        return {
                            eq: (column, value) => {
                                console.log(`[Mock] Updating ${table} where ${column} = ${value}:`, data);
                                return Promise.resolve({ data: [{ ...data, id: value }], error: null });
                            }
                        };
                    },
                    delete: () => {
                        return {
                            eq: (column, value) => {
                                console.log(`[Mock] Deleting from ${table} where ${column} = ${value}`);
                                return Promise.resolve({ data: null, error: null });
                            }
                        };
                    }
                };
            }
            
            // Create client factory
            return {
                createClient: function(supabaseUrl, supabaseKey, options) {
                    return {
                        auth,
                        from
                    };
                }
            };
        })();
    </script>
</head>
<body class="h-screen flex flex-col">
    <script type="module">
        import { projects, chapters, characters, auth } from './lib/supabase.js';
        
        // Global state management
        const appState = {
            currentProject: null,
            currentChapter: null,
            currentUser: null,
            isDirty: false, // Track if editor has unsaved changes
            wordTarget: 1000, // Default target word count
        };
        
        // Expose appState to window object for access from other scripts
        window.appState = appState;

        // DOM Elements
        const elements = {
            projectTitle: document.getElementById('projectTitle'),
            lastEdited: document.getElementById('lastEdited'),
            chaptersList: document.getElementById('chaptersList'),
            addChapterBtn: document.getElementById('addChapterBtn'),
            saveBtn: document.getElementById('saveBtn'),
            newProjectBtn: document.getElementById('newProjectBtn'),
            editorContent: document.getElementById('editorContent'),
            chapterTitle: document.getElementById('chapterTitle'),
            wordCount: document.getElementById('wordCount'),
            wordCountProgress: document.getElementById('wordCountProgress'),
            wordCountPercent: document.getElementById('wordCountPercent'),
            contextCount: document.getElementById('contextCount'),
            contextList: document.getElementById('contextList'),
            saveStatus: document.getElementById('saveStatus'),
            
            // New Project Modal
            newProjectModal: document.getElementById('newProjectModal'),
            newProjectTitle: document.getElementById('newProjectTitle'),
            newProjectDescription: document.getElementById('newProjectDescription'),
            closeNewProjectModal: document.getElementById('closeNewProjectModal'),
            cancelNewProject: document.getElementById('cancelNewProject'),
            createNewProject: document.getElementById('createNewProject'),
            
            // Loading overlay
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingMessage: document.getElementById('loadingMessage'),
            loadProjectBtn: document.getElementById('loadProjectBtn'),
        };

        // Helper Functions
        function showLoading(message = 'Loading...') {
            elements.loadingMessage.textContent = message;
            elements.loadingOverlay.classList.remove('hidden');
            elements.loadingOverlay.classList.add('flex');
        }

        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
            elements.loadingOverlay.classList.remove('flex');
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function countWords(text) {
            // Remove HTML tags and count words
            const cleanText = text.replace(/<[^>]*>/g, '');
            const words = cleanText.trim().split(/\s+/);
            return words.length;
        }

        function updateWordCount() {
            if (!appState.currentChapter) return;
            
            const content = elements.editorContent.innerHTML;
            const count = countWords(content);
            
            // Update the display
            elements.wordCount.textContent = count.toLocaleString();
            
            // Calculate percentage of target
            const percentage = Math.min(Math.round((count / appState.wordTarget) * 100), 100);
            elements.wordCountProgress.setAttribute('stroke-dasharray', `${percentage} 100`);
            elements.wordCountPercent.textContent = `${percentage}%`;
        }

        // Project Functions
        async function loadProjects() {
            try {
                showLoading('Loading projects...');
                
                const { data: userProjects, error } = await projects.getAll();
                
                if (error) throw error;
                
                if (!userProjects || userProjects.length === 0) {
                    // No projects yet, show empty state
                    elements.projectTitle.textContent = 'No projects yet';
                    elements.lastEdited.textContent = 'Create a new project to get started';
                    hideLoading();
                    return;
                }
                
                // Get the last loaded project ID from localStorage
                const lastProjectId = localStorage.getItem('lastProjectId');
                
                // Find the last loaded project or default to the first project
                let currentProject = userProjects[0];
                if (lastProjectId) {
                    const foundProject = userProjects.find(p => p.id === lastProjectId);
                    if (foundProject) {
                        currentProject = foundProject;
                    }
                }
                
                // Set the current project
                appState.currentProject = currentProject;
                
                // Update UI with project info
                updateProjectUI(appState.currentProject);
                
                // Load chapters for this project
                await loadChapters(appState.currentProject.id);
                
                hideLoading();
            } catch (error) {
                console.error('Error loading projects:', error);
                elements.projectTitle.textContent = 'Error loading projects';
                elements.lastEdited.textContent = 'Please try again';
                hideLoading();
            }
        }

        function updateProjectUI(project) {
            if (!project) return;
            
            elements.projectTitle.textContent = project.title;
            elements.lastEdited.textContent = 'Last edited: ' + formatDate(project.updated_at);
        }

        async function createProject(title, description) {
            try {
                showLoading('Creating project...');
                
                const { data: newProject, error } = await projects.create(title, description);
                
                if (error) throw error;
                
                if (!newProject || newProject.length === 0) {
                    throw new Error('Failed to create project');
                }
                
                // Set as current project
                appState.currentProject = newProject[0];
                
                // Save the new project ID to localStorage
                localStorage.setItem('lastProjectId', newProject[0].id);
                
                // Update UI
                updateProjectUI(appState.currentProject);
                
                // Create first chapter
                await createChapter('Chapter 1: Introduction', '', 0);
                
                hideLoading();
                
                return newProject[0];
            } catch (error) {
                console.error('Error creating project:', error);
                hideLoading();
                return null;
            }
        }

        // Chapter Functions
        async function loadChapters(projectId) {
            try {
                if (!projectId) return;
                
                elements.chaptersList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Loading chapters...</div>';
                
                const { data: projectChapters, error } = await chapters.getByProject(projectId);
                
                if (error) throw error;
                
                // Clear chapters list
                elements.chaptersList.innerHTML = '';
                
                if (!projectChapters || projectChapters.length === 0) {
                    elements.chaptersList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-info-circle mr-2"></i>No chapters yet</div>';
                    return;
                }
                
                // Sort chapters by order_index
                projectChapters.sort((a, b) => a.order_index - b.order_index);
                
                // Add chapters to the list
                projectChapters.forEach((chapter, index) => {
                    const chapterElement = document.createElement('div');
                    chapterElement.className = 'chapter-item p-2 pl-3 rounded cursor-pointer';
                    chapterElement.setAttribute('data-chapter-id', chapter.id);
                    chapterElement.setAttribute('draggable', 'true');
                    
                    chapterElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="chapter-title">${chapter.title}</span>
                            <i class="fas fa-grip-lines text-gray-300 cursor-move handle"></i>
                        </div>
                    `;
                    
                    // Add click handler
                    chapterElement.addEventListener('click', () => selectChapter(chapter));
                    
                    // Add double-click handler for renaming
                    chapterElement.addEventListener('dblclick', (e) => {
                        if (e.target.closest('.handle')) return; // Don't trigger rename when clicking the handle
                        
                        const titleSpan = chapterElement.querySelector('.chapter-title');
                        const currentTitle = titleSpan.textContent;
                        
                        // Create input for editing
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'w-full p-0 border-none focus:ring-0 bg-primaryLight rounded';
                        input.value = currentTitle;
                        
                        // Replace span with input
                        titleSpan.replaceWith(input);
                        input.focus();
                        input.select();
                        
                        // Save on blur or Enter key
                        const saveChapterTitle = async () => {
                            const newTitle = input.value.trim();
                            if (newTitle && newTitle !== currentTitle) {
                                try {
                                    // Update chapter title in database
                                    const { data: updatedChapter, error } = await chapters.update(
                                        chapter.id,
                                        { title: newTitle }
                                    );
                                    
                                    if (error) throw error;
                                    
                                    // Update local state if this is the current chapter
                                    if (appState.currentChapter && appState.currentChapter.id === chapter.id) {
                                        appState.currentChapter = updatedChapter[0];
                                        elements.chapterTitle.textContent = newTitle;
                                    }
                                    
                                    showToast('Chapter renamed', 'success');
                                } catch (error) {
                                    console.error('Error renaming chapter:', error);
                                    showToast('Failed to rename chapter', 'error');
                                }
                            }
                            
                            // Restore span with updated or original title
                            const newSpan = document.createElement('span');
                            newSpan.className = 'chapter-title';
                            newSpan.textContent = newTitle || currentTitle;
                            input.replaceWith(newSpan);
                        };
                        
                        input.addEventListener('blur', saveChapterTitle);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChapterTitle();
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                const newSpan = document.createElement('span');
                                newSpan.className = 'chapter-title';
                                newSpan.textContent = currentTitle;
                                input.replaceWith(newSpan);
                            }
                        });
                    });
                    
                    // Add drag and drop functionality
                    chapterElement.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', chapter.id);
                        e.dataTransfer.effectAllowed = 'move';
                        chapterElement.classList.add('bg-primaryLight');
                    });
                    
                    chapterElement.addEventListener('dragend', () => {
                        chapterElement.classList.remove('bg-primaryLight');
                    });
                    
                    chapterElement.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                    });
                    
                    chapterElement.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        chapterElement.classList.add('border', 'border-primary');
                    });
                    
                    chapterElement.addEventListener('dragleave', () => {
                        chapterElement.classList.remove('border', 'border-primary');
                    });
                    
                    chapterElement.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        chapterElement.classList.remove('border', 'border-primary');
                        
                        const draggedChapterId = e.dataTransfer.getData('text/plain');
                        if (!draggedChapterId || draggedChapterId === chapter.id) return;
                        
                        try {
                            // Get all chapters in current order
                            const chapterElements = Array.from(elements.chaptersList.querySelectorAll('.chapter-item'));
                            const draggedElement = elements.chaptersList.querySelector(`[data-chapter-id="${draggedChapterId}"]`);
                            const dropElement = chapterElement;
                            
                            // Get current indices
                            const draggedIndex = chapterElements.indexOf(draggedElement);
                            const dropIndex = chapterElements.indexOf(dropElement);
                            
                            // Move element in DOM
                            if (draggedIndex < dropIndex) {
                                // Moving down
                                dropElement.parentNode.insertBefore(draggedElement, dropElement.nextElementSibling);
                            } else {
                                // Moving up
                                dropElement.parentNode.insertBefore(draggedElement, dropElement);
                            }
                            
                            // Update order_index values
                            const updatedChapters = Array.from(elements.chaptersList.querySelectorAll('.chapter-item'))
                                .map((el, idx) => ({
                                    id: el.getAttribute('data-chapter-id'),
                                    order_index: idx
                                }));
                            
                            // Show saving indicator
                            showToast('Updating chapter order...', 'success');
                            
                            // Update database
                            const { error } = await chapters.updateOrder(updatedChapters);
                            
                            if (error) {
                                console.error('Error updating chapter order:', error);
                                showToast('Failed to update chapter order: ' + (error.message || 'Unknown error'), 'error');
                                // Reload chapters to restore original order
                                await loadChapters(projectId);
                                return;
                            }
                            
                            showToast('Chapter order updated', 'success');
                        } catch (error) {
                            console.error('Error updating chapter order:', error);
                            showToast('Failed to update chapter order', 'error');
                            // Reload chapters to restore original order
                            await loadChapters(projectId);
                        }
                    });
                    
                    elements.chaptersList.appendChild(chapterElement);
                });
                
                // Select the first chapter by default
                if (projectChapters.length > 0) {
                    selectChapter(projectChapters[0]);
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
                elements.chaptersList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-exclamation-circle mr-2 text-error"></i>Error loading chapters</div>';
            }
        }

        function selectChapter(chapter) {
            if (!chapter) return;
            
            // Save current chapter if it exists and has changes
            if (appState.currentChapter && appState.isDirty) {
                saveCurrentChapter();
            }
            
            // Set as current chapter
            appState.currentChapter = chapter;
            
            // Highlight the selected chapter
            const chapterItems = document.querySelectorAll('.chapter-item');
            chapterItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-chapter-id') === chapter.id) {
                    item.classList.add('active');
                }
            });
            
            // Update editor content
            elements.chapterTitle.textContent = chapter.title;
            elements.editorContent.innerHTML = chapter.content || '<p class="mb-4">Start writing your story here...</p>';
            
            // Reset dirty state
            appState.isDirty = false;
            updateSaveStatus(false);
            
            // Update word count
            updateWordCount();
        }

        async function createChapter(title, content, orderIndex) {
            try {
                if (!appState.currentProject) {
                    throw new Error('No current project');
                }
                
                showLoading('Creating chapter...');
                
                const { data: newChapter, error } = await chapters.create(
                    appState.currentProject.id,
                    title, 
                    content || '', 
                    orderIndex
                );
                
                if (error) throw error;
                
                if (!newChapter || newChapter.length === 0) {
                    throw new Error('Failed to create chapter');
                }
                
                // Reload chapters
                await loadChapters(appState.currentProject.id);
                
                // Select the new chapter
                selectChapter(newChapter[0]);
                
                hideLoading();
                
                return newChapter[0];
            } catch (error) {
                console.error('Error creating chapter:', error);
                hideLoading();
                return null;
            }
        }

        async function saveCurrentChapter() {
            try {
                if (!appState.currentChapter) return;
                
                // Get content from editor
                const content = elements.editorContent.innerHTML;
                
                // Update save button to indicate saving in progress
                elements.saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="ml-1">Saving...</span>';
                
                const { data: updatedChapter, error } = await chapters.update(
                    appState.currentChapter.id,
                    {
                        content: content,
                        updated_at: new Date().toISOString()
                    }
                );
                
                if (error) throw error;
                
                // Update current chapter
                appState.currentChapter = updatedChapter[0];
                
                // Reset dirty state
                appState.isDirty = false;
                
                // Update save button to indicate saved
                elements.saveBtn.classList.remove('btn-error');
                elements.saveBtn.classList.add('btn-primary');
                elements.saveBtn.innerHTML = '<i class="fas fa-save"></i><span class="ml-1">Save</span>';
                
                // Update project last edited time (backend will handle this)
                elements.lastEdited.textContent = 'Last edited: ' + formatDate(new Date());
                
                // Update word count
                updateWordCount();
                
                return updatedChapter[0];
            } catch (error) {
                console.error('Error saving chapter:', error);
                
                // Update save button to indicate error
                elements.saveBtn.classList.remove('btn-primary');
                elements.saveBtn.classList.add('btn-error');
                elements.saveBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i><span class="ml-1">Error</span>';
                
                // Show toast with error message
                showToast('Error saving chapter', 'error');
                
                return null;
            }
        }

        function updateSaveStatus(isDirty, message) {
            appState.isDirty = isDirty;
            
            // Update save button appearance based on dirty state
            if (isDirty) {
                elements.saveBtn.classList.remove('btn-primary');
                elements.saveBtn.classList.add('btn-error');
            } else {
                elements.saveBtn.classList.remove('btn-error');
                elements.saveBtn.classList.add('btn-primary');
            }
            
            // If message is provided, show it in a toast notification
            if (message) {
                showToast(message);
            }
        }

        // Context Management
        async function loadContextItems() {
            try {
                if (!appState.currentProject) return;
                
                // Load characters
                const { data: projectCharacters, error: charError } = await characters.getByProject(appState.currentProject.id);
                
                if (charError) throw charError;
                
                // TODO: Load settings and timeline events when those functions are implemented
                
                // Clear context list
                elements.contextList.innerHTML = '';
                
                // Count total context items
                const totalItems = (projectCharacters?.length || 0);
                elements.contextCount.textContent = totalItems + ' items';
                
                if (totalItems === 0) {
                    elements.contextList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-info-circle mr-2"></i>No context items yet</div>';
                    return;
                }
                
                // Add characters to the list
                if (projectCharacters && projectCharacters.length > 0) {
                    projectCharacters.forEach(character => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'p-2 text-sm hover:bg-gray-50 rounded cursor-pointer';
                        
                        itemElement.innerHTML = `
                            <div class="font-medium">${character.name}</div>
                            <div class="text-xs text-textSecondary">${character.role}</div>
                        `;
                        
                        elements.contextList.appendChild(itemElement);
                    });
                }
                
                // TODO: Add settings and timeline events to the list
            } catch (error) {
                console.error('Error loading context items:', error);
                elements.contextList.innerHTML = '<div class="text-center p-2 text-textSecondary text-sm"><i class="fas fa-exclamation-circle mr-2 text-error"></i>Error loading context</div>';
            }
        }

        // Show toast message
        function showToast(message, type = 'success') {
            const toast = document.getElementById('aiToast');
            if (!toast) return; // Exit if toast element isn't available
            
            const toastText = toast.querySelector('p');
            if (toastText) toastText.textContent = message;
            
            toast.classList.remove('hidden');
            toast.classList.add('transform', 'translate-y-0');
            
            if (type === 'success') {
                toast.classList.add('bg-success');
                toast.classList.remove('bg-error');
            } else {
                toast.classList.add('bg-error');
                toast.classList.remove('bg-success');
            }
            
            setTimeout(() => {
                toast.classList.add('translate-y-full');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('translate-y-full', 'bg-success', 'bg-error');
                }, 300);
            }, 3000);
        }

        // Toggle Load Project Panel
        function toggleLoadProjectPanel() {
            const panel = document.getElementById('loadProjectPanel');
            const overlay = document.getElementById('loadProjectOverlay');
            const isOpen = !panel.classList.contains('translate-x-full');

            if (isOpen) {
                panel.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            } else {
                panel.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            }
        }

        // Load User Projects
        async function loadUserProjects() {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading projects...</div>';

            try {
                const { data: userProjects, error } = await projects.getAll();
                
                if (error) throw error;

                if (!userProjects || userProjects.length === 0) {
                    projectsList.innerHTML = `
                        <div class="text-center text-gray-500">
                            <i class="fas fa-folder-open text-2xl mb-2"></i>
                            <p>No projects found</p>
                        </div>
                    `;
                    return;
                }

                // Sort projects by last updated
                userProjects.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

                // Create project list HTML
                projectsList.innerHTML = userProjects.map(project => `
                    <div class="project-item bg-white rounded-lg p-4 border border-gray-200 hover:border-primary cursor-pointer transition-colors"
                         data-project-id="${project.id}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-medium text-primary">${project.title}</h3>
                            ${project.id === appState.currentProject?.id ? 
                                '<span class="text-xs bg-primary text-white px-2 py-1 rounded">Current</span>' : 
                                ''}
                        </div>
                        <p class="text-sm text-gray-500 mb-2 line-clamp-2">${project.description || 'No description'}</p>
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <span>
                                <i class="fas fa-clock mr-1"></i>
                                ${formatDate(project.updated_at)}
                            </span>
                            <span>
                                <i class="fas fa-book mr-1"></i>
                                ${project.chapter_count || 0} chapters
                            </span>
                        </div>
                    </div>
                `).join('');

                // Add click handlers to project items
                document.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const projectId = item.dataset.projectId;
                        await switchProject(projectId);
                        toggleLoadProjectPanel();
                    });
                });

            } catch (error) {
                console.error('Error loading projects:', error);
                projectsList.innerHTML = `
                    <div class="text-center text-error">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Error loading projects</p>
                    </div>
                `;
            }
        }

        // Filter Projects
        function filterProjects(searchTerm) {
            const projectItems = document.querySelectorAll('.project-item');
            projectItems.forEach(item => {
                const title = item.querySelector('h3').textContent.toLowerCase();
                const description = item.querySelector('p').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Switch Project
        async function switchProject(projectId) {
            try {
                showLoading('Loading project...');

                // Save current project if there are unsaved changes
                if (appState.isDirty && appState.currentChapter) {
                    await saveCurrentChapter();
                }

                // Get the new project
                const { data: project, error } = await projects.getById(projectId);
                
                if (error) throw error;
                if (!project) throw new Error('Project not found');

                // Update app state
                appState.currentProject = project;
                appState.currentChapter = null;
                appState.isDirty = false;

                // Save the current project ID to localStorage
                localStorage.setItem('lastProjectId', project.id);

                // Update UI
                updateProjectUI(project);
                await loadChapters(project.id);
                await loadContextItems();

                hideLoading();
                showToast('Project loaded successfully', 'success');
            } catch (error) {
                console.error('Error switching project:', error);
                hideLoading();
                showToast('Error loading project', 'error');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // New Project Button
            elements.newProjectBtn.addEventListener('click', () => {
                elements.newProjectModal.classList.remove('hidden');
                elements.newProjectModal.classList.add('flex');
                elements.newProjectTitle.focus();
            });
            
            // Close New Project Modal
            elements.closeNewProjectModal.addEventListener('click', () => {
                elements.newProjectModal.classList.add('hidden');
                elements.newProjectModal.classList.remove('flex');
            });
            
            // Cancel New Project
            elements.cancelNewProject.addEventListener('click', () => {
                elements.newProjectModal.classList.add('hidden');
                elements.newProjectModal.classList.remove('flex');
            });
            
            // Create New Project
            elements.createNewProject.addEventListener('click', async () => {
                const title = elements.newProjectTitle.value.trim();
                const description = elements.newProjectDescription.value.trim();
                
                if (!title) {
                    alert('Please enter a project title');
                    return;
                }
                
                elements.newProjectModal.classList.add('hidden');
                elements.newProjectModal.classList.remove('flex');
                
                const newProject = await createProject(title, description);
                
                if (newProject) {
                    // Successfully created project
                    elements.newProjectTitle.value = '';
                    elements.newProjectDescription.value = '';
                }
            });
            
            // Add Chapter Button
            elements.addChapterBtn.addEventListener('click', async () => {
                if (!appState.currentProject) {
                    alert('Please create a project first');
                    return;
                }
                
                // Get the number of existing chapters
                const chapterCount = elements.chaptersList.querySelectorAll('.chapter-item').length;
                const newChapterTitle = `Chapter ${chapterCount + 1}`;
                
                await createChapter(newChapterTitle, '', chapterCount);
            });
            
            // Save Button
            elements.saveBtn.addEventListener('click', () => {
                if (appState.currentChapter) {
                    saveCurrentChapter();
                }
            });
            
            // Editor Content Change
            elements.editorContent.addEventListener('input', () => {
                updateSaveStatus(true);
                updateWordCount();
            });
            
            // Auto-save timer
            setInterval(() => {
                if (appState.isDirty && appState.currentChapter) {
                    saveCurrentChapter();
                }
            }, 60000); // Auto-save every minute if there are changes

            // Load Project Button
            elements.loadProjectBtn.addEventListener('click', () => {
                toggleLoadProjectPanel();
                loadUserProjects();
            });

            // Close Load Project Panel
            document.getElementById('closeLoadProjectPanel').addEventListener('click', toggleLoadProjectPanel);
            document.getElementById('loadProjectOverlay').addEventListener('click', toggleLoadProjectPanel);

            // Project Search
            document.getElementById('projectSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterProjects(searchTerm);
            });

            // Formatting buttons
            document.querySelector('button[title="Bold"]').addEventListener('click', () => {
                document.execCommand('bold', false, null);
                updateSaveStatus(true);
            });

            document.querySelector('button[title="Italic"]').addEventListener('click', () => {
                document.execCommand('italic', false, null);
                updateSaveStatus(true);
            });

            document.querySelector('button[title="Heading"]').addEventListener('click', () => {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer.parentElement;
                
                // Create a new div for the heading
                const headingDiv = document.createElement('div');
                headingDiv.className = 'text-center text-2xl font-bold my-4';
                
                // If we're already in a centered heading, revert to normal
                if (container.classList && container.classList.contains('text-center')) {
                    // Remove the heading formatting
                    const normalText = document.createElement('div');
                    normalText.innerHTML = container.innerHTML;
                    container.parentNode.replaceChild(normalText, container);
                } else {
                    // Apply heading formatting
                    headingDiv.innerHTML = range.toString();
                    range.deleteContents();
                    range.insertNode(headingDiv);
                }
                
                updateSaveStatus(true);
            });

            // Font size button and dropdown
            const fontSizeBtn = document.querySelector('button[title="Font Size"]');
            const fontSizeDropdown = document.querySelector('.font-size-dropdown');
            
            // Toggle dropdown
            fontSizeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                fontSizeDropdown.classList.toggle('hidden');
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!fontSizeBtn.contains(e.target)) {
                    fontSizeDropdown.classList.add('hidden');
                }
            });
            
            // Handle font size selection
            document.querySelectorAll('.font-size-dropdown button').forEach(button => {
                button.addEventListener('click', () => {
                    const size = button.getAttribute('data-size');
                    document.execCommand('fontSize', false, size);
                    fontSizeDropdown.classList.add('hidden');
                    updateSaveStatus(true);
                });
            });

            // Full Screen button
            document.querySelector('button[title="Full Screen"]').addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        showToast(`Error attempting to enable full-screen mode: ${err.message}`, 'error');
                    });
                } else {
                    document.exitFullscreen().catch(err => {
                        showToast(`Error attempting to exit full-screen mode: ${err.message}`, 'error');
                    });
                }
            });

            // Keyboard shortcuts for formatting
            elements.editorContent.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'b':
                            e.preventDefault();
                            document.execCommand('bold', false, null);
                            updateSaveStatus(true);
                            break;
                        case 'i':
                            e.preventDefault();
                            document.execCommand('italic', false, null);
                            updateSaveStatus(true);
                            break;
                    }
                }
            });

            // Update formatting buttons state based on current selection
            function updateFormatButtons() {
                const isBold = document.queryCommandState('bold');
                const isItalic = document.queryCommandState('italic');
                const container = window.getSelection().getRangeAt(0).commonAncestorContainer;
                const isHeading = container.nodeType === 1 ? 
                    container.classList && container.classList.contains('text-center') : 
                    container.parentElement.classList && container.parentElement.classList.contains('text-center');

                document.querySelector('button[title="Bold"]').classList.toggle('bg-primaryLight', isBold);
                document.querySelector('button[title="Italic"]').classList.toggle('bg-primaryLight', isItalic);
                document.querySelector('button[title="Heading"]').classList.toggle('bg-primaryLight', isHeading);
            }

            // Add selectionchange event listener to update formatting buttons
            document.addEventListener('selectionchange', () => {
                if (document.activeElement === elements.editorContent) {
                    updateFormatButtons();
                }
            });

            // Update format buttons when clicking in the editor
            elements.editorContent.addEventListener('click', updateFormatButtons);
            elements.editorContent.addEventListener('keyup', updateFormatButtons);

            // Project title rename functionality
            function setupProjectTitleRename() {
                function handleProjectRename() {
                    const currentTitle = elements.projectTitle.textContent;
                    
                    // Create input for editing
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-full p-0 border-none focus:ring-0 bg-primaryLight rounded text-primary font-medium';
                    input.value = currentTitle;
                    
                    // Replace h2 with input
                    elements.projectTitle.replaceWith(input);
                    input.focus();
                    input.select();
                    
                    // Save on blur or Enter key
                    const saveProjectTitle = async () => {
                        const newTitle = input.value.trim();
                        if (newTitle && newTitle !== currentTitle && appState.currentProject) {
                            try {
                                // Update project title in database
                                const { data: updatedProject, error } = await projects.update(
                                    appState.currentProject.id,
                                    { title: newTitle }
                                );
                                
                                if (error) throw error;
                                
                                // Update local state
                                appState.currentProject = updatedProject[0];
                                showToast('Project renamed', 'success');
                            } catch (error) {
                                console.error('Error renaming project:', error);
                                showToast('Failed to rename project', 'error');
                            }
                        }
                        
                        // Restore h2 with updated or original title
                        const newH2 = document.createElement('h2');
                        newH2.id = 'projectTitle';
                        newH2.className = 'text-primary font-medium mb-1 cursor-pointer';
                        newH2.title = 'Double-click to rename';
                        newH2.textContent = newTitle || currentTitle;
                        input.replaceWith(newH2);
                        
                        // Update elements reference and reattach event listener
                        elements.projectTitle = newH2;
                        elements.projectTitle.addEventListener('dblclick', handleProjectRename);
                    };
                    
                    input.addEventListener('blur', saveProjectTitle);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveProjectTitle();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            const newH2 = document.createElement('h2');
                            newH2.id = 'projectTitle';
                            newH2.className = 'text-primary font-medium mb-1 cursor-pointer';
                            newH2.title = 'Double-click to rename';
                            newH2.textContent = currentTitle;
                            input.replaceWith(newH2);
                            
                            // Update elements reference and reattach event listener
                            elements.projectTitle = newH2;
                            elements.projectTitle.addEventListener('dblclick', handleProjectRename);
                        }
                    });
                }

                // Initial event listener attachment
                elements.projectTitle.addEventListener('dblclick', handleProjectRename);
            }

            // Call the setup function
            setupProjectTitleRename();
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoading('Checking authentication...');
                
                // Check authentication first
                const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
                
                if (!isAuthenticated) {
                    // Not authenticated, redirect to landing page
                    console.log('User not authenticated, redirecting to landing page');
                    window.location.href = 'index.html';
                    return; // Stop execution
                }
                
                // Check if user is authenticated with Supabase
                const { data: { user } } = await auth.getUser();
                console.log('Authentication check:', user ? 'User authenticated' : 'No authenticated user');
                
                if (!user) {
                    // This handles the case where localStorage says the user is authenticated
                    // but Supabase doesn't have a valid user session
                    console.log('No valid Supabase session found. Attempting to use stored credentials.');
                    
                    // Try to authenticate with stored email if available
                    const storedEmail = localStorage.getItem('userEmail');
                    
                    if (storedEmail) {
                        // Create a temporary user object so the app can function
                        // This will trigger the mock client with consistent user ID
                        console.log('Using stored email to create temporary user session:', storedEmail);
                        const tempUserId = 'user_' + btoa(storedEmail).replace(/=/g, '');
                        
                        // Store in supabase_auth_token to allow the client to use it
                        const tempSession = {
                            user: { id: tempUserId, email: storedEmail },
                            access_token: 'temp_token'
                        };
                        
                        // Store session in localStorage with the key Supabase expects
                        localStorage.setItem('supabase_auth_token', JSON.stringify(tempSession));
                    } else {
                        // No stored email, redirect to auth page
                        console.log('No stored email found, redirecting to auth page');
                        window.location.href = 'auth/auth.html';
                        return;
                    }
                }
                
                // Get user from auth again (might be the temp user we just created)
                const { data: { user: confirmedUser } } = await auth.getUser();
                appState.currentUser = confirmedUser;
                
                console.log('Current user set:', appState.currentUser);
                
                // Setup UI event listeners
                setupEventListeners();
                
                // Load projects
                await loadProjects();
                
                // Load context items
                await loadContextItems();
                
                hideLoading();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                
                // Gracefully handle initialization errors
                // If Supabase auth fails, we can still use local authentication
                if (localStorage.getItem('isAuthenticated') === 'true') {
                    console.log('Falling back to local authentication');
                    setupEventListeners();
                    await loadProjects();
                    await loadContextItems();
                    hideLoading();
                } else {
                    hideLoading();
                    
                    // Show a user-friendly error
                    const errorElement = document.createElement('div');
                    errorElement.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-75 z-50';
                    errorElement.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-md">
                            <div class="text-error text-5xl mb-4"><i class="fas fa-exclamation-circle"></i></div>
                            <h2 class="text-2xl font-bold mb-4">Authentication Error</h2>
                            <p class="mb-6">Unable to verify your authentication. Please log in again.</p>
                            <a href="index.html?from_editor=true" class="btn btn-primary px-6 py-2 rounded-md">Return to Home</a>
                        </div>
                    `;
                    document.body.appendChild(errorElement);
                }
            }
        });
    </script>

    <script type="module">
        import { auth } from './lib/supabase.js';
        
        // Initialize with a default user avatar and handle sign out
        document.addEventListener('DOMContentLoaded', () => {
            const userAvatar = document.querySelector('#userAvatar');
            const userDisplayName = document.querySelector('#userDisplayName');
            const signOutBtn = document.querySelector('#signOutBtn');
            
            // Update user info if authenticated
            auth.getUser().then(({ data: { user } }) => {
                if (user && userAvatar) {
                    // Update avatar with user email or name
                    const nameInitial = user.email ? user.email.charAt(0).toUpperCase() : 'G';
                    userAvatar.src = `https://ui-avatars.com/api/?name=${nameInitial}&background=4B5EAA&color=fff`;
                    
                    // Update user display name
                    if (userDisplayName) {
                        userDisplayName.textContent = user.email || 'Signed In User';
                    }
                }
            }).catch(error => {
                console.error('Auth check error:', error);
            });
            
            // Add sign out handler
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                        window.location.href = '/auth/auth.html';
                    } catch (error) {
                        console.error('Error signing out:', error);
                        alert('Failed to sign out. Please try again.');
                    }
                });
            }
        });
    </script>

    <!-- Top Bar -->
    <header class="h-16 bg-white border-b border-gray-100 flex items-center justify-between px-6 shadow-sm-custom">
        <div class="flex items-center space-x-4">
            <!-- Mobile Menu Button -->
            <button id="mobileMenuBtn" class="lg:hidden text-gray-500 hover:text-primary">
                <i class="fas fa-bars"></i>
            </button>
            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white text-xl">
                <i class="fas fa-feather-alt"></i>
            </div>
            <h1 class="text-xl font-semibold text-primary hidden md:block">AIStoryCraft</h1>
        </div>
        <div class="flex items-center space-x-4">
            <button id="saveBtn" class="btn btn-primary">
                <i class="fas fa-save"></i>
                <span class="ml-1">Save</span>
            </button>
            <button id="loadProjectBtn" class="btn btn-primary">
                <i class="fas fa-folder-open"></i>
                <span class="ml-1">Load Project</span>
            </button>
            <button id="newProjectBtn" class="btn btn-success">
                <i class="fas fa-plus"></i>
                <span class="ml-1">New Project</span>
            </button>
            <div class="relative group">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=Guest&background=4B5EAA&color=fff" 
                     alt="User Avatar" 
                     class="w-9 h-9 rounded-full cursor-pointer border-2 border-white hover:border-primary transition-colors">
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-md-custom p-2 invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all z-10">
                    <div class="p-2 hover:bg-gray-50 rounded cursor-pointer flex items-center">
                        <i class="fas fa-user-circle text-primary mr-2"></i>
                        <span id="userDisplayName">Guest User</span>
                    </div>
                    <div class="p-2 hover:bg-gray-50 rounded cursor-pointer flex items-center">
                        <i class="fas fa-cog text-secondary mr-2"></i>
                        <span>Settings</span>
                    </div>
                    <div id="signOutBtn" class="p-2 hover:bg-gray-50 rounded cursor-pointer flex items-center text-error">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span>Sign Out</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay (for mobile) -->
    <div id="sidebarOverlay" class="lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Load Project Panel -->
    <div id="loadProjectPanel" class="fixed right-0 top-0 h-screen w-96 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="h-full flex flex-col">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-primary">Load Project</h2>
                    <button id="closeLoadProjectPanel" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="relative">
                    <input type="text" id="projectSearch" class="w-full border border-gray-200 rounded-lg pl-10 pr-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Search projects...">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div id="projectsList" class="space-y-3">
                    <!-- Projects will be loaded here -->
                    <div class="text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading projects...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Panel Overlay -->
    <div id="loadProjectOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar h-full overflow-y-auto p-4">
            <!-- Project Info -->
            <div class="mb-6">
                <div class="bg-white rounded-lg p-3 shadow-sm-custom mb-4">
                    <h2 id="projectTitle" class="text-primary font-medium mb-1 cursor-pointer" title="Double-click to rename">Loading project...</h2>
                    <div class="flex items-center text-xs text-textSecondary">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="lastEdited">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Chapters -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-secondary">Chapters</h2>
                    <button class="text-primary hover:text-opacity-80" title="Collapse All">
                        <i class="fas fa-compress-alt"></i>
                    </button>
                </div>
                <div id="chaptersList" class="space-y-1">
                    <!-- Chapters will be loaded here dynamically -->
                    <div class="text-center p-2 text-textSecondary text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading chapters...
                    </div>
                </div>
                <button id="addChapterBtn" class="btn btn-primary w-full mt-3">
                    <i class="fas fa-plus"></i>
                    Add Chapter
                </button>
            </div>

            <!-- Context Manager -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-secondary">Story Context</h2>
                    <span id="contextCount" class="text-xs text-textSecondary">0 items</span>
                </div>
                <div class="bg-white rounded-lg p-2 shadow-sm-custom mb-3">
                    <div id="contextList" class="space-y-1">
                        <!-- Context items will be loaded here -->
                        <div class="text-center p-2 text-textSecondary text-sm">
                            <i class="fas fa-info-circle mr-2"></i>No context items yet
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary w-full" id="manageContextBtn">
                    <i class="fas fa-brain"></i>
                    Manage Context
                </button>
            </div>

            <!-- Export -->
            <div class="mb-6">
                <button class="btn btn-success w-full">
                    <i class="fas fa-file-pdf"></i>
                    Export PDF
                </button>
            </div>

            <!-- Word Count -->
            <div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm-custom text-sm">
                <div>
                    <div class="text-textSecondary">Total Words</div>
                    <div id="wordCount" class="text-xl font-semibold text-primary">0</div>
                </div>
                <div class="h-12 w-12 relative">
                    <svg class="w-full h-full" viewBox="0 0 36 36">
                        <circle cx="18" cy="18" r="16" fill="none" stroke="#E6E9F0" stroke-width="2"></circle>
                        <circle id="wordCountProgress" cx="18" cy="18" r="16" fill="none" stroke="#4B5EAA" stroke-width="2" stroke-dasharray="0 100" stroke-dashoffset="0" transform="rotate(-90 18 18)"></circle>
                    </svg>
                    <div id="wordCountPercent" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-medium text-primary">0%</div>
                </div>
            </div>
        </aside>

        <!-- Editor Area -->
        <main class="flex-1 overflow-hidden flex flex-col bg-white">
            <!-- Editor Toolbar -->
            <div class="bg-white border-b border-gray-100 p-2 flex items-center space-x-2 shadow-sm-custom editor-toolbar">
                <!-- Formatting buttons grouped together -->
                <div class="flex items-center space-x-1">
                    <button class="toolbar-btn" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="toolbar-btn" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="toolbar-btn" title="Heading">
                        <i class="fas fa-heading"></i>
                    </button>
                    <div class="relative">
                        <button class="toolbar-btn" title="Font Size">
                            <i class="fas fa-text-height"></i>
                        </button>
                        <div class="font-size-dropdown hidden absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-10">
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="1">Small</button>
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="3">Normal</button>
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="5">Large</button>
                            <button class="block w-full px-4 py-1 text-left hover:bg-primaryLight" data-size="7">Huge</button>
                        </div>
                    </div>
                </div>
                
                <!-- AI Assistant Button (right-aligned) -->
                <button id="aiAssistBtn" class="btn btn-primary text-sm transform transition-transform hover:scale-105 active:scale-95 ml-auto">
                    <i class="fas fa-robot mr-2"></i>
                    <span>AI Assist</span>
                </button>
                
                <!-- Full Screen button -->
                <button class="toolbar-btn" title="Full Screen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>

            <!-- AI Assistant Panel -->
            <div id="aiAssistPanel" class="fixed right-0 top-0 h-screen w-[400px] bg-white shadow-md-custom transform translate-x-full transition-transform duration-300 z-50 flex flex-col" role="complementary" aria-label="AI Assistant">
                <!-- Panel Header -->
                <div class="flex-shrink-0 p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-primary">AI Assistant</h2>
                        <button id="closeAiPanel" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Mode Toggle -->
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-3">
                        <button class="ai-mode-btn flex-1 py-1 px-2 text-sm font-medium rounded active" data-mode="generate">Generate</button>
                        <button class="ai-mode-btn flex-1 py-1 px-2 text-sm font-medium rounded" data-mode="chat">Chat</button>
                    </div>
                    
                    <!-- Model Selector -->
                    <select id="aiModel" class="w-full bg-primaryLight text-primary rounded-lg p-2 text-sm">
                        <!-- DeepSeek Models (Direct API) -->
                        <option value="deepseek-chat">DeepSeek Chat (V3) - Featured</option>
                        <option value="deepseek-reasoner">DeepSeek Reasoner (R1) - Featured</option>
                        
                        <option disabled> Hugging Face Models </option>
                        <option value="distilgpt2">DistilGPT-2 (Fast)</option>
                        <option value="gpt2-medium">GPT-2 Medium (Balanced)</option>
                        <!-- New models -->
                        <option value="Qwen/Qwen3-0.6B">Qwen3-0.6B (Small but Improved)</option>
                        <option value="google/gemma-2b">Gemma-2B (Google's Lightweight)</option>
                        <option value="meta-llama/Llama-3-8B-Instruct">Llama-3-8B (High Quality)</option>
                        <option value="tiiuae/falcon-7b-instruct">Falcon-7B (Creative)</option>
                        <option value="mistralai/Mixtral-8x7B-Instruct-v0.1">Mixtral-8x7B (Most Powerful)</option>
                        <!-- Temporarily disabled due to timeouts -->
                        <!-- <option value="EleutherAI/gpt-neo-125M">GPT-Neo 125M (Advanced)</option> -->
                        <!-- <option value="facebook/opt-350m">OPT 350M (Creative)</option> -->
                    </select>
                </div>

                <!-- Context Preview -->
                <div class="flex-shrink-0 bg-primaryLight/20 p-3 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-secondary">Using context:</span>
                        <button class="text-xs text-primary hover:text-primary/80">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                    </div>
                    <div class="text-sm text-primary mt-1">Jane, Darkwood Forest</div>
                </div>

                <!-- Chat View -->
                <div id="chatView" class="flex-1 flex flex-col hidden overflow-hidden">
                    <!-- Chat History (now at top) -->
                    <div id="chatHistory" class="flex-1 overflow-y-auto">
                        <!-- Example messages will be added here -->
                    </div>
                    
                    <!-- Chat Input (now at bottom) -->
                    <div class="flex-shrink-0 p-4 border-t border-gray-200">
                        <div class="relative">
                            <textarea id="chatInput" class="w-full min-h-[100px] max-h-[200px] border border-gray-200 rounded-lg p-3 pr-10 focus:border-primary focus:ring-1 focus:ring-primary outline-none resize-none" placeholder="Ask the AI..."></textarea>
                            <button id="chatSubmit" class="absolute right-3 top-3 text-primary hover:text-primary/80 disabled:opacity-50">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <!-- Token usage info for DeepSeek models -->
                        <div id="tokenUsageInfo" class="text-xs text-gray-500 mt-2 hidden">
                            <span>Token usage: <span id="promptTokens">0</span> prompt + <span id="completionTokens">0</span> completion = <span id="totalTokens">0</span> total</span>
                        </div>
                    </div>
                </div>

                <!-- Generate/Edit View -->
                <div id="generateEditView" class="flex-1 flex flex-col overflow-hidden">
                    <!-- Output Area (now at top) -->
                    <div id="aiOutput" class="flex-1 bg-gray-50 rounded-lg m-4 p-6 overflow-y-auto">
                        <p class="text-gray-400 text-sm italic">AI output will appear here...</p>
                    </div>
                    
                    <!-- Controls (in middle) -->
                    <div class="flex-shrink-0 space-y-3 px-4">
                        <div>
                            <label class="text-sm font-medium block mb-2">Tone</label>
                            <select id="aiTone" class="w-full border border-gray-200 rounded-lg p-2 text-sm">
                                <option>Suspenseful</option>
                                <option>Humorous</option>
                                <option>Dramatic</option>
                                <option>Reflective</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium block mb-2">Length</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">Short</span>
                                <input type="range" id="aiLength" min="50" max="500" value="200" class="flex-grow">
                                <span class="text-xs text-gray-500">Long</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Area (now at bottom) -->
                    <div class="flex-shrink-0 p-4 border-t border-gray-200">
                        <div class="relative">
                            <textarea id="aiInput" class="w-full min-h-[100px] max-h-[200px] border border-gray-200 rounded-lg p-3 pr-10 focus:border-primary focus:ring-1 focus:ring-primary outline-none resize-none" placeholder="Write a scene with Jane..."></textarea>
                            <button id="aiSubmit" class="absolute right-3 top-3 text-primary hover:text-primary/80 disabled:opacity-50">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Overlay (shown on small screens) -->
            <div id="aiMobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

            <!-- Toast Notification -->
            <div id="aiToast" class="fixed bottom-4 right-4 bg-success text-white p-3 rounded-lg shadow-md-custom hidden transform transition-transform duration-300">
                <p class="text-sm"></p>
            </div>

            <!-- Editor Content -->
            <div class="flex-1 overflow-y-auto p-8 bg-white">
                <div id="editorContent" class="editor-content max-w-3xl mx-auto" contenteditable="true">
                    <h1 id="chapterTitle" class="text-3xl font-bold mb-6">Loading chapter...</h1>
                    <p class="mb-4 placeholder-text">Select a chapter to start writing, or create a new one.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Preview Modal (Hidden by default) -->
    <div class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center modal" id="aiModal">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 shadow-md-custom fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-primary">AI Suggestion</h2>
                <button class="text-gray-400 hover:text-gray-600" id="closeModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="bg-gray-50 p-5 rounded-lg mb-5 border border-gray-100">
                <p class="text-gray-700 leading-relaxed">The city lights twinkled below as John gazed out from his apartment window. Tomorrow would mark one year since the accident changed everything. He sighed, knowing that returning to New York had been necessary, even if every street corner held a memory he'd rather forget.</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div>
                    <label class="text-sm font-medium block mb-2">Tone</label>
                    <select class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                        <option>Suspenseful</option>
                        <option>Humorous</option>
                        <option>Dramatic</option>
                        <option>Reflective</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium block mb-2">Length</label>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Short</span>
                        <input type="range" min="50" max="500" value="200" class="flex-grow">
                        <span class="text-xs text-gray-500">Long</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i>
                    Regenerate
                </button>
                <button class="btn btn-error">
                    <i class="fas fa-times"></i>
                    Reject
                </button>
                <button class="btn btn-success">
                    <i class="fas fa-check"></i>
                    Accept
                </button>
            </div>
        </div>
    </div>

    <!-- Context Manager Modal (Hidden by default) -->
    <div class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center modal" id="contextModal">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 shadow-md-custom fade-in overflow-y-auto max-h-[90vh]">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-primary">Manage Story Context</h2>
                <button class="text-gray-400 hover:text-gray-600" id="closeContextModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="border-b border-gray-200 mb-4">
                <div class="flex space-x-2">
                    <button class="px-4 py-2 border-b-2 border-primary text-primary font-medium context-tab" data-tab="protagonists">Characters</button>
                    <button class="px-4 py-2 border-b-2 border-transparent hover:text-primary context-tab" data-tab="settings">Settings</button>
                    <button class="px-4 py-2 border-b-2 border-transparent hover:text-primary context-tab" data-tab="timeline">Timeline</button>
                    <button class="px-4 py-2 border-b-2 border-transparent hover:text-primary context-tab" data-tab="other">Other</button>
                </div>
            </div>
            
            <!-- Context Items List -->
            <div class="mb-4">
                <!-- Character Tree View (for Characters tab) -->
                <div id="characterTreeView" class="bg-white rounded-lg p-3 shadow-sm-custom">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-primary">Characters Network</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-textSecondary">3 characters</span>
                            <button class="btn btn-primary text-xs py-1 px-2" id="newCharacterBtn">
                                <i class="fas fa-plus text-xs mr-1"></i>
                                New Character
                            </button>
                        </div>
                    </div>
                    <div class="character-tree relative" id="characterTreeContainer">
                        <!-- Character nodes will be placed here dynamically -->
                        <div class="character-node protagonist" style="top: 50px; left: 50%;" data-name="John Doe" data-role="Protagonist">
                            <div class="font-medium text-center">John</div>
                            <div class="character-tooltip">
                                <div class="font-bold text-primary mb-1">John Doe</div>
                                <div class="text-xs text-textSecondary mb-2">Protagonist</div>
                                <div class="text-sm">Brave, curious explorer who survived an accident in New York.</div>
                            </div>
                        </div>
                        <div class="character-node antagonist" style="top: 150px; left: 30%;" data-name="Mystery Figure" data-role="Antagonist">
                            <div class="font-medium text-center">Mystery</div>
                            <div class="character-tooltip">
                                <div class="font-bold text-primary mb-1">Mystery Figure</div>
                                <div class="text-xs text-textSecondary mb-2">Antagonist</div>
                                <div class="text-sm">Unknown entity connected to the accident, with hidden motives.</div>
                            </div>
                        </div>
                        <div class="character-node supporting" style="top: 150px; left: 70%;" data-name="Sarah" data-role="Supporting">
                            <div class="font-medium text-center">Sarah</div>
                            <div class="character-tooltip">
                                <div class="font-bold text-primary mb-1">Sarah</div>
                                <div class="text-xs text-textSecondary mb-2">Supporting Character</div>
                                <div class="text-sm">John's friend who helps him navigate his return to the city.</div>
                            </div>
                        </div>
                        <!-- Character links -->
                        <div class="character-link" style="width: 150px; top: 80px; left: 50%; transform: rotate(45deg);"></div>
                        <div class="character-link" style="width: 150px; top: 80px; left: 50%; transform: rotate(-45deg);"></div>
                        
                        <!-- Network area interaction overlay -->
                        <div id="networkInteractionOverlay" class="absolute inset-0 cursor-pointer hidden">
                            <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-md-custom p-3 text-center">
                                <button class="btn btn-primary text-sm" id="addCharacterFromNetworkBtn">
                                    <i class="fas fa-plus mr-1"></i>
                                    Add Character Here
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <div class="flex justify-center space-x-4">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-primary mr-1"></div>
                                <span class="text-xs">Protagonist</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-error mr-1"></div>
                                <span class="text-xs">Antagonist</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-accent mr-1"></div>
                                <span class="text-xs">Supporting</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-secondary mr-1"></div>
                                <span class="text-xs">Minor</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Regular List View (for other tabs) -->
                <div id="regularListView" class="bg-primaryLight p-3 rounded-lg hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-primary">Current Items</h3>
                        <span class="text-xs text-textSecondary" id="contextItemCount">3 items</span>
                    </div>
                    <div class="space-y-1 max-h-32 overflow-y-auto" id="contextItemsList">
                        <div class="p-2 text-sm bg-white rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium">John Doe</div>
                                <div class="text-xs text-textSecondary">Protagonist</div>
                            </div>
                            <div>
                                <button class="text-primary hover:text-opacity-80 mr-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-error hover:text-opacity-80" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-2 text-sm bg-white rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium">New York City</div>
                                <div class="text-xs text-textSecondary">Setting</div>
                            </div>
                            <div>
                                <button class="text-primary hover:text-opacity-80 mr-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-error hover:text-opacity-80" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-2 text-sm bg-white rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium">The Accident</div>
                                <div class="text-xs text-textSecondary">Timeline</div>
                            </div>
                            <div>
                                <button class="text-primary hover:text-opacity-80 mr-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-error hover:text-opacity-80" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form containers for each tab -->
            <div id="protagonistsForm" class="context-form-container hidden">
                <div id="characterFormHeader" class="bg-primaryLight p-3 mb-4 rounded-lg">
                    <h3 class="text-primary font-medium" id="characterFormTitle">Add New Character</h3>
                    <p class="text-sm text-secondary">Fill in the details below to add a character to your story.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-medium block mb-2">Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Character name" id="protagonistName">
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Role <span class="text-error">*</span></label>
                        <select class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" id="protagonistRole">
                            <option value="Protagonist">Protagonist</option>
                            <option value="Antagonist">Antagonist</option>
                            <option value="Supporting">Supporting Character</option>
                            <option value="Minor">Minor Character</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Traits</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Character traits (e.g., brave, curious, impulsive)" id="protagonistTraits"></textarea>
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Relationships</label>
                        <div class="bg-gray-50 rounded-lg p-2 h-auto">
                            <div class="text-xs text-textSecondary mb-2">Connected to:</div>
                            <div id="relationshipList" class="space-y-1 mb-3">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-primary mr-2"></div>
                                        <span>John Doe (Protagonist)</span>
                                    </div>
                                    <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-error mr-2"></div>
                                        <span>Mystery Figure (Antagonist)</span>
                                    </div>
                                    <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 pt-2">
                                <div class="text-xs text-textSecondary mb-1">Add Relationship:</div>
                                <div class="flex space-x-2">
                                    <select id="newRelationshipSelect" class="text-sm flex-grow border border-gray-200 rounded-lg p-1 focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                                        <option value="">Select a character...</option>
                                        <option value="John Doe">John Doe (Protagonist)</option>
                                        <option value="Mystery Figure">Mystery Figure (Antagonist)</option>
                                        <option value="Sarah">Sarah (Supporting)</option>
                                    </select>
                                    <button id="addRelationshipBtn" class="btn btn-primary py-1 px-2 text-xs">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Backstory</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Character's history and background" id="protagonistBackstory"></textarea>
                    </div>
                </div>

                <div class="bg-primaryLight p-3 rounded-lg mb-4">
                    <div class="text-sm font-medium mb-2">Character Position in Network</div>
                    <p class="text-xs text-textSecondary mb-3">Characters are automatically positioned in the network based on their relationships. Protagonists are placed in the center, with other characters connected to them.</p>
                    <div class="flex space-x-4">
                        <div class="w-5 h-5 rounded-full bg-primary"></div>
                        <div class="w-5 h-5 rounded-full bg-error"></div>
                        <div class="w-5 h-5 rounded-full bg-accent"></div>
                        <div class="w-5 h-5 rounded-full bg-secondary"></div>
                    </div>
                    <div class="flex space-x-4 text-xs mt-1">
                        <div>Protagonist</div>
                        <div>Antagonist</div>
                        <div>Supporting</div>
                        <div>Minor</div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button class="btn btn-error" id="cancelCharacterBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-success" id="saveCharacterBtn">
                        <i class="fas fa-save"></i>
                        Save Character
                    </button>
                </div>
            </div>

            <div id="settingsForm" class="context-form-container hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-medium block mb-2">Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Setting name (e.g., Darkwood Forest)" id="settingName">
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Type</label>
                        <select class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" id="settingType">
                            <option value="Location">Location</option>
                            <option value="Building">Building</option>
                            <option value="City">City</option>
                            <option value="Country">Country</option>
                            <option value="Planet">Planet</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Description <span class="text-error">*</span></label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Setting description" id="settingDescription"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Key Features</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Notable features (e.g., haunted, foggy, ancient)" id="settingFeatures"></textarea>
                    </div>
                </div>
            </div>

            <div id="timelineForm" class="context-form-container hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-medium block mb-2">Event Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Event name" id="timelineEventName">
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Date/Time</label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="e.g., Full moon, 2025, Day 3" id="timelineDateTime">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Description <span class="text-error">*</span></label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="What happened in this event" id="timelineDescription"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Significance</label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-20" placeholder="Why this event matters to the story (e.g., turning point, revelation)" id="timelineSignificance"></textarea>
                    </div>
                </div>
            </div>

            <div id="otherForm" class="context-form-container hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-medium block mb-2">Name <span class="text-error">*</span></label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Item name" id="otherName">
                    </div>
                    <div>
                        <label class="text-sm font-medium block mb-2">Type</label>
                        <input type="text" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="e.g., Theme, Object, Faction" id="otherType">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium block mb-2">Description <span class="text-error">*</span></label>
                        <textarea class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-24" placeholder="Description" id="otherDescription"></textarea>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button class="btn btn-error" id="deleteContextBtn">
                    <i class="fas fa-trash"></i>
                    Delete
                </button>
                <button class="btn btn-secondary" id="cancelContextBtn">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn btn-success" id="saveContextBtn">
                    <i class="fas fa-save"></i>
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Simple JS for Modal Toggle (Demo Only) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Select elements
            const contextModal = document.getElementById('contextModal');
            const manageContextBtn = document.getElementById('manageContextBtn');
            const closeContextModalBtn = document.getElementById('closeContextModal');
            const cancelContextBtn = document.getElementById('cancelContextBtn');
            const saveContextBtn = document.getElementById('saveContextBtn');
            const deleteContextBtn = document.getElementById('deleteContextBtn');
            const contextTabs = document.querySelectorAll('.context-tab');
            const contextForms = document.querySelectorAll('.context-form-container');
            const characterTreeView = document.getElementById('characterTreeView');
            const regularListView = document.getElementById('regularListView');
            const characterFormContainer = document.getElementById('protagonistsForm');
            const newCharacterBtn = document.getElementById('newCharacterBtn');
            const cancelCharacterBtn = document.getElementById('cancelCharacterBtn');
            const saveCharacterBtn = document.getElementById('saveCharacterBtn');
            const networkInteractionOverlay = document.getElementById('networkInteractionOverlay');
            const addCharacterFromNetworkBtn = document.getElementById('addCharacterFromNetworkBtn');
            const characterFormTitle = document.getElementById('characterFormTitle');
            const newRelationshipSelect = document.getElementById('newRelationshipSelect');
            const addRelationshipBtn = document.getElementById('addRelationshipBtn');
            const relationshipList = document.getElementById('relationshipList');
            
            // Current editing state
            let currentlyEditing = null;
            let networkClickPosition = { x: 0, y: 0 };
            
            // Show context modal when manage context button is clicked
            manageContextBtn.addEventListener('click', function() {
                window.location.href = 'context.html';
            });
            
            // Close context modal
            function closeContextModal() {
                contextModal.style.display = 'none';
                currentlyEditing = null;
                resetForms();
                // Hide character form
                characterFormContainer.classList.add('hidden');
            }
            
            closeContextModalBtn.addEventListener('click', closeContextModal);
            cancelContextBtn.addEventListener('click', closeContextModal);
            
            // Toggle between character tree and regular views based on tab
            function toggleContextView(tabName) {
                if (tabName === 'protagonists') {
                    // Show character tree view for 'Characters' tab
                    characterTreeView.classList.remove('hidden');
                    regularListView.classList.add('hidden');
                    
                    // Hide character form by default
                    characterFormContainer.classList.add('hidden');
                    
                    // Refresh character tree (if needed)
                    refreshCharacterTree();
                } else {
                    // Show regular list view for other tabs
                    characterTreeView.classList.add('hidden');
                    regularListView.classList.remove('hidden');
                }
            }
            
            // Show the character form for new character
            function showNewCharacterForm() {
                // Reset any previous values
                resetCharacterForm();
                
                // Set the form title for new character
                characterFormTitle.textContent = 'Add New Character';
                
                // Show the character form
                characterFormContainer.classList.remove('hidden');
                
                // Not currently editing an existing character
                currentlyEditing = null;
                
                // Update delete button state
                updateDeleteButtonState();
                
                // Update relationship select
                updateRelationshipSelect();
            }
            
            // Show the character form for editing an existing character
            function showEditCharacterForm(character) {
                // Fill the form with character data
                document.getElementById('protagonistName').value = character.name;
                document.getElementById('protagonistRole').value = character.role;
                document.getElementById('protagonistTraits').value = character.traits || '';
                document.getElementById('protagonistBackstory').value = character.backstory || '';
                
                // Clear existing relationships
                relationshipList.innerHTML = '';
                
                // Add existing relationships to the form
                const relationships = character.relationships || [];
                if (relationships.length > 0) {
                    // Get all character nodes to get their roles and colors
                    const characterNodes = document.querySelectorAll('.character-node');
                    
                    relationships.forEach(relatedName => {
                        // Find the related character node to get its role
                        const relatedNode = Array.from(characterNodes).find(node => 
                            node.getAttribute('data-name') === relatedName);
                        
                        if (relatedNode) {
                            const relatedRole = relatedNode.getAttribute('data-role');
                            
                            // Determine color based on character role
                            let colorClass = 'bg-primary'; // default
                            if (relatedRole === 'Antagonist') {
                                colorClass = 'bg-error';
                            } else if (relatedRole === 'Supporting') {
                                colorClass = 'bg-accent';
                            } else if (relatedRole === 'Minor') {
                                colorClass = 'bg-secondary';
                            }
                            
                            // Create relationship element
                            const relationshipEl = document.createElement('div');
                            relationshipEl.className = 'flex items-center justify-between text-sm';
                            relationshipEl.innerHTML = `
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full ${colorClass} mr-2"></div>
                                    <span>${relatedName} (${relatedRole})</span>
                                </div>
                                <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            
                            // Add to list
                            relationshipList.appendChild(relationshipEl);
                        }
                    });
                    
                    // Add delete handlers
                    initRelationshipDeleteButtons();
                }
                
                // Set the form title for editing
                characterFormTitle.textContent = 'Edit Character: ' + character.name;
                
                // Show the character form
                characterFormContainer.classList.remove('hidden');
                
                // Set currently editing
                currentlyEditing = character;
                
                // Update delete button state
                updateDeleteButtonState();
                
                // Update relationship select
                updateRelationshipSelect();
            }
            
            // Reset the character form
            function resetCharacterForm() {
                document.getElementById('protagonistName').value = '';
                document.getElementById('protagonistRole').value = 'Protagonist';
                document.getElementById('protagonistTraits').value = '';
                document.getElementById('protagonistBackstory').value = '';
                
                // Clear existing relationships
                relationshipList.innerHTML = '';
            }
            
            // New Character button click handler
            newCharacterBtn.addEventListener('click', function() {
                showNewCharacterForm();
            });
            
            // Cancel Character button click handler
            cancelCharacterBtn.addEventListener('click', function() {
                characterFormContainer.classList.add('hidden');
                currentlyEditing = null;
            });
            
            // Character network background click handler
            document.getElementById('characterTreeContainer').addEventListener('click', function(e) {
                // Only register clicks directly on the container (not on nodes)
                if (e.target === this || e.target === networkInteractionOverlay) {
                    // Store the click position for potential character placement
                    const rect = this.getBoundingClientRect();
                    networkClickPosition = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                    
                    // Show the interaction overlay
                    networkInteractionOverlay.style.display = 'block';
                    
                    // Position the overlay interaction button near the click
                    const overlayBtn = networkInteractionOverlay.querySelector('div');
                    overlayBtn.style.left = networkClickPosition.x + 'px';
                    overlayBtn.style.top = networkClickPosition.y + 'px';
                }
            });
            
            // Add Character from Network button click handler
            addCharacterFromNetworkBtn.addEventListener('click', function() {
                // Hide the overlay
                networkInteractionOverlay.style.display = 'none';
                
                // Show the new character form
                showNewCharacterForm();
            });
            
            // Hide network overlay when clicking anywhere else
            document.addEventListener('click', function(e) {
                // If click is outside the network container, hide the overlay
                if (!e.target.closest('#characterTreeContainer')) {
                    networkInteractionOverlay.style.display = 'none';
                }
            });
            
            // Handle tab switching
            contextTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    contextTabs.forEach(t => {
                        t.classList.remove('border-primary', 'text-primary', 'font-medium');
                        t.classList.add('border-transparent');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('border-primary', 'text-primary', 'font-medium');
                    this.classList.remove('border-transparent');
                    
                    // Get the tab name
                    const tabName = this.getAttribute('data-tab');
                    
                    // Show the corresponding form and hide others
                    contextForms.forEach(form => {
                        if (form.id === tabName + 'Form') {
                            // Only show the form if we're not on protagonists tab
                            // For protagonists, we only show the form when a character is clicked
                            if (tabName !== 'protagonists') {
                                form.classList.remove('hidden');
                            } else {
                                form.classList.add('hidden');
                            }
                        } else {
                            form.classList.add('hidden');
                        }
                    });
                    
                    // Toggle between character tree and regular views
                    toggleContextView(tabName);
                });
            });
            
            // Character Tree Management
            const characterTreeContainer = document.getElementById('characterTreeContainer');
            
            // Update relationship lines in the network
            function updateRelationshipLines() {
                // Clear all existing relationship lines
                document.querySelectorAll('.character-link').forEach(link => {
                    link.remove();
                });
                
                // Get all character nodes
                const characterNodes = document.querySelectorAll('.character-node');
                
                // Create an adjacency list of relationships
                const relationships = {};
                
                // Initialize relationships for all characters
                characterNodes.forEach(node => {
                    const name = node.getAttribute('data-name');
                    relationships[name] = [];
                });
                
                // Populate relationships
                characterNodes.forEach(node => {
                    const name = node.getAttribute('data-name');
                    const nodeRelationships = JSON.parse(node.getAttribute('data-relationships') || '[]');
                    
                    // Add bidirectional relationships
                    nodeRelationships.forEach(relatedName => {
                        if (relationships[name] && !relationships[name].includes(relatedName)) {
                            relationships[name].push(relatedName);
                        }
                        if (relationships[relatedName] && !relationships[relatedName].includes(name)) {
                            relationships[relatedName].push(name);
                        }
                    });
                });
                
                // Create lines for each relationship (avoiding duplicates)
                const processedPairs = new Set();
                
                Object.keys(relationships).forEach(name => {
                    const node = Array.from(characterNodes).find(n => n.getAttribute('data-name') === name);
                    
                    relationships[name].forEach(relatedName => {
                        const relatedNode = Array.from(characterNodes).find(n => n.getAttribute('data-name') === relatedName);
                        
                        // Create a unique key for this pair
                        const pairKey = [name, relatedName].sort().join('_');
                        
                        // Only process each pair once
                        if (!processedPairs.has(pairKey) && node && relatedNode) {
                            createLink(node, relatedNode);
                            processedPairs.add(pairKey);
                        }
                    });
                });
            }
            
            // Create link between two character nodes
            function createLink(nodeA, nodeB) {
                // Get positions
                const rectA = nodeA.getBoundingClientRect();
                const rectB = nodeB.getBoundingClientRect();
                const containerRect = characterTreeContainer.getBoundingClientRect();
                
                // Calculate center points relative to container
                const aX = rectA.left + rectA.width / 2 - containerRect.left;
                const aY = rectA.top + rectA.height / 2 - containerRect.top;
                const bX = rectB.left + rectB.width / 2 - containerRect.left;
                const bY = rectB.top + rectB.height / 2 - containerRect.top;
                
                // Calculate distance and angle
                const distance = Math.sqrt(Math.pow(bX - aX, 2) + Math.pow(bY - aY, 2));
                const angle = Math.atan2(bY - aY, bX - aX) * 180 / Math.PI;
                
                // Create link element
                const link = document.createElement('div');
                link.className = 'character-link';
                link.style.width = `${distance}px`;
                link.style.top = `${aY}px`;
                link.style.left = `${aX}px`;
                link.style.transform = `rotate(${angle}deg)`;
                
                // Add to tree
                characterTreeContainer.appendChild(link);
                
                return link;
            }
            
            // Refresh character tree visualization
            function refreshCharacterTree() {
                // This function would update the tree based on actual data
                // For the demo, we'll just make sure the nodes are positioned properly
                
                // Add click handlers to character nodes for editing
                document.querySelectorAll('.character-node').forEach(node => {
                    node.onclick = function(e) {
                        // Stop propagation to prevent the network overlay from showing
                        e.stopPropagation();
                        
                        const name = this.getAttribute('data-name');
                        const role = this.getAttribute('data-role');
                        const relationships = JSON.parse(this.getAttribute('data-relationships') || '[]');
                        
                        // Set current editing item and show form
                        const character = { 
                            id: 'mock-id', 
                            name: name, 
                            role: role,
                            traits: "Sample traits for " + name,
                            backstory: "Sample backstory for " + name,
                            type: 'Protagonist',
                            relationships: relationships
                        };
                        
                        // Show the edit form
                        showEditCharacterForm(character);
                    };
                });
                
                // Update relationship lines
                updateRelationshipLines();
            }
            
            // Add character to tree visualization
            function addCharacterToTree(character) {
                // If we have a position from network click, use that
                // Otherwise, position based on relationships
                let posX, posY;
                
                if (networkClickPosition.x && networkClickPosition.y) {
                    posX = networkClickPosition.x;
                    posY = networkClickPosition.y;
                    
                    // Reset the network click position
                    networkClickPosition = { x: 0, y: 0 };
                } else {
                    // Calculate position based on existing nodes
                    const nodeCount = characterTreeContainer.querySelectorAll('.character-node').length;
                    const angle = nodeCount * (Math.PI / 4);
                    const centerX = characterTreeContainer.offsetWidth / 2;
                    const centerY = 120;
                    const radius = 100;
                    
                    // Calculate position
                    posX = centerX + radius * Math.cos(angle);
                    posY = centerY + radius * Math.sin(angle);
                }
                
                // Create node
                const node = document.createElement('div');
                node.className = `character-node ${character.role.toLowerCase()}`;
                node.style.top = `${posY}px`;
                node.style.left = `${posX}px`;
                node.setAttribute('data-name', character.name);
                node.setAttribute('data-role', character.role);
                
                // Create node content
                const nameDisplay = character.name.split(' ')[0]; // Just first name for display
                node.innerHTML = `
                    <div class="font-medium text-center">${nameDisplay}</div>
                    <div class="character-tooltip">
                        <div class="font-bold text-primary mb-1">${character.name}</div>
                        <div class="text-xs text-textSecondary mb-2">${character.role}</div>
                        <div class="text-sm">${character.traits || 'No traits specified.'}</div>
                    </div>
                `;
                
                // Add to tree
                characterTreeContainer.appendChild(node);
                
                // Note: We no longer automatically create links here
                // Links will be created based on the relationships in updateRelationshipLines()
                
                // Attach click handler
                node.onclick = function(e) {
                    // Stop propagation to prevent the network overlay from showing
                    e.stopPropagation();
                    
                    const name = this.getAttribute('data-name');
                    const role = this.getAttribute('data-role');
                    const relationships = JSON.parse(this.getAttribute('data-relationships') || '[]');
                    
                    // Set current editing item
                    const character = { 
                        id: 'mock-id', 
                        name: name, 
                        role: role,
                        traits: character.traits || '',
                        backstory: character.backstory || '',
                        type: 'Protagonist',
                        relationships: relationships
                    };
                    
                    // Show the edit form
                    showEditCharacterForm(character);
                };
                
                return node;
            }
            
            // Handle delete button state
            function updateDeleteButtonState() {
                if (currentlyEditing) {
                    deleteContextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    deleteContextBtn.disabled = false;
                } else {
                    deleteContextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    deleteContextBtn.disabled = true;
                }
            }
            
            // Reset all forms
            function resetForms() {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    input.value = '';
                });
                updateDeleteButtonState();
            }
            
            // Initialize delete button state
            updateDeleteButtonState();
            
            // Initialize view based on current tab
            toggleContextView('protagonists');
            
            // Save Character button handler
            saveCharacterBtn.addEventListener('click', function() {
                // Basic validation
                let isValid = true;
                let formData = {};
                
                const name = document.getElementById('protagonistName').value;
                const role = document.getElementById('protagonistRole').value;
                
                if (!name) {
                    document.getElementById('protagonistName').classList.add('border-error');
                    isValid = false;
                } else {
                    document.getElementById('protagonistName').classList.remove('border-error');
                }
                
                if (isValid) {
                    // Get relationships from the relationship list
                    const relationships = [];
                    relationshipList.querySelectorAll('span').forEach(span => {
                        const relationshipText = span.textContent;
                        // Extract name from text like "John Doe (Protagonist)"
                        const relationshipName = relationshipText.split(' (')[0];
                        relationships.push(relationshipName);
                    });
                    
                    formData = {
                        name: name,
                        role: role,
                        traits: document.getElementById('protagonistTraits').value,
                        backstory: document.getElementById('protagonistBackstory').value,
                        type: 'Protagonist',
                        relationships: relationships
                    };
                    
                    if (currentlyEditing) {
                        // Update existing character
                        console.log('Updated character:', formData);
                        
                        // Find and update node
                        const node = Array.from(document.querySelectorAll('.character-node')).find(
                            node => node.getAttribute('data-name') === currentlyEditing.name
                        );
                        
                        if (node) {
                            // Store old name to update relationships
                            const oldName = node.getAttribute('data-name');
                            
                            // Update node data
                            node.setAttribute('data-name', formData.name);
                            node.setAttribute('data-role', formData.role);
                            node.setAttribute('data-relationships', JSON.stringify(relationships));
                            
                            // Update class for role
                            node.className = node.className.replace(/protagonist|antagonist|supporting|minor/g, '');
                            node.classList.add(formData.role.toLowerCase());
                            node.classList.add('character-node');
                            
                            // Update content
                            const nameDisplay = formData.name.split(' ')[0]; // Just first name for display
                            node.querySelector('.font-medium').textContent = nameDisplay;
                            
                            const tooltip = node.querySelector('.character-tooltip');
                            tooltip.querySelector('.font-bold').textContent = formData.name;
                            tooltip.querySelector('.text-xs').textContent = formData.role;
                            tooltip.querySelector('.text-sm').textContent = formData.traits || 'No traits specified.';
                            
                            // If name changed, update relationships in other characters that reference this character
                            if (oldName !== formData.name) {
                                document.querySelectorAll('.character-node').forEach(otherNode => {
                                    if (otherNode !== node) {
                                        const otherRelationships = JSON.parse(otherNode.getAttribute('data-relationships') || '[]');
                                        const index = otherRelationships.indexOf(oldName);
                                        if (index !== -1) {
                                            otherRelationships[index] = formData.name;
                                            otherNode.setAttribute('data-relationships', JSON.stringify(otherRelationships));
                                        }
                                    }
                                });
                            }
                        }
                    } else {
                        // Add new character
                        console.log('Added new character:', formData);
                        const newNode = addCharacterToTree(formData);
                        newNode.setAttribute('data-relationships', JSON.stringify(relationships));
                        
                        // Update character count
                        const characterCount = characterTreeContainer.querySelectorAll('.character-node').length;
                        characterTreeView.querySelector('span.text-xs').textContent = `${characterCount} characters`;
                    }
                    
                    // Update relationship lines in the network
                    updateRelationshipLines();
                    
                    // Hide the form
                    characterFormContainer.classList.add('hidden');
                    
                    // Reset editing state
                    currentlyEditing = null;
                    
                    // Reset form
                    resetCharacterForm();
                }
            });
            
            // Add relationship
            addRelationshipBtn.addEventListener('click', function() {
                addRelationship();
            });
            
            // Add relationship function
            function addRelationship() {
                const selectedCharacter = newRelationshipSelect.value;
                const selectedOption = newRelationshipSelect.options[newRelationshipSelect.selectedIndex];
                
                if (!selectedCharacter) {
                    return; // Nothing selected
                }
                
                // Check if relationship already exists
                const existingRelationships = relationshipList.querySelectorAll('span');
                for (let i = 0; i < existingRelationships.length; i++) {
                    if (existingRelationships[i].textContent.includes(selectedCharacter)) {
                        return; // Relationship already exists
                    }
                }
                
                // Create relationship element
                const relationshipEl = document.createElement('div');
                relationshipEl.className = 'flex items-center justify-between text-sm';
                
                // Determine color based on character role
                let colorClass = 'bg-primary'; // default
                if (selectedOption.textContent.includes('Antagonist')) {
                    colorClass = 'bg-error';
                } else if (selectedOption.textContent.includes('Supporting')) {
                    colorClass = 'bg-accent';
                } else if (selectedOption.textContent.includes('Minor')) {
                    colorClass = 'bg-secondary';
                }
                
                relationshipEl.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full ${colorClass} mr-2"></div>
                        <span>${selectedOption.textContent}</span>
                    </div>
                    <button class="text-error hover:text-opacity-80 relationship-delete-btn">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add to list
                relationshipList.appendChild(relationshipEl);
                
                // Add delete handler
                const deleteBtn = relationshipEl.querySelector('.relationship-delete-btn');
                deleteBtn.addEventListener('click', function() {
                    relationshipEl.remove();
                });
                
                // Reset select
                newRelationshipSelect.value = '';
            }
            
            // Add delete handlers to existing relationship delete buttons
            function initRelationshipDeleteButtons() {
                const deleteButtons = relationshipList.querySelectorAll('.relationship-delete-btn');
                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.closest('div.flex.items-center.justify-between').remove();
                    });
                });
            }
            
            // Add keypress handler for relationship select (enter to add)
            newRelationshipSelect.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addRelationship();
                }
            });
            
            // Initialize relationship delete buttons
            initRelationshipDeleteButtons();
            
            // Populate relationship select from character nodes
            function updateRelationshipSelect() {
                // Clear existing options except first "Select a character..." option
                while (newRelationshipSelect.options.length > 1) {
                    newRelationshipSelect.remove(1);
                }
                
                // Add all characters from nodes
                document.querySelectorAll('.character-node').forEach(node => {
                    const name = node.getAttribute('data-name');
                    const role = node.getAttribute('data-role');
                    
                    // Skip if this is the currently editing character
                    if (currentlyEditing && currentlyEditing.name === name) {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${role})`;
                    newRelationshipSelect.appendChild(option);
                });
            }

            // AI Assistant Panel Functionality
            const aiAssistBtn = document.getElementById('aiAssistBtn');
            const aiAssistPanel = document.getElementById('aiAssistPanel');
            const closeAiPanel = document.getElementById('closeAiPanel');
            const aiMobileOverlay = document.getElementById('aiMobileOverlay');
            const modeButtons = document.querySelectorAll('.ai-mode-btn');
            const generateEditView = document.getElementById('generateEditView');
            const chatView = document.getElementById('chatView');
            const aiInput = document.getElementById('aiInput');
            const aiSubmit = document.getElementById('aiSubmit');
            const chatInput = document.getElementById('chatInput');
            const chatSubmit = document.getElementById('chatSubmit');
            const chatHistory = document.getElementById('chatHistory');
            const aiToast = document.getElementById('aiToast');
            const aiModel = document.getElementById('aiModel');
            
            let currentMode = 'generate';
            
            // Toggle AI Panel
            function toggleAiPanel() {
                const isOpen = aiAssistPanel.classList.contains('translate-x-0');
                aiAssistPanel.classList.toggle('translate-x-0');
                aiAssistPanel.classList.toggle('translate-x-full');
                aiMobileOverlay.classList.toggle('hidden');
                
                // Remove the auto-focus
                /* if (!isOpen) {
                    if (currentMode === 'generate') {
                        aiInput.focus();
                    } else if (currentMode === 'chat') {
                        chatInput.focus();
                    }
                } */
            }
            
            aiAssistBtn.addEventListener('click', toggleAiPanel);
            closeAiPanel.addEventListener('click', toggleAiPanel);
            aiMobileOverlay.addEventListener('click', toggleAiPanel);
            
            // Mode Switching
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    currentMode = mode;
                    
                    // Update active state
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show/hide views
                    if (mode === 'chat') {
                        generateEditView.classList.add('hidden');
                        chatView.classList.remove('hidden');
                        // Remove auto-focus
                        // chatInput.focus();
                    } else {
                        generateEditView.classList.remove('hidden');
                        chatView.classList.add('hidden');
                        // Remove auto-focus
                        // aiInput.focus();
                    }
                    
                    // Update placeholder
                    updatePlaceholder();
                });
            });
            
            // Update input placeholder based on mode
            function updatePlaceholder() {
                const placeholders = {
                    generate: 'Write a scene with Jane...',
                    chat: 'Ask the AI...'
                };
                
                if (currentMode === 'chat') {
                    chatInput.placeholder = placeholders.chat;
                } else {
                    aiInput.placeholder = placeholders.generate;
                }
            }
            
            // Get the active context items
            function getActiveContext() {
                // In a real implementation, this would get the actual context from the sidebar
                // For now, we'll return a mock context
                return ['Jane', 'Darkwood Forest'];
            }
            
            // Handle input validation and submit button state
            function validateInput(input) {
                const isValid = input.value.trim().length > 0;
                const submitBtn = input.id === 'chatInput' ? chatSubmit : aiSubmit;
                
                submitBtn.disabled = !isValid;
                submitBtn.classList.toggle('pulse', isValid);
            }
            
            // Auto-expand textarea
            function autoExpandTextarea(textarea) {
                // Reset height to allow shrinking
                textarea.style.height = 'auto';
                
                // Calculate new height (min 100px, max 300px)
                const newHeight = Math.max(100, Math.min(textarea.scrollHeight, 300));
                textarea.style.height = newHeight + 'px';
            }
            
            // Handle AI input
            aiInput.addEventListener('input', function() {
                validateInput(this);
                autoExpandTextarea(this);
            });

            // Initialize textarea height
            window.addEventListener('load', function() {
                autoExpandTextarea(aiInput);
                autoExpandTextarea(chatInput);
            });
            
            // Handle chat input
            chatInput.addEventListener('input', function() {
                validateInput(this);
                autoExpandTextarea(this);
            });
            
            // Add a delay function to rate limit requests
            function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // Handle chat submit with Hugging Face API call
            chatSubmit.addEventListener('click', async () => {
                const message = chatInput.value.trim();
                if (!message) return;
                
                addChatMessage(message, true);
                
                // Reset input and height
                chatInput.value = '';
                chatInput.style.height = 'auto';
                validateInput(chatInput);
                
                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'chat-message ai';
                typingIndicator.innerHTML = `
                    <p class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i>
                        AI is typing...
                    </p>
                `;
                chatHistory.appendChild(typingIndicator);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                try {
                    // Add a small delay to avoid hitting rate limits
                    await delay(500);
                    
                    const model = aiModel.value;
                    
                    // Get current project and user IDs from app state
                    const user_id = window.appState?.currentUser?.id || '';
                    const project_id = window.appState?.currentProject?.id || '';
                    
                    const response = await fetch(`/.netlify/functions/generate-text?model=${model}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: message,
                            context: getActiveContext(),
                            mode: 'chat',
                            tone: 'neutral',
                            length: 200,
                            user_id: user_id,
                            project_id: project_id
                        }),
                    });

                    const data = await response.json();
                    
                    // Remove typing indicator
                    typingIndicator.remove();
                    
                    if (data.error && !data.text) {
                        throw new Error(data.error);
                    }
                    
                    // Format the response text to remove the input prompt if it's repeated
                    let responseText = data.text || '';
                    if (responseText.includes(message)) {
                        responseText = responseText.replace(message, '');
                    }
                    
                    // Add model information to the response
                    let formattedResponse = responseText || 'I apologize, but I couldn\'t generate a proper response.';
                    
                    // Add model info for non-fallback responses
                    if (data.model && !data.isFallback) {
                        formattedResponse = `<div class="text-xs text-gray-500 mb-2">Using model: ${data.model}</div>${formattedResponse}`;
                    }
                    
                    // Add warning for fallback responses
                    if (data.isFallback) {
                        formattedResponse = `<div class="text-xs text-orange-500 mb-2">Note: Using offline response due to API limits.</div>${formattedResponse}`;
                    }
                    
                    // Add AI response
                    addChatMessage(formattedResponse, false, true);
                } catch (error) {
                    console.error('Error:', error);
                    typingIndicator.remove();
                    addChatMessage(`Error: ${error.message || 'Could not connect to AI. Please try again later.'}`, false);
                    showToast('Error connecting to AI', 'error');
                }
            });
            
            // Handle AI submit with Hugging Face API call for Generate/Edit modes
            aiSubmit.addEventListener('click', async () => {
                const prompt = aiInput.value.trim();
                if (!prompt) return;
                
                // Show loading state
                aiOutput.innerHTML = '<p class="text-gray-400 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Generating...</p>';
                aiInput.value = '';
                validateInput(aiInput);
                
                try {
                    // Add a small delay to avoid hitting rate limits
                    await delay(500);
                    
                    const model = aiModel.value;
                    const tone = document.getElementById('aiTone').value;
                    const length = document.getElementById('aiLength').value;
                    
                    // Get current project and user IDs from app state
                    const user_id = window.appState?.currentUser?.id || '';
                    const project_id = window.appState?.currentProject?.id || '';
                    
                    const response = await fetch(`/.netlify/functions/generate-text?model=${model}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt,
                            context: getActiveContext(),
                            mode: currentMode,
                            tone: tone,
                            length: length,
                            user_id: user_id,
                            project_id: project_id
                        }),
                    });
                    
                    const data = await response.json();
                    
                    if (data.error && !data.text) {
                        throw new Error(data.error);
                    }
                    
                    // Format the response text
                    let responseText = data.text || '';
                    // Remove the input prompt if it's repeated in the output
                    if (responseText.includes(prompt)) {
                        responseText = responseText.replace(prompt, '');
                    }
                    
                    // Format the response with proper line breaks and paragraphs
                    const formattedResponse = responseText.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
                    
                    // Update the response text with model information
                    const modelInfo = data.model ? `<div class="text-xs text-gray-500 mb-2">Generated with: ${data.model}</div>` : '';
                    
                    // Add a warning if this is a fallback response
                    const fallbackWarning = data.isFallback ? 
                        `<div class="text-xs text-orange-500 mb-2">Note: This is an offline fallback response. ${data.error || ''}</div>` : '';
                    
                    aiOutput.innerHTML = `${modelInfo}${fallbackWarning}<p class="text-gray-700">${formattedResponse}</p>`;
                    
                    // Scroll to see the new content
                    aiOutput.scrollTop = aiOutput.scrollHeight;
                    
                    showToast(data.isFallback ? 'Fallback response provided' : 'Text generated successfully!');
                } catch (error) {
                    console.error('Error:', error);
                    aiOutput.innerHTML = `<p class="text-error">Error: ${error.message || 'Could not connect to AI. Please try again later.'}</p>`;
                    showToast('Error connecting to AI', 'error');
                }
            });
            
            // Handle Enter key in chat input (Shift+Enter for new line)
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!chatSubmit.disabled) {
                        chatSubmit.click();
                    }
                }
            });
            
            // Handle keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Shift + A to toggle AI panel
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'a') {
                    e.preventDefault();
                    toggleAiPanel();
                }
                
                // Enter to submit in chat or generate/edit
                if (e.key === 'Enter' && !e.shiftKey) {
                    if (document.activeElement === chatInput) {
                        e.preventDefault();
                        chatSubmit.click();
                    } else if (document.activeElement === aiInput) {
                        e.preventDefault();
                        aiSubmit.click();
                    }
                }
            });
            
            // Initialize
            updatePlaceholder();
            validateInput(aiInput);
            validateInput(chatInput);
            
            // Show toast message
            function showToast(message, type = 'success') {
                const toast = document.getElementById('aiToast');
                toast.querySelector('p').textContent = message;
                toast.classList.remove('hidden');
                toast.classList.add('transform', 'translate-y-0');
                
                if (type === 'success') {
                    toast.classList.add('bg-success');
                    toast.classList.remove('bg-error');
                } else {
                    toast.classList.add('bg-error');
                    toast.classList.remove('bg-success');
                }
                
                setTimeout(() => {
                    toast.classList.add('translate-y-full');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                        toast.classList.remove('translate-y-full', 'bg-success', 'bg-error');
                    }, 300);
                }, 3000);
            }
            
            // Add chat message
            function addChatMessage(message, isUser = false, allowHtml = false) {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${isUser ? 'user' : 'ai'}`;
                
                // Format message text (handle newlines and lists)
                const formattedMessage = message
                    .replace(/\n/g, '<br>')
                    .replace(/(\d+\.\s.*?)(?=(?:\d+\.|$))/g, '<div class="mb-1">$1</div>')
                    .replace(/\s(.*?)(?=(?:|$))/g, '<div class="mb-1"> $1</div>');
                
                // If allowHtml is true, use innerHTML directly
                if (allowHtml) {
                    messageEl.innerHTML = `<div>${formattedMessage}</div>`;
                } else {
                    messageEl.innerHTML = `<p>${formattedMessage}</p>`;
                }
                
                chatHistory.appendChild(messageEl);
                
                // Ensure we scroll to see the new message
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });
    </script>

    <!-- New Project Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center modal" id="newProjectModal">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-md-custom fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-primary">Create New Project</h2>
                <button class="text-gray-400 hover:text-gray-600" id="closeNewProjectModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Project Title <span class="text-error">*</span></label>
                    <input type="text" id="newProjectTitle" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none" placeholder="Enter project title">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="newProjectDescription" class="w-full border border-gray-200 rounded-lg p-2 focus:border-primary focus:ring-1 focus:ring-primary outline-none h-24" placeholder="Enter project description (optional)"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelNewProject" class="btn btn-secondary">Cancel</button>
                    <button id="createNewProject" class="btn btn-primary">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-5 rounded-lg shadow-lg text-center">
            <div class="animate-spin mb-3 mx-auto w-8 h-8 border-4 border-primary border-t-transparent rounded-full"></div>
            <p id="loadingMessage">Loading...</p>
        </div>
    </div>

    <!-- Add this script at the end of the body -->
    <script>
        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // Add click handler to mobile menu button
        document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);
        
        // Ensure AI output containers can scroll properly when content changes
        document.addEventListener('DOMContentLoaded', function() {
            const aiOutput = document.getElementById('aiOutput');
            const chatHistory = document.getElementById('chatHistory');
            
            // Setup resize observer for AI output and chat history
            if (window.ResizeObserver) {
                // For aiOutput
                const outputObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        if (entry.target.scrollHeight > entry.target.clientHeight) {
                            // Content exceeds container height, ensure scrollable
                            entry.target.style.overflowY = 'auto';
                        }
                    }
                });
                
                if (aiOutput) outputObserver.observe(aiOutput);
                
                // For chatHistory
                const chatObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        if (entry.target.scrollHeight > entry.target.clientHeight) {
                            // Scroll to the bottom when content changes
                            entry.target.scrollTop = entry.target.scrollHeight;
                        }
                    }
                });
                
                if (chatHistory) chatObserver.observe(chatHistory);
            }
            
            // Mobile keyboard handling for AI chat inputs
            const chatInput = document.getElementById('chatInput');
            const aiInput = document.getElementById('aiInput');
            const aiAssistPanel = document.getElementById('aiAssistPanel');
            
            // Function to adjust input position when keyboard appears
            function handleMobileKeyboard(input) {
                if (!input || window.innerWidth > 768) return; // Only apply on mobile devices
                
                // When input is focused (keyboard appears)
                input.addEventListener('focus', () => {
                    // Small delay to ensure keyboard is fully shown
                    setTimeout(() => {
                        // Get the input container (the parent div of the textarea)
                        const inputContainer = input.closest('.flex-shrink-0');
                        if (!inputContainer) return;
                        
                        // Add class to position the input above keyboard
                        inputContainer.classList.add('keyboard-visible');
                        
                        // Scroll the panel to ensure input is visible
                        aiAssistPanel.scrollTop = aiAssistPanel.scrollHeight;
                        
                        // Scroll the input into view
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
                
                // When input loses focus (keyboard disappears)
                input.addEventListener('blur', () => {
                    // Get the input container
                    const inputContainer = input.closest('.flex-shrink-0');
                    if (!inputContainer) return;
                    
                    // Remove the positioning class
                    inputContainer.classList.remove('keyboard-visible');
                });
            }
            
            // Apply keyboard handling to both chat inputs
            handleMobileKeyboard(chatInput);
            handleMobileKeyboard(aiInput);
            
            // Handle visual viewport changes (for iOS)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const activeInput = document.activeElement;
                    // Check if active element is one of our inputs
                    if (activeInput === chatInput || activeInput === aiInput) {
                        // Calculate the difference between window height and viewport height (keyboard height)
                        const keyboardHeight = window.innerHeight - window.visualViewport.height;
                        
                        if (keyboardHeight > 100) { // Keyboard is visible
                            // Get the input container
                            const inputContainer = activeInput.closest('.flex-shrink-0');
                            if (!inputContainer) return;
                            
                            // Position the input above the keyboard
                            inputContainer.style.marginBottom = `${keyboardHeight}px`;
                            
                            // Scroll input into view
                            activeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }
        });
    </script>
    
    <style>
        /* Mobile keyboard adjustments for AI chat inputs */
        @media (max-width: 768px) {
            /* When keyboard is visible, ensure input stays visible */
            .keyboard-visible {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                z-index: 100 !important;
                padding: 10px !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
                margin-bottom: env(safe-area-inset-bottom, 0) !important;
                transition: transform 0.3s ease !important;
            }
            
            /* Adjust AI panel layout when keyboard is active */
            #aiAssistPanel.keyboard-active {
                height: auto !important;
                bottom: 0 !important;
                top: 50px !important;
                overflow-y: auto !important;
            }
            
            /* Ensure chat history scrolls properly with keyboard visible */
            #aiAssistPanel.keyboard-active #chatHistory,
            #aiAssistPanel.keyboard-active #aiOutput {
                max-height: calc(100vh - 220px) !important;
            }
        }
    </style>
</body>
</html> 